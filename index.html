<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ú–∞–ø–∞ ‚Äî —Ü—ñ–ª—ñ</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{height:100%;margin:0}
#map{width:100%;height:100vh}
.leaflet-left .leaflet-control{margin-left:10px;margin-top:10px}
.leaflet-control-custom{
  background:white;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,0.3);
  width:32px;height:32px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:18px;transition:0.15s
}
.leaflet-control-custom:hover{background:#f0f0f0}
.leaflet-control-custom.active{background:#cce5ff}
.preview-icon{font-size:18px;opacity:0.8;transform-origin:center}
#iconMenu{
  position:absolute;top:10px;right:10px;z-index:1000;
  background:white;padding:10px;border-radius:8px;
  box-shadow:0 1px 5px rgba(0,0,0,0.3);
  display:none;flex-direction:column;gap:8px;
  font-family:sans-serif;font-size:14px;
}
#iconMenu img{width:28px;height:28px;cursor:pointer;transition:0.15s}
#iconMenu img:hover{transform:scale(1.1)}
#speedInput{
  width:100%;padding:4px;margin-top:6px;
  border:1px solid #ccc;border-radius:6px;font-size:14px
}
#toggleMenu{
  position:absolute;top:10px;right:10px;z-index:1001;
  background:white;color:black;border:1px solid #ccc;border-radius:6px;
  width:36px;height:36px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;
}
.traj-section { border-top:1px solid #eee; padding-top:6px; margin-top:4px; }
.traj-controls { display:flex; gap:6px; margin-top:6px; }
.traj-controls button { padding:6px 8px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer; }
.traj-controls button.active { background:#00c6ff; color:#fff; border-color:#00a0d6; }
.traj-row { display:flex; gap:6px; align-items:center; }
.traj-row input[type="number"]{ width:60px; padding:4px; border-radius:4px; border:1px solid #ccc; }
.traj-row label{ font-size:13px; }
</style>
</head>
<body>
<div id="map"></div>
<button id="toggleMenu">‚öô</button>

<div id="iconMenu">
  <b>–Ü–∫–æ–Ω–∫–∞</b>
  <div>
    <img src="icons/shahed.png" data-icon="icons/shahed.png">
    <img src="icons/rocket.png" data-icon="icons/rocket.png">
    <img src="icons/plane.png" data-icon="icons/plane.png">
    <img src="icons/kab.png" data-icon="icons/kab.png">
    <img src="icons/recon.png" data-icon="icons/recon.png">
    <img src="icons/ballistic.png" data-icon="icons/ballistic.png">
  </div>
  <b>–®–≤–∏–¥–∫—ñ—Å—Ç—å (–∫–º/–≥–æ–¥)</b>
  <input type="number" id="speedInput" min="0" max="100000" placeholder="–í–≤–µ–¥–∏ –≤—Ä—É—á–Ω—É">

  <div class="traj-section">
    <b>–¢—Ä–∞—î–∫—Ç–æ—Ä—ñ—è</b>
    <div class="traj-controls">
      <button id="trajSolidBtn" class="active">–°—É—Ü—ñ–ª—å–Ω–∞</button>
      <button id="trajDashBtn">–ü—É–Ω–∫—Ç–∏—Ä–Ω–∞</button>
    </div>
    <div class="traj-row">
      <label>–ö–æ–ª—ñ—Ä</label><input id="trajColor" type="color" value="#00a0ff">
    </div>
    <div class="traj-row">
      <label>–®–∏—Ä–∏–Ω–∞</label><input id="trajWidth" type="number" min="1" max="10" value="2">
      <label>–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å</label><input id="trajOpacity" type="number" min="0" max="1" step="0.1" value="0.9">
    </div>
  </div>
</div>

<script>
const map=L.map('map',{zoomControl:false,attributionControl:false}).setView([49,31],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'',keepBuffer:2}).addTo(map);

let mode=null,firstClickLatLng=null,previewMarker=null,selectedTarget=null;
let selectedIcon='icons/shahed.png',selectedSpeed=0;
const targets=[];
const trajSettings={dash:false,color:'#00a0ff',weight:2,opacity:0.9};
let showAllTrajectories=true;

function bearingDegrees(a,b){const t=d=>d*Math.PI/180,o=r=>r*180/Math.PI;let e=t(a.lat),n=t(b.lat),l=t(b.lng-a.lng);let s=Math.sin(l)*Math.cos(n),i=Math.cos(e)*Math.sin(n)-Math.sin(e)*Math.cos(n)*Math.cos(l);return(o(Math.atan2(s,i))+360)%360}
function clearPreview(){firstClickLatLng=null;if(previewMarker){map.removeLayer(previewMarker);previewMarker=null}}
function getPolylineOptions(){return{color:trajSettings.color,weight:trajSettings.weight,opacity:trajSettings.opacity,dashArray:trajSettings.dash?'6,6':null}}

const AddControl=L.Control.extend({options:{position:'topleft'},onAdd(){const e=L.DomUtil.create('div','leaflet-control leaflet-control-custom');e.innerHTML='‚ûï',e.title='–î–æ–¥–∞—Ç–∏ —Ü—ñ–ª—å',L.DomEvent.on(e,'click',t=>{L.DomEvent.stopPropagation(t),L.DomEvent.preventDefault(t),mode='add'===mode?null:'add',e.classList.toggle('active'),resetModes(e)});return e}});
const DeleteControl=L.Control.extend({options:{position:'topleft'},onAdd(){const e=L.DomUtil.create('div','leaflet-control leaflet-control-custom');e.innerHTML='üóëÔ∏è',e.title='–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—ñ–ª—å',L.DomEvent.on(e,'click',t=>{L.DomEvent.stopPropagation(t),L.DomEvent.preventDefault(t),mode='delete'===mode?null:'delete',e.classList.toggle('active'),resetModes(e)});return e}});
const CourseControl=L.Control.extend({options:{position:'topleft'},onAdd(){const e=L.DomUtil.create('div','leaflet-control leaflet-control-custom');e.innerHTML='üß≠',e.title='–ó–º—ñ–Ω–∏—Ç–∏ –∫—É—Ä—Å',L.DomEvent.on(e,'click',t=>{L.DomEvent.stopPropagation(t),L.DomEvent.preventDefault(t);const o=e.classList.toggle('active');mode=o?'course':null,resetModes(e)});return e}});
const SpeedControl=L.Control.extend({options:{position:'topleft'},onAdd(){const e=L.DomUtil.create('div','leaflet-control leaflet-control-custom');e.innerHTML='‚ö°',e.title='–ó–º—ñ–Ω–∏—Ç–∏ —à–≤–∏–¥–∫—ñ—Å—Ç—å',L.DomEvent.on(e,'click',t=>{L.DomEvent.stopPropagation(t),L.DomEvent.preventDefault(t);const o=e.classList.toggle('active');mode=o?'speed':null,resetModes(e)});return e}});
const TrajAllControl=L.Control.extend({options:{position:'topleft'},onAdd(){const e=L.DomUtil.create('div','leaflet-control leaflet-control-custom');e.innerHTML='üìà',e.title='–ü–æ–∫–∞–∑–∞—Ç–∏/–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤—Å—ñ —Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—ó',L.DomEvent.on(e,'click',t=>{L.DomEvent.stopPropagation(t),L.DomEvent.preventDefault(t);const o=e.classList.toggle('active');showAllTrajectories=o,targets.forEach(a=>{if(a._polyline){o?map.addLayer(a._polyline):map.removeLayer(a._polyline)}})});return e}});
const TrajSelControl=L.Control.extend({options:{position:'topleft'},onAdd(){const e=L.DomUtil.create('div','leaflet-control leaflet-control-custom');e.innerHTML='üéØ',e.title='–ü–æ–∫–∞–∑–∞—Ç–∏ —Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—é –≤–∏–±—Ä–∞–Ω–æ—ó —Ü—ñ–ª—ñ',L.DomEvent.on(e,'click',t=>{L.DomEvent.stopPropagation(t),L.DomEvent.preventDefault(t);const o=e.classList.toggle('active');mode=o?'trajsel':null,resetModes(e)});return e}});

map.addControl(new AddControl());
map.addControl(new DeleteControl());
map.addControl(new CourseControl());
map.addControl(new SpeedControl());
map.addControl(new TrajAllControl());
map.addControl(new TrajSelControl());

const controls=document.querySelectorAll('.leaflet-control-custom');
function resetModes(current){controls.forEach(c=>{if(c!==current)c.classList.remove('active')});if(selectedTarget&&selectedTarget.getElement())selectedTarget.getElement().style.filter='';selectedTarget=null;clearPreview()}

function createTarget(pos,bear){const i=L.divIcon({html:`<img src="${selectedIcon}" style="width:28px;height:28px;transform:rotate(${bear}deg);transform-origin:center center;">`,iconSize:[28,28],iconAnchor:[14,14]});
const m=L.marker(pos,{icon:i}).addTo(map);
m._course=bear;m._speedKmph=selectedSpeed;m._moving=m._speedKmph>0;m._currentPos=pos;m._iconPath=selectedIcon;
m._polyline=L.polyline([pos],getPolylineOptions());
if(showAllTrajectories)m._polyline.addTo(map);
m.on('click',()=>{if('delete'===mode){if(m._polyline){map.removeLayer(m._polyline)}const i=targets.indexOf(m);if(i!==-1)targets.splice(i,1);map.removeLayer(m)}else if('course'===mode){selectTarget(m);mode='course'}else if('speed'===mode){selectTarget(m);const s=prompt("–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤—É —à–≤–∏–¥–∫—ñ—Å—Ç—å (–∫–º/–≥–æ–¥):",m._speedKmph);if(s!==null){const v=parseFloat(s);if(!isNaN(v)){m._speedKmph=Math.max(0,Math.min(v,1e5));m._moving=m._speedKmph>0}}}else if('trajsel'===mode){selectTarget(m);if(m._polyline){if(map.hasLayer(m._polyline)){map.removeLayer(m._polyline)}else map.addLayer(m._polyline)}}});
targets.push(m)}
function selectTarget(m){if(selectedTarget&&selectedTarget.getElement())selectedTarget.getElement().style.filter='';selectedTarget=m;m.getElement().style.filter='drop-shadow(0 0 4px blue)'}

map.on('click',e=>{if('add'===mode){if(!firstClickLatLng){firstClickLatLng=e.latlng;previewMarker=L.marker(firstClickLatLng,{icon:L.divIcon({className:'preview-icon',html:'üìç',iconSize:[18,18],iconAnchor:[9,9]}),interactive:false}).addTo(map)}else{const t=bearingDegrees(firstClickLatLng,e.latlng);createTarget(firstClickLatLng,t);clearPreview()}}else if('course'===mode&&selectedTarget){const n=bearingDegrees(selectedTarget.getLatLng(),e.latlng);selectedTarget._course=n;selectedTarget.setIcon(L.divIcon({html:`<img src="${selectedTarget._iconPath}" style="width:28px;height:28px;transform:rotate(${n}deg);transform-origin:center center;">`,iconSize:[28,28],iconAnchor:[14,14]}))}});

document.querySelectorAll('#iconMenu img').forEach(i=>i.addEventListener('click',()=>selectedIcon=i.dataset.icon));
document.getElementById('speedInput').addEventListener('input',e=>selectedSpeed=Math.min(parseFloat(e.target.value)||0,1e5));
document.getElementById('toggleMenu').onclick=()=>{const m=document.getElementById('iconMenu');m.style.display='none'===m.style.display?'flex':'none'};

document.getElementById('trajSolidBtn').onclick=()=>{trajSettings.dash=false;document.getElementById('trajSolidBtn').classList.add('active');document.getElementById('trajDashBtn').classList.remove('active');updateTraj()};
document.getElementById('trajDashBtn').onclick=()=>{trajSettings.dash=true;document.getElementById('trajDashBtn').classList.add('active');document.getElementById('trajSolidBtn').classList.remove('active');updateTraj()};
document.getElementById('trajColor').oninput=()=>{trajSettings.color=trajColor.value;updateTraj()};
document.getElementById('trajWidth').oninput=()=>{trajSettings.weight=parseInt(trajWidth.value)||2;updateTraj()};
document.getElementById('trajOpacity').oninput=()=>{trajSettings.opacity=parseFloat(trajOpacity.value)||0.9;updateTraj()};
function updateTraj(){targets.forEach(t=>t._polyline&&t._polyline.setStyle(getPolylineOptions()))}

const MOVE_TICK_MS=500;
function metersToLat(m){return m/111320}function metersToLng(m,lat){return m/(111320*Math.cos(lat*Math.PI/180))}
setInterval(()=>{targets.forEach(m=>{if(!m._moving||m._speedKmph<=0)return;const s=m._speedKmph*1000/3600,d=s*(MOVE_TICK_MS/1000),Œ∏=m._course*Math.PI/180,dy=Math.cos(Œ∏)*d,dx=Math.sin(Œ∏)*d,p=m.getLatLng(),lat=p.lat+metersToLat(dy),lng=p.lng+metersToLng(dx,p.lat);m._currentPos=L.latLng(lat,lng);m.setLatLng(m._currentPos);m._polyline&&m._polyline.addLatLng(m._currentPos)})},MOVE_TICK_MS);
</script>
</body>
</html>
