<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ú–∞–ø–∞ ‚Äî —Ü—ñ–ª—ñ</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{height:100%;margin:0}
#map{width:100%;height:100vh}

/* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –≤–≤–µ—Ä—Ö—É */
.leaflet-top.leaflet-left {
  display: flex;
  flex-direction: row;
  gap: 5px;
  margin: 10px;
}

.leaflet-control-custom{
  background:white;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,0.3);
  width:32px;height:32px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:18px;transition:0.15s
}
.leaflet-control-custom:hover{background:#f0f0f0}
.leaflet-control-custom.active{background:#cce5ff}
.preview-icon{font-size:18px;opacity:0.8;transform-origin:center}
#iconMenu{
  position:absolute;top:10px;right:10px;z-index:1000;
  background:white;padding:10px;border-radius:8px;
  box-shadow:0 1px 5px rgba(0,0,0,0.3);
  display:none;flex-direction:column;gap:8px;
  font-family:sans-serif;font-size:14px;
  max-height:80vh;overflow-y:auto;
  width:350px;
}
#iconMenu img{width:28px;height:28px;cursor:pointer;transition:0.15s}
#iconMenu img:hover{transform:scale(1.1)}
#speedInput{
  width:100%;padding:4px;margin-top:6px;
  border:1px solid #ccc;border-radius:6px;font-size:14px
}
#toggleMenu{
  position:absolute;top:10px;right:10px;z-index:1001;
  background:white;color:black;border:1px solid #ccc;border-radius:6px;
  width:36px;height:36px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;
}

/* Trajectory controls in menu */
.traj-section { border-top:1px solid #eee; padding-top:6px; margin-top:4px; }
.traj-controls { display:flex; gap:6px; margin-top:6px; }
.traj-controls button { padding:6px 8px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer; }
.traj-controls button.active { background:#00c6ff; color:#fff; border-color:#00a0d6; }
.traj-row { display:flex; gap:6px; align-items:center; }
.traj-row input[type="number"]{ width:60px; padding:4px; border-radius:4px; border:1px solid #ccc; }
.traj-row label{ font-size:13px; }

/* –°—Ç–∏–ª–∏ –¥–ª—è popup —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è */
.distance-popup { text-align: center; }
.distance-popup h3 { margin: 0 0 10px 0; font-size: 16px; }
.distance-popup p { margin: 5px 0; font-size: 14px; }
.distance-popup button {
  margin-top: 10px;
  padding: 6px 12px;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
.distance-popup button:hover {
  background: #0056b3;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –º–µ–Ω—é –∏–∫–æ–Ω–æ–∫ —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π */
.icon-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  max-height: 300px;
  overflow-y: auto;
  padding: 5px;
}
.icon-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  padding: 5px;
  border-radius: 4px;
  transition: background 0.2s;
}
.icon-item:hover {
  background: #f0f0f0;
}
.icon-item img {
  width: 24px;
  height: 24px;
}
.icon-label {
  font-size: 10px;
  text-align: center;
  margin-top: 2px;
  line-height: 1.2;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏–π —Ü–µ–ª–µ–π */
.target-label {
  position: absolute;
  background: rgba(255, 255, 255, 0.9);
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 11px;
  font-weight: bold;
  white-space: nowrap;
  pointer-events: none;
  z-index: 1000;
  border: 1px solid #ccc;
  transform: translate(-50%, -35px);
}

/* –î–≤—É—Ö–∫–æ–ª–æ–Ω–æ—á–Ω—ã–π layout –¥–ª—è –º–µ–Ω—é */
.menu-columns {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-top: 10px;
}
.menu-column {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.menu-column h4 {
  margin: 0 0 5px 0;
  font-size: 14px;
  color: #333;
}
.name-input {
  width: 100%;
  padding: 6px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 13px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ü–≤–µ—Ç–æ–≤ –∏–∫–æ–Ω–æ–∫ */
.icon-color-controls {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-top: 8px;
}
</style>
</head>
<body>
<div id="map"></div>

<button id="toggleMenu">‚öô</button>

<div id="iconMenu">
  <b>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ü—ñ–ª–µ–π</b>
  
  <div class="menu-columns">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –∏–∫–æ–Ω–∫–∏ -->
    <div class="menu-column">
      <h4>üõ∏ –¢–∏–ø —Ü—ñ–ª—ñ</h4>
      <div class="icon-grid">
        <div class="icon-item" data-icon="icons/shahed.svg">
          <img src="icons/shahed.svg" title="–®–∞—Ö–µ–¥">
          <div class="icon-label">–®–∞—Ö–µ–¥</div>
        </div>
        <div class="icon-item" data-icon="icons/x-59.svg">
          <img src="icons/x-59.svg" title="–•-59">
          <div class="icon-label">–•-59</div>
        </div>
        <div class="icon-item" data-icon="icons/x-101.svg">
          <img src="icons/x-101.svg" title="–•-101">
          <div class="icon-label">–•-101</div>
        </div>
        <div class="icon-item" data-icon="icons/recon.svg">
          <img src="icons/recon.svg" title="–†–æ–∑–≤—ñ–¥–Ω–∏–∫">
          <div class="icon-label">–†–æ–∑–≤—ñ–¥–Ω–∏–∫</div>
        </div>
        <div class="icon-item" data-icon="icons/s-300-pp.svg">
          <img src="icons/s-300-pp.svg" title="–°-300–ü–ü">
          <div class="icon-label">–°-300–ü–ü</div>
        </div>
        <div class="icon-item" data-icon="icons/kab.svg">
          <img src="icons/kab.svg" title="–ö–ê–ë">
          <div class="icon-label">–ö–ê–ë</div>
        </div>
        <div class="icon-item" data-icon="icons/pu-iskander.svg">
          <img src="icons/pu-iskander.svg" title="–ü–£ –Ü—Å–∫–∞–Ω–¥–µ—Ä">
          <div class="icon-label">–ü–£ –Ü—Å–∫–∞–Ω–¥–µ—Ä</div>
        </div>
        <div class="icon-item" data-icon="icons/iskander-k.svg">
          <img src="icons/iskander-k.svg" title="–Ü—Å–∫–∞–Ω–¥–µ—Ä-–ö">
          <div class="icon-label">–Ü—Å–∫–∞–Ω–¥–µ—Ä-–ö</div>
        </div>
        <div class="icon-item" data-icon="icons/pu-mlrs.svg">
          <img src="icons/pu-mlrs.svg" title="–ü–£ –†–°–ó–í">
          <div class="icon-label">–ü–£ –†–°–ó–í</div>
        </div>
        <div class="icon-item" data-icon="icons/ballistic.svg">
          <img src="icons/ballistic.svg" title="–ë–∞–ª—ñ—Å—Ç–∏–∫–∞">
          <div class="icon-label">–ë–∞–ª—ñ—Å—Ç–∏–∫–∞</div>
        </div>
        <div class="icon-item" data-icon="icons/mig-31k.svg">
          <img src="icons/mig-31k.svg" title="–ú—ñ–ì-31–ö">
          <div class="icon-label">–ú—ñ–ì-31–ö</div>
        </div>
        <div class="icon-item" data-icon="icons/fpv.svg">
          <img src="icons/fpv.svg" title="FPV">
          <div class="icon-label">FPV</div>
        </div>
        <div class="icon-item" data-icon="icons/unknown.svg">
          <img src="icons/unknown.svg" title="–ù–µ–≤—ñ–¥–æ–º–∏–π">
          <div class="icon-label">–ù–µ–≤—ñ–¥–æ–º–∏–π</div>
        </div>
        <div class="icon-item" data-icon="icons/lightning.svg">
          <img src="icons/lightning.svg" title="–ú–æ–ª–Ω—ñ—è">
          <div class="icon-label">–ú–æ–ª–Ω—ñ—è</div>
        </div>
        <div class="icon-item" data-icon="icons/lancet.svg">
          <img src="icons/lancet.svg" title="–õ–∞–Ω—Ü–µ—Ç">
          <div class="icon-label">–õ–∞–Ω—Ü–µ—Ç</div>
        </div>
        <div class="icon-item" data-icon="icons/iskander-m.svg">
          <img src="icons/iskander-m.svg" title="–Ü—Å–∫–∞–Ω–¥–µ—Ä-–ú">
          <div class="icon-label">–Ü—Å–∫–∞–Ω–¥–µ—Ä-–ú</div>
        </div>
        <div class="icon-item" data-icon="icons/mlrs.svg">
          <img src="icons/mlrs.svg" title="–†–°–ó–í">
          <div class="icon-label">–†–°–ó–í</div>
        </div>
        <div class="icon-item" data-icon="icons/ta.svg">
          <img src="icons/ta.svg" title="–¢–ê">
          <div class="icon-label">–¢–ê</div>
        </div>
        <div class="icon-item" data-icon="icons/kinzhal.svg">
          <img src="icons/kinzhal.svg" title="–ö–∏–Ω–∂–∞–ª">
          <div class="icon-label">–ö–∏–Ω–∂–∞–ª</div>
        </div>
        <div class="icon-item" data-icon="icons/tu-22.svg">
          <img src="icons/tu-22.svg" title="–¢—É-22">
          <div class="icon-label">–¢—É-22</div>
        </div>
        <div class="icon-item" data-icon="icons/x-22.svg">
          <img src="icons/x-22.svg" title="–•-22">
          <div class="icon-label">–•-22</div>
        </div>
        <div class="icon-item" data-icon="icons/tu-95ms.svg">
          <img src="icons/tu-95ms.svg" title="–¢—É-95–ú–°">
          <div class="icon-label">–¢—É-95–ú–°</div>
        </div>
        <div class="icon-item" data-icon="icons/x-31.svg">
          <img src="icons/x-31.svg" title="–•-31">
          <div class="icon-label">–•-31</div>
        </div>
        <div class="icon-item" data-icon="icons/recon-strike-uav.svg">
          <img src="icons/recon-strike-uav.svg" title="–†–æ–∑–≤./—É–¥–∞—Ä–Ω. –ë–ø–õ–ê">
          <div class="icon-label">–†–æ–∑–≤./—É–¥–∞—Ä–Ω. –ë–ø–õ–ê</div>
        </div>
        <div class="icon-item" data-icon="icons/fast.svg">
          <img src="icons/fast.svg" title="–®–≤–∏–¥–∫—ñ—Å–Ω–∞">
          <div class="icon-label">–®–≤–∏–¥–∫—ñ—Å–Ω–∞</div>
        </div>
        <div class="icon-item" data-icon="icons/italmas.svg">
          <img src="icons/italmas.svg" title="–Ü—Ç–∞–ª–º–∞—Å">
          <div class="icon-label">–Ü—Ç–∞–ª–º–∞—Å</div>
        </div>
        <div class="icon-item" data-icon="icons/shahed-238.svg">
          <img src="icons/shahed-238.svg" title="–®–∞—Ö–µ–¥ 238">
          <div class="icon-label">–®–∞—Ö–µ–¥ 238</div>
        </div>
        <div class="icon-item" data-icon="icons/orlan-10.svg">
          <img src="icons/orlan-10.svg" title="–û—Ä–ª–∞–Ω-10">
          <div class="icon-label">–û—Ä–ª–∞–Ω-10</div>
        </div>
        <div class="icon-item" data-icon="icons/supercam.svg">
          <img src="icons/supercam.svg" title="–°—É–ø–µ—Ä–∫–∞–º">
          <div class="icon-label">–°—É–ø–µ—Ä–∫–∞–º</div>
        </div>
        <div class="icon-item" data-icon="icons/zala.svg">
          <img src="icons/zala.svg" title="–ó–∞–ª–∞">
          <div class="icon-label">–ó–∞–ª–∞</div>
        </div>
        <div class="icon-item" data-icon="icons/su-57.svg">
          <img src="icons/su-57.svg" title="–°—É-57">
          <div class="icon-label">–°—É-57</div>
        </div>
        <div class="icon-item" data-icon="icons/herbera.svg">
          <img src="icons/herbera.svg" title="–ì–µ—Ä–±–µ—Ä–∞">
          <div class="icon-label">–ì–µ—Ä–±–µ—Ä–∞</div>
        </div>
        <!-- –ù–æ–≤—ã–µ —Ü–µ–ª–∏ -->
        <div class="icon-item" data-icon="icons/aerodrom.svg">
          <img src="icons/aerodrom.svg" title="–ê–µ—Ä–æ–¥—Ä–æ–º">
          <div class="icon-label">–ê–µ—Ä–æ–¥—Ä–æ–º</div>
        </div>
        <div class="icon-item" data-icon="icons/pu-shahediv.svg">
          <img src="icons/pu-shahediv.svg" title="–ü–£ –®–∞—Ö–µ–¥—ñ–≤">
          <div class="icon-label">–ü–£ –®–∞—Ö–µ–¥—ñ–≤</div>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <div class="menu-column">
      <h4>üè∑Ô∏è –ù–∞–∑–≤–∞ —Ü—ñ–ª—ñ</h4>
      <input type="text" id="targetNameInput" class="name-input" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —Ü—ñ–ª—ñ" maxlength="20">
      
      <h4>‚ö° –®–≤–∏–¥–∫—ñ—Å—Ç—å (–∫–º/–≥–æ–¥)</h4>
      <input type="number" id="speedInput" min="0" max="100000" placeholder="–í–≤–µ–¥–∏ —à–≤–∏–¥–∫—ñ—Å—Ç—å" class="name-input">
      
      <h4>üé® –ö–æ–ª—ñ—Ä —ñ–∫–æ–Ω–∫–∏</h4>
      <div class="icon-color-controls">
        <div class="traj-row">
          <label>–û—Å–Ω–æ–≤–Ω–∏–π:</label>
          <input id="iconColor" type="color" value="#000000">
        </div>
        <div class="traj-row">
          <label>–§–æ–Ω:</label>
          <input id="iconBgColor" type="color" value="#ffffff">
        </div>
      </div>
    </div>
  </div>

  <div class="traj-section">
    <b>–¢—Ä–∞—î–∫—Ç–æ—Ä—ñ—è</b>
    <div class="traj-controls">
      <button id="trajSolidBtn" class="active">–°—É—Ü—ñ–ª—å–Ω–∞</button>
      <button id="trajDashBtn">–ü—É–Ω–∫—Ç–∏—Ä–Ω–∞</button>
    </div>
    <div class="traj-row">
      <label>–ö–æ–ª—ñ—Ä</label>
      <input id="trajColor" type="color" value="#00a0ff">
    </div>
    <div class="traj-row">
      <label>–®–∏—Ä–∏–Ω–∞</label>
      <input id="trajWidth" type="number" min="1" max="10" value="2">
      <label>–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å</label>
      <input id="trajOpacity" type="number" min="0" max="1" step="0.1" value="0.9" style="width:60px">
    </div>
  </div>
</div>

<script>
/* === –ù–∞—á–∞–ª–æ —Ç–≤–æ–µ–≥–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ === */
const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([49.0, 31.0], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '',
  detectRetina: true,
  updateWhenIdle: false,
  keepBuffer: 2,
  className: 'ukraine-map-tiles light-theme'
}).addTo(map);

/* === –û–¢–ö–õ–Æ–ß–ï–ù–ò–ï –î–í–û–ô–ù–û–ì–û –ö–õ–ò–ö–ê –ó–£–ú–ê === */
map.doubleClickZoom.disable();
map.on('dblclick', function(e) {
    e.originalEvent.preventDefault();
    e.originalEvent.stopPropagation();
});

let mode = null;
let firstClickLatLng = null;
let previewMarker = null;
let selectedIcon = 'icons/shahed.svg';
let selectedSpeed = 0;
let selectedTarget = null;
const targets = []; // markers

/* === –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏–π === */
let selectedTargetName = '';
let showAllLabels = true;

/* === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–≤–µ—Ç–æ–≤ –∏–∫–æ–Ω–æ–∫ === */
const iconSettings = {
    color: '#000000',
    bgColor: '#ffffff'
};

/* === Trajectory storage and global settings === */
let showAllTrajectories = true;
let showSelectedTrajectory = true;

const trajSettings = {
  dash: false,
  color: '#00a0ff',
  weight: 2,
  opacity: 0.9
};

/* === –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è HTML –∏–∫–æ–Ω–∫–∏ —Å —É—á–µ—Ç–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è === */
function createIconHtml(iconPath, bearingDeg) {
    // SVG –∏–∫–æ–Ω–∫–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –≤–ª–µ–≤–æ, –ø–æ—ç—Ç–æ–º—É –¥–æ–±–∞–≤–ª—è–µ–º +90 –≥—Ä–∞–¥—É—Å–æ–≤ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    const correctedBearing = bearingDeg + 90;
    
    return `
        <div style="
            width: 20px; 
            height: 20px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            background: ${iconSettings.bgColor};
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.2);
        ">
            <img src="${iconPath}" 
                 style="
                    width: 16px; 
                    height: 16px; 
                    transform: rotate(${correctedBearing}deg);
                    transform-origin: center center;
                    filter: ${iconSettings.color !== '#000000' ? `brightness(0) saturate(100%) invert(${hexToFilter(iconSettings.color)})` : 'none'};
                 "
                 onerror="this.src='icons/unknown.svg'">
        </div>
    `;
}

/* === –§—É–Ω–∫—Ü–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ HEX –≤ CSS —Ñ–∏–ª—å—Ç—Ä === */
function hexToFilter(hexColor) {
    if (hexColor === '#000000') return '0%';
    
    // –ü—Ä–æ—Å—Ç–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤
    const colors = {
        '#ff0000': '13%', // red
        '#00ff00': '61%', // green  
        '#0000ff': '88%', // blue
        '#ffff00': '50%', // yellow
        '#ff00ff': '50%', // magenta
        '#00ffff': '75%', // cyan
    };
    
    return colors[hexColor.toLowerCase()] || '0%';
}

/* === –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –†–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –∏ –≤—Ä–µ–º–µ–Ω–∏ === */
let calculateDistanceMode = false;
let distanceMarker = null;

function startCalculateDistance() {
    if (calculateDistanceMode) {
        calculateDistanceMode = false;
        calculateDistanceBtn.classList.remove('active');
        
        if (selectedTarget && selectedTarget.getElement()) {
            selectedTarget.getElement().style.filter = '';
        }
        selectedTarget = null;
        
        if (distanceMarker) {
            map.removeLayer(distanceMarker);
            distanceMarker = null;
        }
        
    } else {
        calculateDistanceMode = true;
        calculateDistanceBtn.classList.add('active');
        
        mode = null;
        quickTrajectoryMode = false;
        quickTrajectoryBtn.classList.remove('active');
        showSelectedTrajectoryMode = false;
        trajSelEl.classList.remove('active');
        document.querySelectorAll('.leaflet-control-custom').forEach(el => {
            if(el !== calculateDistanceBtn) el.classList.remove('active');
        });
        
        clearPreview();
    }
}

function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371000;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function formatTime(seconds) {
    if (seconds < 60) {
        return `${Math.round(seconds)} —Å–µ–∫`;
    } else if (seconds < 3600) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.round(seconds % 60);
        return `${minutes} —Ö–≤ ${secs} —Å–µ–∫`;
    } else {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        return `${hours} –≥–æ–¥ ${minutes} —Ö–≤`;
    }
}

function createDistancePopup(targetPos, clickPos, target) {
    const distance = calculateDistance(
        targetPos.lat, targetPos.lng,
        clickPos.lat, clickPos.lng
    );
    
    const distanceKm = (distance / 1000).toFixed(2);
    const distanceMiles = (distance / 1609.34).toFixed(2);
    
    let timeSeconds = 0;
    if (target._speedKmph > 0) {
        timeSeconds = (distance / 1000) / (target._speedKmph / 3600);
    }
    
    const popupContent = `
        <div class="distance-popup">
            <h3>üìê –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫</h3>
            <p><strong>–í—ñ–¥—Å—Ç–∞–Ω—å:</strong> ${distanceKm} –∫–º (${distanceMiles} –º–∏–ª—å)</p>
            <p><strong>–ß–∞—Å –ø—ñ–¥–ª—å–æ—Ç—É:</strong> ${target._speedKmph > 0 ? formatTime(timeSeconds) : '–¶—ñ–ª—å –∑—É–ø–∏–Ω–µ–Ω–∞'}</p>
            <p><strong>–®–≤–∏–¥–∫—ñ—Å—Ç—å —Ü—ñ–ª—ñ:</strong> ${target._speedKmph} –∫–º/–≥–æ–¥</p>
            <button onclick="this.parentElement.parentElement.closePopup()">–ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
    `;
    
    return popupContent;
}

/* === –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ë—ã—Å—Ç—Ä–∞—è —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è === */
let quickTrajectoryMode = false;
let quickTrajectoryPoints = [];
let quickTrajectoryPolyline = null;
let previousTargetSpeed = null;

function startQuickTrajectory() {
    if (quickTrajectoryMode) {
        if (selectedTarget && quickTrajectoryPoints.length > 1) {
            applyQuickTrajectory();
        }
        
        quickTrajectoryMode = false;
        quickTrajectoryBtn.classList.remove('active');
        
        if (quickTrajectoryPolyline) {
            map.removeLayer(quickTrajectoryPolyline);
            quickTrajectoryPolyline = null;
        }
        quickTrajectoryPoints = [];
        
        if (selectedTarget && previousTargetSpeed !== null) {
            selectedTarget._speedKmph = previousTargetSpeed;
            selectedTarget._moving = selectedTarget._speedKmph > 0;
            previousTargetSpeed = null;
        }
        
        if (selectedTarget && selectedTarget.getElement()) {
            selectedTarget.getElement().style.filter = '';
        }
        selectedTarget = null;
        
    } else {
        quickTrajectoryMode = true;
        quickTrajectoryBtn.classList.add('active');
        
        mode = null;
        calculateDistanceMode = false;
        calculateDistanceBtn.classList.remove('active');
        showSelectedTrajectoryMode = false;
        trajSelEl.classList.remove('active');
        document.querySelectorAll('.leaflet-control-custom').forEach(el => {
            if(el !== quickTrajectoryBtn && el !== trajSelEl) el.classList.remove('active');
        });
        
        if (selectedTarget) {
            previousTargetSpeed = selectedTarget._speedKmph;
            selectedTarget._speedKmph = 0;
            selectedTarget._moving = false;
            selectedTarget.getElement().style.filter = 'drop-shadow(0 0 6px red)';
            
            quickTrajectoryPoints = [selectedTarget.getLatLng()];
        } else {
            quickTrajectoryPoints = [];
        }
        
        quickTrajectoryPolyline = L.polyline(quickTrajectoryPoints, {
            color: '#ff0000',
            weight: 3,
            opacity: 0.7,
            dashArray: '5,5'
        }).addTo(map);
    }
}

function applyQuickTrajectory() {
    if (!selectedTarget || quickTrajectoryPoints.length < 2) return;
    
    const lastPoint = quickTrajectoryPoints[quickTrajectoryPoints.length - 1];
    const secondLastPoint = quickTrajectoryPoints[quickTrajectoryPoints.length - 2];
    
    const bearing = bearingDegrees(secondLastPoint, lastPoint);
    
    selectedTarget.setLatLng(lastPoint);
    selectedTarget._currentPos = lastPoint;
    
    selectedTarget._course = bearing;
    selectedTarget.setIcon(L.divIcon({
        className: 'target-icon',
        html: createIconHtml(selectedTarget._iconPath, bearing),
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    }));
    
    selectedTarget._speedKmph = 0;
    selectedTarget._moving = false;
    
    if (selectedTarget._polyline) {
        const currentPoints = selectedTarget._polyline.getLatLngs();
        const newPoints = currentPoints.concat(quickTrajectoryPoints.slice(1));
        selectedTarget._polyline.setLatLngs(newPoints);
    } else {
        selectedTarget._polyline = L.polyline(quickTrajectoryPoints, getPolylineOptions());
        if (showAllTrajectories) selectedTarget._polyline.addTo(map);
    }
    
    previousTargetSpeed = null;
    saveTargetsToStorage();
}

/* === –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ü–µ–ª–∏ === */
let showSelectedTrajectoryMode = false;

function toggleSelectedTrajectory() {
    if (showSelectedTrajectoryMode) {
        showSelectedTrajectoryMode = false;
        trajSelEl.classList.remove('active');
        
        if (selectedTarget && selectedTarget.getElement()) {
            selectedTarget.getElement().style.filter = '';
        }
        selectedTarget = null;
        
        targets.forEach(t => {
            if (t._polyline && !map.hasLayer(t._polyline)) {
                map.addLayer(t._polyline);
            }
        });
        
    } else {
        showSelectedTrajectoryMode = true;
        trajSelEl.classList.add('active');
        
        mode = null;
        quickTrajectoryMode = false;
        quickTrajectoryBtn.classList.remove('active');
        calculateDistanceMode = false;
        calculateDistanceBtn.classList.remove('active');
        document.querySelectorAll('.leaflet-control-custom').forEach(el => {
            if(el !== trajSelEl) el.classList.remove('active');
        });
        
        targets.forEach(t => {
            if (t._polyline && map.hasLayer(t._polyline)) {
                map.removeLayer(t._polyline);
            }
        });
    }
}

/* === LOCAL STORAGE FUNCTIONS === */
function saveTargetsToStorage() {
    const data = targets.map(target => {
        return {
            lat: target._currentPos.lat,
            lng: target._currentPos.lng,
            course: target._course,
            speed: target._speedKmph,
            icon: target._iconPath,
            name: target._name,
            trajectory: target._polyline ? target._polyline.getLatLngs() : []
        };
    });
    localStorage.setItem('mapTargets', JSON.stringify(data));
}

function loadTargetsFromStorage() {
    const saved = localStorage.getItem('mapTargets');
    if (saved) {
        try {
            const data = JSON.parse(saved);
            data.forEach(targetData => {
                const latLng = L.latLng(targetData.lat, targetData.lng);
                restoreTarget(latLng, targetData.course, targetData.speed, targetData.icon, targetData.trajectory, targetData.name || '–¶—ñ–ª—å');
            });
        } catch (e) {
            console.error('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è —Ü—ñ–ª–µ–π:', e);
        }
    }
}

function restoreTarget(positionLatLng, bearingDeg, speed, iconPath, trajectory, name = '–¶—ñ–ª—å') {
    const icon = L.divIcon({
        className: 'target-icon',
        html: createIconHtml(iconPath, bearingDeg),
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    });
    
    const marker = L.marker(positionLatLng, { icon }).addTo(map);
    marker._course = bearingDeg;
    marker._speedKmph = speed || 0;
    marker._moving = marker._speedKmph > 0;
    marker._currentPos = positionLatLng;
    marker._iconPath = iconPath;
    marker._name = name;

    const label = L.divIcon({
        className: 'target-label',
        html: `<div>${marker._name}</div>`,
        iconSize: [100, 20],
        iconAnchor: [50, 0]
    });
    
    const labelMarker = L.marker(positionLatLng, { 
        icon: label,
        interactive: false 
    }).addTo(map);
    
    marker._label = labelMarker;

    const polyline = L.polyline(trajectory.length > 0 ? trajectory : [positionLatLng], getPolylineOptions());
    marker._polyline = polyline;
    
    if (showAllTrajectories && !showSelectedTrajectoryMode) polyline.addTo(map);

    marker.on('click', () => {
        if (calculateDistanceMode) {
            if (selectedTarget && selectedTarget.getElement()) {
                selectedTarget.getElement().style.filter = '';
            }
            selectedTarget = marker;
            marker.getElement().style.filter = 'drop-shadow(0 0 6px orange)';
            return;
        }
        
        if (quickTrajectoryMode) {
            if (selectedTarget && selectedTarget.getElement()) {
                selectedTarget.getElement().style.filter = '';
                if (previousTargetSpeed !== null) {
                    selectedTarget._speedKmph = previousTargetSpeed;
                    selectedTarget._moving = selectedTarget._speedKmph > 0;
                }
            }
            selectedTarget = marker;
            marker.getElement().style.filter = 'drop-shadow(0 0 6px red)';
            
            previousTargetSpeed = selectedTarget._speedKmph;
            selectedTarget._speedKmph = 0;
            selectedTarget._moving = false;
            
            quickTrajectoryPoints = [selectedTarget.getLatLng()];
            if (quickTrajectoryPolyline) {
                quickTrajectoryPolyline.setLatLngs(quickTrajectoryPoints);
            }
            return;
        }
        
        if (showSelectedTrajectoryMode) {
            if (selectedTarget && selectedTarget.getElement()) {
                selectedTarget.getElement().style.filter = '';
                if (selectedTarget._polyline && map.hasLayer(selectedTarget._polyline)) {
                    map.removeLayer(selectedTarget._polyline);
                }
            }
            selectedTarget = marker;
            marker.getElement().style.filter = 'drop-shadow(0 0 6px green)';
            
            if (selectedTarget._polyline && !map.hasLayer(selectedTarget._polyline)) {
                map.addLayer(selectedTarget._polyline);
            }
            return;
        }
        
        if (mode === 'delete') {
            if (marker._polyline) {
                if (map.hasLayer(marker._polyline)) map.removeLayer(marker._polyline);
                marker._polyline = null;
            }
            if (marker._label) {
                map.removeLayer(marker._label);
            }
            const idx = targets.indexOf(marker);
            if (idx !== -1) targets.splice(idx, 1);
            map.removeLayer(marker);
            saveTargetsToStorage();
        } else if (mode === 'course') {
            if (selectedTarget && selectedTarget.getElement()) selectedTarget.getElement().style.filter = '';
            selectedTarget = marker;
            marker.getElement().style.filter = 'drop-shadow(0 0 4px blue)';
        } else if (mode === 'speed') {
            if (selectedTarget && selectedTarget.getElement()) selectedTarget.getElement().style.filter = '';
            selectedTarget = marker;
            marker.getElement().style.filter = 'drop-shadow(0 0 4px blue)';
            const newSpeed = prompt("–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤—É —à–≤–∏–¥–∫—ñ—Å—Ç—å (–∫–º/–≥–æ–¥):", marker._speedKmph);
            if (newSpeed !== null) {
                const sp = parseFloat(newSpeed);
                if (!isNaN(sp)) {
                    marker._speedKmph = Math.max(0, Math.min(sp, 100000));
                    marker._moving = marker._speedKmph > 0;
                    saveTargetsToStorage();
                }
            }
        }
    });

    targets.push(marker);
}

function getPolylineOptions() {
    return {
        color: trajSettings.color,
        weight: trajSettings.weight,
        opacity: trajSettings.opacity,
        dashArray: trajSettings.dash ? '6,6' : null
    };
}

function bearingDegrees(fromLatLng,toLatLng){
    const toRad = d=>d*Math.PI/180;
    const toDeg = r=>r*180/Math.PI;
    const œÜ1=toRad(fromLatLng.lat);
    const œÜ2=toRad(toLatLng.lat);
    const ŒîŒª=toRad(toLatLng.lng - fromLatLng.lng);
    const y=Math.sin(ŒîŒª)*Math.cos(œÜ2);
    const x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);
    return (toDeg(Math.atan2(y,x))+360)%360;
}

function clearPreview(){firstClickLatLng=null;if(previewMarker){map.removeLayer(previewMarker);previewMarker=null;}}

/* === Controls === */
const AddControl=L.Control.extend({options:{position:'topleft'},onAdd(){ 
    const el=L.DomUtil.create('div','leaflet-control leaflet-control-custom'); 
    el.innerHTML='‚ûï';el.title='–î–æ–¥–∞—Ç–∏ —Ü—ñ–ª—å';
    L.DomEvent.on(el,'click',ev=>{
        L.DomEvent.stopPropagation(ev);L.DomEvent.preventDefault(ev);
        mode=(mode==='add')?null:'add';el.classList.toggle('active');
        document.querySelectorAll('.leaflet-control-custom').forEach(ctrl => {
            if(ctrl !== el) ctrl.classList.remove('active');
        });
        quickTrajectoryMode = false;
        quickTrajectoryBtn.classList.remove('active');
        calculateDistanceMode = false;
        calculateDistanceBtn.classList.remove('active');
        showSelectedTrajectoryMode = false;
        trajSelEl.classList.remove('active');
        if (selectedTarget && selectedTarget.getElement()) selectedTarget.getElement().style.filter = '';
        selectedTarget = null;
        clearPreview();
    });return el;
}});

const QuickTrajectoryControl=L.Control.extend({options:{position:'topleft'},onAdd(){ 
    const el=L.DomUtil.create('div','leaflet-control leaflet-control-custom'); 
    el.innerHTML='üéØ';el.title='–®–≤–∏–¥–∫–∞ —Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—è (–≤–∏–¥—ñ–ª—ñ—Ç—å —Ü—ñ–ª—å, –∫–ª–∞—Ü–∞–π—Ç–µ –ø–æ –∫–∞—Ä—Ç—ñ, –ø–æ—Ç—ñ–º –∑–Ω–æ–≤—É –∫–Ω–æ–ø–∫—É)';
    L.DomEvent.on(el,'click',function(ev) {
        L.DomEvent.stopPropagation(ev);L.DomEvent.preventDefault(ev);
        startQuickTrajectory();
    });
    return el;
}});

const CalculateDistanceControl=L.Control.extend({options:{position:'topleft'},onAdd(){ 
    const el=L.DomUtil.create('div','leaflet-control leaflet-control-custom'); 
    el.innerHTML='üìè';el.title='–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –≤—ñ–¥—Å—Ç–∞–Ω—å —Ç–∞ —á–∞—Å –ø—ñ–¥–ª—å–æ—Ç—É (–≤–∏–¥—ñ–ª—ñ—Ç—å —Ü—ñ–ª—å, –∫–ª–∞—Ü–Ω—ñ—Ç—å –ø–æ –∫–∞—Ä—Ç—ñ)';
    L.DomEvent.on(el,'click',function(ev) {
        L.DomEvent.stopPropagation(ev);L.DomEvent.preventDefault(ev);
        startCalculateDistance();
    });
    return el;
}});

const CourseControl=L.Control.extend({options:{position:'topleft'},onAdd(){
    const el=L.DomUtil.create('div','leaflet-control leaflet-control-custom');
    el.innerHTML='üß≠';el.title='–ó–º—ñ–Ω–∏—Ç–∏ –∫—É—Ä—Å';
    L.DomEvent.on(el,'click',ev=>{
        L.DomEvent.stopPropagation(ev);L.DomEvent.preventDefault(ev);
        const isActive = el.classList.toggle('active');
        mode = isActive ? 'course' : null;
        document.querySelectorAll('.leaflet-control-custom').forEach(ctrl => {
            if(ctrl !== el) ctrl.classList.remove('active');
        });
        quickTrajectoryMode = false;
        quickTrajectoryBtn.classList.remove('active');
        calculateDistanceMode = false;
        calculateDistanceBtn.classList.remove('active');
        showSelectedTrajectoryMode = false;
        trajSelEl.classList.remove('active');
        if(!isActive && selectedTarget && selectedTarget.getElement()) {
            selectedTarget.getElement().style.filter='';
            selectedTarget=null;
        }
        clearPreview();
    });return el;
}});

const SpeedControl=L.Control.extend({options:{position:'topleft'},onAdd(){
    const el=L.DomUtil.create('div','leaflet-control leaflet-control-custom');
    el.innerHTML='‚ö°';el.title='–ó–º—ñ–Ω–∏—Ç–∏ —à–≤–∏–¥–∫—ñ—Å—Ç—å';
    L.DomEvent.on(el,'click',ev=>{
        L.DomEvent.stopPropagation(ev);L.DomEvent.preventDefault(ev);
        const isActive = el.classList.toggle('active');
        mode = isActive ? 'speed' : null;
        document.querySelectorAll('.leaflet-control-custom').forEach(ctrl => {
            if(ctrl !== el) ctrl.classList.remove('active');
        });
        quickTrajectoryMode = false;
        quickTrajectoryBtn.classList.remove('active');
        calculateDistanceMode = false;
        calculateDistanceBtn.classList.remove('active');
        showSelectedTrajectoryMode = false;
        trajSelEl.classList.remove('active');
        if(!isActive && selectedTarget && selectedTarget.getElement()){
            selectedTarget.getElement().style.filter='';
            selectedTarget=null;
        }
        clearPreview();
    });return el;
}});

const DeleteControl=L.Control.extend({options:{position:'topleft'},onAdd(){
    const el=L.DomUtil.create('div','leaflet-control leaflet-control-custom');
    el.innerHTML='üóëÔ∏è';el.title='–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—ñ–ª—å';
    L.DomEvent.on(el,'click',ev=>{
        L.DomEvent.stopPropagation(ev);L.DomEvent.preventDefault(ev);
        mode=(mode==='delete')?null:'delete';el.classList.toggle('active');
        document.querySelectorAll('.leaflet-control-custom').forEach(ctrl => {
            if(ctrl !== el) ctrl.classList.remove('active');
        });
        quickTrajectoryMode = false;
        quickTrajectoryBtn.classList.remove('active');
        calculateDistanceMode = false;
        calculateDistanceBtn.classList.remove('active');
        showSelectedTrajectoryMode = false;
        trajSelEl.classList.remove('active');
        clearPreview();
    });return el;
}});

const TrajAllControl=L.Control.extend({options:{position:'topleft'},onAdd(){
    const el=L.DomUtil.create('div','leaflet-control leaflet-control-custom');
    el.innerHTML='üìà';el.title='–ü–æ–∫–∞–∑–∞—Ç–∏/–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤—Å—ñ —Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—ó';
    L.DomEvent.on(el,'click',ev=>{
        L.DomEvent.stopPropagation(ev);L.DomEvent.preventDefault(ev);
        const isActive = el.classList.toggle('active');
        showAllTrajectories = isActive;
        if (!showSelectedTrajectoryMode) {
            targets.forEach(t => {
                if(t._polyline){
                    if(showAllTrajectories) {
                        if(!map.hasLayer(t._polyline)) map.addLayer(t._polyline);
                    } else {
                        if(map.hasLayer(t._polyline)) map.removeLayer(t._polyline);
                    }
                }
            });
        }
    });return el;
}});

const TrajSelControl=L.Control.extend({options:{position:'topleft'},onAdd(){
    const el=L.DomUtil.create('div','leaflet-control leaflet-control-custom');
    el.innerHTML='üîç';el.title='–ü–æ–∫–∞–∑–∞—Ç–∏ —Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—é –≤–∏–±—Ä–∞–Ω–æ—ó —Ü—ñ–ª—ñ';
    L.DomEvent.on(el,'click',function(ev) {
        L.DomEvent.stopPropagation(ev);L.DomEvent.preventDefault(ev);
        toggleSelectedTrajectory();
    });
    return el;
}});

/* === –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π === */
const LabelsControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function() {
        const el = L.DomUtil.create('div', 'leaflet-control leaflet-control-custom');
        el.innerHTML = 'üè∑Ô∏è';
        el.title = '–ü–æ–∫–∞–∑–∞—Ç–∏/–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –Ω–∞–∑–≤–∏ —Ü—ñ–ª–µ–π';
        L.DomEvent.on(el, 'click', function(ev) {
            L.DomEvent.stopPropagation(ev);
            L.DomEvent.preventDefault(ev);
            toggleLabelsVisibility();
        });
        return el;
    }
});

// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏–π
function toggleLabelsVisibility() {
    showAllLabels = !showAllLabels;
    const labelsBtn = document.querySelector('.leaflet-control-custom:nth-of-type(9)');
    
    if (showAllLabels) {
        labelsBtn.classList.remove('active');
        labelsBtn.style.background = 'white';
    } else {
        labelsBtn.classList.add('active');
        labelsBtn.style.background = '#cce5ff';
    }
    
    targets.forEach(target => {
        if (target._label) {
            if (showAllLabels) {
                target._label.getElement().style.display = 'block';
            } else {
                target._label.getElement().style.display = 'none';
            }
        }
    });
}

// –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∫–æ–Ω—Ç—Ä–æ–ª—ã
map.addControl(new AddControl());
map.addControl(new QuickTrajectoryControl());
map.addControl(new CalculateDistanceControl());
map.addControl(new CourseControl());
map.addControl(new SpeedControl());
map.addControl(new DeleteControl());
map.addControl(new TrajAllControl());
map.addControl(new TrajSelControl());
map.addControl(new LabelsControl());

const addControlEl=document.querySelector('.leaflet-control-custom:nth-of-type(1)');
const quickTrajectoryBtn=document.querySelector('.leaflet-control-custom:nth-of-type(2)');
const calculateDistanceBtn=document.querySelector('.leaflet-control-custom:nth-of-type(3)');
const courseControlEl=document.querySelector('.leaflet-control-custom:nth-of-type(4)');
const speedControlEl=document.querySelector('.leaflet-control-custom:nth-of-type(5)');
const deleteControlEl=document.querySelector('.leaflet-control-custom:nth-of-type(6)');
const trajAllEl=document.querySelector('.leaflet-control-custom:nth-of-type(7)');
const trajSelEl=document.querySelector('.leaflet-control-custom:nth-of-type(8)');
const labelsBtn=document.querySelector('.leaflet-control-custom:nth-of-type(9)');

function createTarget(positionLatLng, bearingDeg) {
    const icon = L.divIcon({
        className: 'target-icon',
        html: createIconHtml(selectedIcon, bearingDeg),
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    });
    
    const marker = L.marker(positionLatLng, { icon }).addTo(map);
    marker._course = bearingDeg;
    marker._speedKmph = selectedSpeed || 0;
    marker._moving = marker._speedKmph > 0;
    marker._currentPos = positionLatLng;
    marker._iconPath = selectedIcon;
    marker._name = selectedTargetName || '–¶—ñ–ª—å';

    const label = L.divIcon({
        className: 'target-label',
        html: `<div>${marker._name}</div>`,
        iconSize: [100, 20],
        iconAnchor: [50, 0]
    });
    
    const labelMarker = L.marker(positionLatLng, { 
        icon: label,
        interactive: false 
    }).addTo(map);
    
    marker._label = labelMarker;

    if (!showAllLabels) {
        labelMarker.getElement().style.display = 'none';
    }

    const polyline = L.polyline([positionLatLng], getPolylineOptions());
    marker._polyline = polyline;
    if (showAllTrajectories && !showSelectedTrajectoryMode) polyline.addTo(map);

    marker.on('click', () => {
        if (calculateDistanceMode) {
            if (selectedTarget && selectedTarget.getElement()) {
                selectedTarget.getElement().style.filter = '';
            }
            selectedTarget = marker;
            marker.getElement().style.filter = 'drop-shadow(0 0 6px orange)';
            return;
        }
        
        if (quickTrajectoryMode) {
            if (selectedTarget && selectedTarget.getElement()) {
                selectedTarget.getElement().style.filter = '';
                if (previousTargetSpeed !== null) {
                    selectedTarget._speedKmph = previousTargetSpeed;
                    selectedTarget._moving = selectedTarget._speedKmph > 0;
                }
            }
            selectedTarget = marker;
            marker.getElement().style.filter = 'drop-shadow(0 0 6px red)';
            
            previousTargetSpeed = selectedTarget._speedKmph;
            selectedTarget._speedKmph = 0;
            selectedTarget._moving = false;
            
            quickTrajectoryPoints = [selectedTarget.getLatLng()];
            if (quickTrajectoryPolyline) {
                quickTrajectoryPolyline.setLatLngs(quickTrajectoryPoints);
            }
            return;
        }
        
        if (showSelectedTrajectoryMode) {
            if (selectedTarget && selectedTarget.getElement()) {
                selectedTarget.getElement().style.filter = '';
                if (selectedTarget._polyline && map.hasLayer(selectedTarget._polyline)) {
                    map.removeLayer(selectedTarget._polyline);
                }
            }
            selectedTarget = marker;
            marker.getElement().style.filter = 'drop-shadow(0 0 6px green)';
            
            if (selectedTarget._polyline && !map.hasLayer(selectedTarget._polyline)) {
                map.addLayer(selectedTarget._polyline);
            }
            return;
        }
        
        if (mode === 'delete') {
            if (marker._polyline) {
                if (map.hasLayer(marker._polyline)) map.removeLayer(marker._polyline);
                marker._polyline = null;
            }
            if (marker._label) {
                map.removeLayer(marker._label);
            }
            const idx = targets.indexOf(marker);
            if (idx !== -1) targets.splice(idx, 1);
            map.removeLayer(marker);
            saveTargetsToStorage();
        } else if (mode === 'course') {
            if (selectedTarget && selectedTarget.getElement()) selectedTarget.getElement().style.filter = '';
            selectedTarget = marker;
            marker.getElement().style.filter = 'drop-shadow(0 0 4px blue)';
        } else if (mode === 'speed') {
            if (selectedTarget && selectedTarget.getElement()) selectedTarget.getElement().style.filter = '';
            selectedTarget = marker;
            marker.getElement().style.filter = 'drop-shadow(0 0 4px blue)';
            const newSpeed = prompt("–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤—É —à–≤–∏–¥–∫—ñ—Å—Ç—å (–∫–º/–≥–æ–¥):", marker._speedKmph);
            if (newSpeed !== null) {
                const sp = parseFloat(newSpeed);
                if (!isNaN(sp)) {
                    marker._speedKmph = Math.max(0, Math.min(sp, 100000));
                    marker._moving = marker._speedKmph > 0;
                    saveTargetsToStorage();
                }
            }
        }
    });

    targets.push(marker);
    saveTargetsToStorage();
    
    selectedTargetName = '';
    document.getElementById('targetNameInput').value = '';
}

/* === –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–∞—Ä—Ç–µ === */
map.on('click', function(e) {
    if (calculateDistanceMode && selectedTarget) {
        const popupContent = createDistancePopup(
            selectedTarget.getLatLng(),
            e.latlng,
            selectedTarget
        );
        
        if (distanceMarker) {
            map.removeLayer(distanceMarker);
        }
        
        distanceMarker = L.marker(e.latlng)
            .addTo(map)
            .bindPopup(popupContent)
            .openPopup();
        
        return;
    }
    
    if (quickTrajectoryMode && selectedTarget) {
        quickTrajectoryPoints.push(e.latlng);
        if (quickTrajectoryPolyline) {
            quickTrajectoryPolyline.setLatLngs(quickTrajectoryPoints);
        }
        return;
    }
    
    if(mode==='add'){
        if(!firstClickLatLng){
            firstClickLatLng=e.latlng;
            previewMarker=L.marker(firstClickLatLng,{icon:L.divIcon({className:'preview-icon',html:'üìç',iconSize:[16,16],iconAnchor:[8,8]}),interactive:false}).addTo(map);
        } else{
            const bearing=bearingDegrees(firstClickLatLng,e.latlng);
            createTarget(firstClickLatLng,bearing);
            clearPreview();
        }
    } else if(mode==='course' && selectedTarget){
        const newBearing=bearingDegrees(selectedTarget.getLatLng(),e.latlng);
        selectedTarget._course=newBearing;
        selectedTarget.setIcon(L.divIcon({
            className:'target-icon',
            html: createIconHtml(selectedTarget._iconPath, newBearing),
            iconSize:[20,20],
            iconAnchor:[10,10]
        }));
        saveTargetsToStorage();
    }
});

/* === Menu bindings === */
document.querySelectorAll('.icon-item').forEach(item => {
    item.addEventListener('click', () => {
        selectedIcon = item.dataset.icon;
        document.querySelectorAll('.icon-item').forEach(i => i.style.background = '');
        item.style.background = '#e3f2fd';
    });
});

document.getElementById('speedInput').addEventListener('input',e=>{selectedSpeed=Math.min(parseFloat(e.target.value)||0,100000);});
document.getElementById('targetNameInput').addEventListener('input', function(e) {
    selectedTargetName = e.target.value.trim();
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ü–≤–µ—Ç–æ–≤ –∏–∫–æ–Ω–æ–∫
document.getElementById('iconColor').addEventListener('input', function(e) {
    iconSettings.color = e.target.value;
});

document.getElementById('iconBgColor').addEventListener('input', function(e) {
    iconSettings.bgColor = e.target.value;
});

const toggleMenu=document.getElementById('toggleMenu');
const iconMenu=document.getElementById('iconMenu');
toggleMenu.onclick=()=>{iconMenu.style.display=(iconMenu.style.display==='none'?'flex':'none');};

const trajSolidBtn = document.getElementById('trajSolidBtn');
const trajDashBtn = document.getElementById('trajDashBtn');
const trajColor = document.getElementById('trajColor');
const trajWidth = document.getElementById('trajWidth');
const trajOpacity = document.getElementById('trajOpacity');

trajSolidBtn.addEventListener('click', ()=>{
    trajSettings.dash = false;
    trajSolidBtn.classList.add('active');
    trajDashBtn.classList.remove('active');
    updateAllPolylinesStyle();
});
trajDashBtn.addEventListener('click', ()=>{
    trajSettings.dash = true;
    trajDashBtn.classList.add('active');
    trajSolidBtn.classList.remove('active');
    updateAllPolylinesStyle();
});
trajColor.addEventListener('input', ()=>{ trajSettings.color = trajColor.value; updateAllPolylinesStyle(); });
trajWidth.addEventListener('input', ()=>{ trajSettings.weight = Math.max(1, Math.min(10, parseInt(trajWidth.value)||2)); updateAllPolylinesStyle(); });
trajOpacity.addEventListener('input', ()=>{ trajSettings.opacity = Math.max(0, Math.min(1, parseFloat(trajOpacity.value)||0.9)); updateAllPolylinesStyle(); });

function updateAllPolylinesStyle(){
    targets.forEach(t=>{
        if(t._polyline){
            const opts = getPolylineOptions();
            t._polyline.setStyle(opts);
        }
    });
}

/* === Movement loop === */
const MOVE_TICK_MS = 100;
function metersToLat(m){return m/111320;}
function metersToLng(m,lat){return m/(111320*Math.cos(lat*Math.PI/180));}

setInterval(()=>{
    if(!targets||targets.length===0) return;
    const dt = MOVE_TICK_MS/1000;
    targets.forEach(m=>{
        if(!m._moving||m._speedKmph<=0) return;
        const speedMs=(m._speedKmph*1000)/3600;
        const dist=speedMs*dt;
        const theta=m._course*Math.PI/180;
        const dy=Math.cos(theta)*dist;
        const dx=Math.sin(theta)*dist;
        const pos=m.getLatLng();
        const newLat=pos.lat+metersToLat(dy);
        const newLng=pos.lng+metersToLng(dx,pos.lat);
        m._currentPos=L.latLng(newLat,newLng);
        m.setLatLng(m._currentPos);

        if(m._polyline){
            m._polyline.addLatLng(m._currentPos);
            if(!showAllTrajectories && map.hasLayer(m._polyline) && !showSelectedTrajectoryMode) {
                map.removeLayer(m._polyline);
            }
        }
        
        if(m._label){
            m._label.setLatLng(m._currentPos);
        }
    });
}, MOVE_TICK_MS);

/* === AUTOSAVE === */
setInterval(() => {
    if (targets.length > 0) {
        saveTargetsToStorage();
    }
}, 1000);

/* === LOAD TARGETS ON PAGE LOAD === */
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(loadTargetsFromStorage, 100);
});
</script>
</body>
</html>
