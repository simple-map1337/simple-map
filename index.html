<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ú–∞–ø–∞ ‚Äî —Ü—ñ–ª—ñ</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{height:100%;margin:0}
#map{width:100%;height:100vh}

/* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –≤–≤–µ—Ä—Ö—É */
.leaflet-top.leaflet-left {
  display: flex;
  flex-direction: column;
  gap: 5px;
  margin: 10px;
}

.leaflet-control-custom{
  background:white;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,0.3);
  width:32px;height:32px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:18px;transition:0.15s
}
.leaflet-control-custom:hover{background:#f0f0f0}
.leaflet-control-custom.active{background:#cce5ff}
.preview-icon{font-size:18px;opacity:0.8;transform-origin:center}
#iconMenu{
  position:absolute;top:10px;right:10px;z-index:1000;
  background:white;padding:10px;border-radius:8px;
  box-shadow:0 1px 5px rgba(0,0,0,0.3);
  display:none;flex-direction:column;gap:8px;
  font-family:sans-serif;font-size:14px;
  max-height:80vh;overflow-y:auto;
  width:380px;
}
#iconMenu img{width:28px;height:28px;cursor:pointer;transition:0.15s}
#iconMenu img:hover{transform:scale(1.1)}
#speedInput{
  width:100%;padding:4px;margin-top:6px;
  border:1px solid #ccc;border-radius:6px;font-size:14px
}
#toggleMenu{
  position:absolute;top:10px;right:10px;z-index:1001;
  background:white;color:black;border:1px solid #ccc;border-radius:6px;
  width:36px;height:36px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;
}

/* Trajectory controls in menu */
.traj-section { border-top:1px solid #eee; padding-top:6px; margin-top:4px; }
.traj-controls { display:flex; gap:6px; margin-top:6px; }
.traj-controls button { padding:6px 8px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer; }
.traj-controls button.active { background:#00c6ff; color:#fff; border-color:#00a0d6; }
.traj-row { display:flex; gap:6px; align-items:center; }
.traj-row input[type="number"]{ width:60px; padding:4px; border-radius:4px; border:1px solid #ccc; }
.traj-row label{ font-size:13px; }

/* –°—Ç–∏–ª–∏ –¥–ª—è popup —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è */
.distance-popup { text-align: center; }
.distance-popup h3 { margin: 0 0 10px 0; font-size: 16px; }
.distance-popup p { margin: 5px 0; font-size: 14px; }
.distance-popup button {
  margin-top: 10px;
  padding: 6px 12px;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
.distance-popup button:hover {
  background: #0056b3;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –º–µ–Ω—é –∏–∫–æ–Ω–æ–∫ —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π */
.icon-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  max-height: 300px;
  overflow-y: auto;
  padding: 5px;
}
.icon-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  padding: 5px;
  border-radius: 4px;
  transition: background 0.2s;
}
.icon-item:hover {
  background: #f0f0f0;
}
.icon-item img {
  width: 24px;
  height: 24px;
}
.icon-label {
  font-size: 10px;
  text-align: center;
  margin-top: 2px;
  line-height: 1.2;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏–π —Ü–µ–ª–µ–π */
.target-label {
  position: absolute;
  background: rgba(255, 255, 255, 0.7);
  padding: 1px 4px;
  border-radius: 20px;
  font-size: 9px;
  font-weight: bold;
  white-space: nowrap;
  pointer-events: none;
  z-index: 1000;
  border: 1px solid #ccc;
  
}

/* –î–≤—É—Ö–∫–æ–ª–æ–Ω–æ—á–Ω—ã–π layout –¥–ª—è –º–µ–Ω—é */
.menu-columns {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-top: 10px;
}
.menu-column {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.menu-column h4 {
  margin: 0 0 5px 0;
  font-size: 14px;
  color: #333;
}
.name-input {
  width: 100%;
  padding: 6px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 13px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∫–æ–Ω–æ–∫ */
.icon-settings {
  border-top: 1px solid #eee;
  padding-top: 10px;
  margin-top: 10px;
}
.icon-settings-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}
.icon-settings-row label {
  font-size: 13px;
  min-width: 80px;
}
.icon-settings-row input {
  padding: 4px;
  border: 1px solid #ccc;
  border-radius: 4px;
}
.icon-preview {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 10px;
  padding: 10px;
  border: 1px solid #eee;
  border-radius: 4px;
  background: #f9f9f9;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≥—Ä–æ–∑—ã */
.threat-section {
  border-top: 1px solid #eee;
  padding-top: 10px;
  margin-top: 10px;
}
.threat-controls {
  display: flex;
  gap: 6px;
  margin-top: 6px;
}
.threat-controls button {
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  background: #fff;
  cursor: pointer;
  font-size: 12px;
}
.threat-controls button.active {
  background: #ff4444;
  color: #fff;
  border-color: #cc0000;
}
.threat-controls button.active.movement {
  background: #44ff44;
  color: #fff;
  border-color: #00cc00;
}
.threat-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 6px;
}
.threat-row label {
  font-size: 13px;
  min-width: 100px;
}
.threat-row input {
  padding: 4px;
  border: 1px solid #ccc;
  border-radius: 4px;
  width: 80px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ */
.search-result-item {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
    font-size: 14px;
}

.search-result-item:hover {
    background: #f0f0f0;
}

.search-result-item:last-child {
    border-bottom: none;
}

/* –î–æ–±–∞–≤—å—Ç–µ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ */
.search-result-item.loading {
    text-align: center;
    color: #666;
    font-style: italic;
}

.search-result-item.error {
    color: #ff4444;
    text-align: center;
}

.search-result-item .place-type {
    background: #007bff;
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 10px;
    margin-left: 5px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
#editToolsBtn.active,
#rulerBtn.active, 
#drawBtn.active {
  background: #cce5ff !important;
  border-color: #007bff !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ */
#changeTypeModal {
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    z-index: 1002 !important;
}

#modalOverlay {
    position: fixed !important;
    z-index: 1001 !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞ */
.teleport-mode-btn {
    transition: all 0.2s ease;
}

.teleport-mode-btn:hover {
    transform: scale(1.05);
}

.teleport-mode-btn.active {
    color: white;
}

#teleportMoveMode.active {
    background: #44ff44 !important;
    border-color: #00cc00 !important;
}

#teleportStopMode.active {
    background: #ff4444 !important;
    border-color: #cc0000 !important;
}

#teleportModal input[type="number"] {
    font-size: 16px;
    text-align: center;
}

#teleportModal label {
    user-select: none;
}
</style>
</head>
<body>
<div id="map"></div>

<button id="toggleMenu" style="
  position: absolute;
  top: 17px;
  right: 10px;
  z-index: 1001;
  background: white;
  color: black;
  border: 1px solid #ccc;
  border-radius: 6px;
  width: 36px;
  height: 36px;
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
">
‚öô
</button>

<!-- –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (‚úèÔ∏è) -->
<button id="editToolsBtn" style="
  position: absolute;
  top: 60px;
  right: 10px;
  z-index: 1001;
  background: white;
  border: 1px solid #ccc;
  border-radius: 6px;
  width: 36px;
  height: 36px;
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
">
‚úèÔ∏è
</button>

<!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏, —Å–∫—Ä—ã—Ç—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é -->
<div id="editSubmenu" style="
  position: absolute;
  top: 100px;
  right: 10px;
  z-index: 1000;
  display: none;
  flex-direction: column;
  gap: 6px;
">
  <button id="rulerBtn" style="width:36px;height:36px;font-size:18px;border-radius:6px;border:1px solid #ccc;box-shadow:0 2px 6px rgba(0,0,0,0.2);background:white;">üìè</button>
  <button id="drawBtn" style="width:36px;height:36px;font-size:18px;border-radius:6px;border:1px solid #ccc;box-shadow:0 2px 6px rgba(0,0,0,0.2);background:white;">üß∂</button>
</div>

<!-- –ü–û–õ–ï –ü–û–ò–°–ö–ê -->
<div id="searchContainer" style="
  position: absolute;
  top: 10px;
  left: 60px;   /* –Ω–µ–º–Ω–æ–≥–æ –ø—Ä–∞–≤–µ–µ –∫–Ω–æ–ø–∫–∏ ‚ûï */
  z-index: 1000;
  background: transparent;
  padding: 8px;
  border-radius: 8px;
  width: 280px;">
    <input type="text" id="searchInput" placeholder="üîç –ü–æ—à—É–∫ –Ω–∞—Å–µ–ª–µ–Ω–∏—Ö –ø—É–Ω–∫—Ç—ñ–≤..." 
           style="width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.2);">
    <div id="searchResults" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ccc; border-radius: 4px; max-height: 200px; overflow-y: auto; display: none; z-index: 1001; box-shadow: 0 2px 10px rgba(0,0,0,0.2);"></div>
</div>

<div id="iconMenu">
  <b>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ü—ñ–ª–µ–π</b>
  
  <div class="menu-columns">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –∏–∫–æ–Ω–∫–∏ -->
    <div class="menu-column">
      <h4>üõ∏ –¢–∏–ø —Ü—ñ–ª—ñ</h4>
      <div class="icon-grid">
        <div class="icon-item" data-icon="icons/shahed.svg" data-name="–®–∞—Ö–µ–¥" data-speed="140">
          <img src="icons/shahed.svg" title="–®–∞—Ö–µ–¥">
          <div class="icon-label">–®–∞—Ö–µ–¥</div>
        </div>
        <div class="icon-item" data-icon="icons/x-59.svg" data-name="–•-59" data-speed="900">
          <img src="icons/x-59.svg" title="–•-59">
          <div class="icon-label">–•-59</div>
        </div>
        <div class="icon-item" data-icon="icons/x-101.svg" data-name="–•-101" data-speed="800">
          <img src="icons/x-101.svg" title="–•-101">
          <div class="icon-label">–•-101</div>
        </div>
        <div class="icon-item" data-icon="icons/recon.svg" data-name="–†–æ–∑–≤—ñ–¥–Ω–∏–∫" data-speed="120">
          <img src="icons/recon.svg" title="–†–æ–∑–≤—ñ–¥–Ω–∏–∫">
          <div class="icon-label">–†–æ–∑–≤—ñ–¥–Ω–∏–∫</div>
        </div>
        <div class="icon-item" data-icon="icons/s-300-pp.svg" data-name="–°-300 –ü–ü" data-speed="0">
          <img src="icons/s-300-pp.svg" title="–°-300–ü–ü">
          <div class="icon-label">–°-300–ü–ü</div>
        </div>
        <div class="icon-item" data-icon="icons/kab.svg" data-name="–ö–ê–ë" data-speed="600">
          <img src="icons/kab.svg" title="–ö–ê–ë">
          <div class="icon-label">–ö–ê–ë</div>
        </div>
        <div class="icon-item" data-icon="icons/pu-iskander.svg" data-name="–ü–£ –Ü—Å–∫–∞–Ω–¥–µ—Ä" data-speed="0">
          <img src="icons/pu-iskander.svg" title="–ü–£ –Ü—Å–∫–∞–Ω–¥–µ—Ä">
          <div class="icon-label">–ü–£ –Ü—Å–∫–∞–Ω–¥–µ—Ä</div>
        </div>
        <div class="icon-item" data-icon="icons/iskander-k.svg" data-name="–Ü—Å–∫–∞–Ω–¥–µ—Ä-–ö" data-speed="950">
          <img src="icons/iskander-k.svg" title="–Ü—Å–∫–∞–Ω–¥–µ—Ä-–ö">
          <div class="icon-label">–Ü—Å–∫–∞–Ω–¥–µ—Ä-–ö</div>
        </div>
        <div class="icon-item" data-icon="icons/pu-mlrs.svg" data-name="–ü–£ –†–°–ó–í" data-speed="0">
          <img src="icons/pu-mlrs.svg" title="–ü–£ –†–°–ó–í">
          <div class="icon-label">–ü–£ –†–°–ó–í</div>
        </div>
        <div class="icon-item" data-icon="icons/airfield.png" data-name="–ê–µ—Ä–æ–¥—Ä–æ–º" data-speed="0">
    <img src="icons/airfield.png" title="–ê–µ—Ä–æ–¥—Ä–æ–º">
    <div class="icon-label">–ê–µ—Ä–æ–¥—Ä–æ–º</div>
  </div>
  <div class="icon-item" data-icon="icons/shahed-launcher.png" data-name="–ü–£ –®–∞—Ö–µ–¥—ñ–≤" data-speed="0">
    <img src="icons/shahed-launcher.png" title="–ü–£ –®–∞—Ö–µ–¥—ñ–≤">
    <div class="icon-label">–ü–£ –®–∞—Ö–µ–¥—ñ–≤</div>
  </div>
        <div class="icon-item" data-icon="icons/ballistic.svg" data-name="–ë–∞–ª—ñ—Å—Ç–∏–∫–∞" data-speed="6000">
          <img src="icons/ballistic.svg" title="–ë–∞–ª—ñ—Å—Ç–∏–∫–∞">
          <div class="icon-label">–ë–∞–ª—ñ—Å—Ç–∏–∫–∞</div>
        </div>
        <div class="icon-item" data-icon="icons/mig-31k.svg" data-name="–ú—ñ–ì-31–ö" data-speed="1200">
          <img src="icons/mig-31k.svg" title="–ú—ñ–ì-31–ö">
          <div class="icon-label">–ú—ñ–ì-31–ö</div>
        </div>
        <div class="icon-item" data-icon="icons/fpv.svg" data-name="FPV" data-speed="100">
          <img src="icons/fpv.svg" title="FPV">
          <div class="icon-label">FPV</div>
        </div>
        <div class="icon-item" data-icon="icons/unknown.svg" data-name="–ù–µ–≤—ñ–¥–æ–º–∏–π" data-speed="100">
          <img src="icons/unknown.svg" title="–ù–µ–≤—ñ–¥–æ–º–∏–π">
          <div class="icon-label">–ù–µ–≤—ñ–¥–æ–º–∏–π</div>
        </div>
        <div class="icon-item" data-icon="icons/lightning.svg" data-name="–ú–æ–ª–Ω—ñ—è" data-speed="85">
          <img src="icons/lightning.svg" title="–ú–æ–ª–Ω—ñ—è">
          <div class="icon-label">–ú–æ–ª–Ω—ñ—è</div>
        </div>
        <div class="icon-item" data-icon="icons/lancet.svg" data-name="–õ–∞–Ω—Ü–µ—Ç" data-speed="85">
          <img src="icons/lancet.svg" title="–õ–∞–Ω—Ü–µ—Ç">
          <div class="icon-label">–õ–∞–Ω—Ü–µ—Ç</div>
        </div>
        <div class="icon-item" data-icon="icons/iskander-m.svg" data-name="–Ü—Å–∫–∞–Ω–¥–µ—Ä-–ú" data-speed="8000">
          <img src="icons/iskander-m.svg" title="–Ü—Å–∫–∞–Ω–¥–µ—Ä-–ú">
          <div class="icon-label">–Ü—Å–∫–∞–Ω–¥–µ—Ä-–ú</div>
        </div>
        <div class="icon-item" data-icon="icons/mlrs.svg" data-name="–†–°–ó–í" data-speed="3000">
          <img src="icons/mlrs.svg" title="–†–°–ó–í">
          <div class="icon-label">–†–°–ó–í</div>
        </div>
        <div class="icon-item" data-icon="icons/ta.svg" data-name="–¢–ê" data-speed="900">
          <img src="icons/ta.svg" title="–¢–ê">
          <div class="icon-label">–¢–ê</div>
        </div>
        <div class="icon-item" data-icon="icons/kinzhal.svg" data-name="–ö–∏–Ω–∂–∞–ª" data-speed="15000">
          <img src="icons/kinzhal.svg" title="–ö–∏–Ω–∂–∞–ª">
          <div class="icon-label">–ö–∏–Ω–∂–∞–ª</div>
        </div>
        <div class="icon-item" data-icon="icons/tu-22.svg" data-name="–¢—É-22" data-speed="1000">
          <img src="icons/tu-22.svg" title="–¢—É-22">
          <div class="icon-label">–¢—É-22</div>
        </div>
        <div class="icon-item" data-icon="icons/x-22.svg" data-name="–•-22" data-speed="12500">
          <img src="icons/x-22.svg" title="–•-22">
          <div class="icon-label">–•-22</div>
        </div>
        <div class="icon-item" data-icon="icons/tu-95ms.svg" data-name="–¢—É-95–ú–°" data-speed="700">
          <img src="icons/tu-95ms.svg" title="–¢—É-95–ú–°">
          <div class="icon-label">–¢—É-95–ú–°</div>
        </div>
        <div class="icon-item" data-icon="icons/x-31.svg" data-name="–•-31" data-speed="2300">
          <img src="icons/x-31.svg" title="–•-31">
          <div class="icon-label">–•-31</div>
        </div>
        <div class="icon-item" data-icon="icons/recon-strike-uav.svg" data-name="–†–æ–∑–≤./—É–¥–∞—Ä–Ω. –ë–ø–õ–ê" data-speed="100">
          <img src="icons/recon-strike-uav.svg" title="–†–æ–∑–≤./—É–¥–∞—Ä–Ω. –ë–ø–õ–ê">
          <div class="icon-label">–†–æ–∑–≤./—É–¥–∞—Ä–Ω. –ë–ø–õ–ê</div>
        </div>
        <div class="icon-item" data-icon="icons/fast.svg" data-name="–®–≤–∏–¥–∫—ñ—Å–Ω–∞" data-speed="900">
          <img src="icons/fast.svg" title="–®–≤–∏–¥–∫—ñ—Å–Ω–∞">
          <div class="icon-label">–®–≤–∏–¥–∫—ñ—Å–Ω–∞</div>
        </div>
        <div class="icon-item" data-icon="icons/italmas.svg" data-name="–Ü—Ç–∞–ª–º–∞—Å" data-speed="120">
          <img src="icons/italmas.svg" title="–Ü—Ç–∞–ª–º–∞—Å">
          <div class="icon-label">–Ü—Ç–∞–ª–º–∞—Å</div>
        </div>
        <div class="icon-item" data-icon="icons/shahed-238.svg" data-name="–®–∞—Ö–µ–¥ 238" data-speed="250">
          <img src="icons/shahed-238.svg" title="–®–∞—Ö–µ–¥ 238">
          <div class="icon-label">–®–∞—Ö–µ–¥ 238</div>
        </div>
        <div class="icon-item" data-icon="icons/orlan-10.svg" data-name="–û—Ä–ª–∞–Ω-10" data-speed="115">
          <img src="icons/orlan-10.svg" title="–û—Ä–ª–∞–Ω-10">
          <div class="icon-label">–û—Ä–ª–∞–Ω-10</div>
        </div>
        <div class="icon-item" data-icon="icons/supercam.svg" data-name="–°—É–ø–µ—Ä–∫–∞–º" data-speed="85">
          <img src="icons/supercam.svg" title="–°—É–ø–µ—Ä–∫–∞–º">
          <div class="icon-label">–°—É–ø–µ—Ä–∫–∞–º</div>
        </div>
        <div class="icon-item" data-icon="icons/zala.svg" data-name="–ó–∞–ª–∞" data-speed="85">
          <img src="icons/zala.svg" title="–ó–∞–ª–∞">
          <div class="icon-label">–ó–∞–ª–∞</div>
        </div>
        <div class="icon-item" data-icon="icons/su-57.svg" data-name="–°—É-57" data-speed="1100">
          <img src="icons/su-57.svg" title="–°—É-57">
          <div class="icon-label">–°—É-57</div>
        </div>
        <div class="icon-item" data-icon="icons/herbera.svg" data-name="–ì–µ—Ä–±–µ—Ä–∞" data-speed="130">
          <img src="icons/herbera.svg" title="–ì–µ—Ä–±–µ—Ä–∞">
          <div class="icon-label">–ì–µ—Ä–±–µ—Ä–∞</div>
        </div>
      </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ —Ü–µ–ª–∏ -->
<div id="changeTypeModal" style="
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1002;
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    display: none;
    flex-direction: column;
    width: 400px;
    max-height: 80vh;
">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0;">üîÑ –ó–º—ñ–Ω–∏—Ç–∏ —Ç–∏–ø —Ü—ñ–ª—ñ</h3>
        <button id="closeChangeTypeModal" style="background: none; border: none; font-size: 20px; cursor: pointer;">√ó</button>
    </div>
    
    <div style="margin-bottom: 15px; font-size: 14px; color: #666;">
        –í–∏–±—Ä–∞–Ω–∞ —Ü—ñ–ª—å: <span id="selectedTargetName">-</span>
    </div>
    
    <div class="icon-grid" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;">
        <!-- –ò–∫–æ–Ω–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
    </div>
    
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button id="cancelChangeType" style="padding: 8px 16px; border: 1px solid #ccc; border-radius: 4px; background: white; cursor: pointer;">–í—ñ–¥–º—ñ–Ω–∏—Ç–∏</button>
        <button id="confirmChangeType" style="padding: 8px 16px; border: none; border-radius: 4px; background: #007bff; color: white; cursor: pointer;">–ì–æ—Ç–æ–≤–æ</button>
    </div>
</div>

<!-- –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ -->
<div id="modalOverlay" style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1001;
    display: none;
"></div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <div class="menu-column">
      <h4>üè∑Ô∏è –ù–∞–∑–≤–∞ —Ü—ñ–ª—ñ</h4>
      <input type="text" id="targetNameInput" class="name-input" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —Ü—ñ–ª—ñ" maxlength="20">
      
      <h4>‚ö° –®–≤–∏–¥–∫—ñ—Å—Ç—å (–∫–º/–≥–æ–¥)</h4>
      <input type="number" id="speedInput" min="0" max="100000" placeholder="–í–≤–µ–¥–∏ —à–≤–∏–¥–∫—ñ—Å—Ç—å" class="name-input">
      
      <!-- –ù–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∏–∫–æ–Ω–æ–∫ -->
      <div class="icon-settings">
        <h4>üé® –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —ñ–∫–æ–Ω–∫–∏</h4>
        
        <div class="icon-settings-row">
          <label>–ö–æ–ª—ñ—Ä:</label>
          <input type="color" id="iconColorInput" value="#000000">
        </div>
        
        <div class="icon-settings-row">
          <label>–†–æ–∑–º—ñ—Ä:</label>
          <input type="number" id="iconSizeInput" min="10" max="50" value="20" style="width: 60px;">
          <span>px</span>
        </div>
        
        <div class="icon-preview">
          <div id="iconPreview"></div>
        </div>
      </div>

      <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≥—Ä–æ–∑—ã -->
      <div class="threat-section">
    <h4>‚ö†Ô∏è –†–µ–∂–∏–º —Ü—ñ–ª—ñ</h4>
    <div class="threat-controls">
        <button id="threatModeBtn">–ó–∞–≥—Ä–æ–∑–∞</button>
        <button id="movementModeBtn" class="active">–†—É—Ö</button>
    </div>
    
    <!-- –î–û–ë–ê–í–¨ –≠–¢–û –í–ù–£–¢–†–ò threat-section -->
    <div class="threat-row">
        <label>–ì–ª–æ–±–∞–ª—å–Ω–∏–π —Ä–∞–¥—ñ—É—Å (–∫–º):</label>
        <input type="number" id="threatRadiusInput" min="1" max="1000" value="10" step="1">
    </div>
    <div class="threat-row">
        <button id="changeThreatRadiusBtn" style="padding: 4px 8px; font-size: 12px;">
            –ó–º—ñ–Ω–∏—Ç–∏ —Ä–∞–¥—ñ—É—Å –≤–∏–±—Ä–∞–Ω–æ—ó —Ü—ñ–ª—ñ
        </button>
    </div>
    <!-- –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–Ø -->
</div>

<div class="icon-settings">
  <h4>üó∫Ô∏è –°—Ç–∏–ª—å –∫–∞—Ä—Ç–∏</h4>
  <div style="display: flex; flex-direction: column; gap: 6px;">
    <label style="font-size: 13px;">
      <input type="radio" name="mapStyle" value="default" checked>
      –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ (OSM)
    </label>
    <label style="font-size: 13px;">
      <input type="radio" name="mapStyle" value="jawg">
      Jawg Sunny
    </label>
  </div>
</div>

  <div class="traj-section">
    <b>–¢—Ä–∞—î–∫—Ç–æ—Ä—ñ—è</b>
    <div class="traj-controls">
      <button id="trajSolidBtn" class="active">–°—É—Ü—ñ–ª—å–Ω–∞</button>
      <button id="trajDashBtn">–ü—É–Ω–∫—Ç–∏—Ä–Ω–∞</button>
    </div>
    <div class="traj-row">
      <label>–ö–æ–ª—ñ—Ä</label>
      <input id="trajColor" type="color" value="#00a0ff">
    </div>
    <div class="traj-row">
      <label>–®–∏—Ä–∏–Ω–∞</label>
      <input id="trajWidth" type="number" min="1" max="10" value="2">
      <label>–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å</label>
      <input id="trajOpacity" type="number" min="0" max="1" step="0.1" value="0.9" style="width:60px">
    </div>
  </div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞ -->
<div id="teleportModal" style="
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1002;
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    display: none;
    flex-direction: column;
    width: 320px;
    font-family: sans-serif;
">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0;">üöÄ –¢–µ–ª–µ–ø–æ—Ä—Ç —Ü—ñ–ª—ñ</h3>
        <button id="closeTeleportModal" style="background: none; border: none; font-size: 20px; cursor: pointer;">√ó</button>
    </div>
    
    <div style="margin-bottom: 15px; font-size: 14px; color: #666;">
        –¶—ñ–ª—å: <span id="teleportTargetName">-</span>
    </div>
    
    <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-size: 14px;">–ß–∞—Å —Ç–µ–ª–µ–ø–æ—Ä—Ç—É:</label>
        <div style="display: flex; gap: 10px; align-items: center;">
            <div style="flex: 1;">
                <label style="font-size: 12px; color: #666;">–•–≤–∏–ª–∏–Ω–∏</label>
                <input type="number" id="teleportMinutes" min="0" max="59" value="0" 
                       style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
            <div style="font-size: 18px; margin-top: 12px;">:</div>
            <div style="flex: 1;">
                <label style="font-size: 12px; color: #666;">–°–µ–∫—É–Ω–¥–∏</label>
                <input type="number" id="teleportSeconds" min="0" max="59" value="0" 
                       style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
        </div>
    </div>
    
    <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 8px; font-size: 14px;">–†–µ–∂–∏–º –ø—ñ—Å–ª—è —Ç–µ–ª–µ–ø–æ—Ä—Ç—É:</label>
        <div style="display: flex; gap: 10px;">
            <button id="teleportMoveMode" class="teleport-mode-btn active" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background: #44ff44; cursor: pointer;">–†—É—Ö</button>
            <button id="teleportStopMode" class="teleport-mode-btn" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background: white; cursor: pointer;">–°—Ç–æ–ø</button>
        </div>
    </div>
    
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button id="cancelTeleport" style="padding: 8px 16px; border: 1px solid #ccc; border-radius: 4px; background: white; cursor: pointer;">–í—ñ–¥–º—ñ–Ω–∏—Ç–∏</button>
        <button id="applyTeleport" style="padding: 8px 16px; border: none; border-radius: 4px; background: #007bff; color: white; cursor: pointer;">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
     </div>
  </div>
</div>

<script>
// === –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Ä—Ç–∏ ===
const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([49.0, 31.0], 6);

// === –°—Ç–∏–ª–∏ –∫–∞—Ä—Ç ===
const defaultTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '',
});

const jawgTileLayer = L.tileLayer('https://tile.jawg.io/jawg-sunny/{z}/{x}/{y}.png?access-token=7mBLnkdNoZOuvhaDI4MhjcDfLC8Uob4uxAjc4Exd1j1RnThbfsSX3rx4HeexNww8', {
  maxZoom: 22,
  attribution: '',
});

let currentMapStyle = 'default';
defaultTileLayer.addTo(map);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '',
  detectRetina: true,
  updateWhenIdle: false,
  keepBuffer: 2,
  className: 'ukraine-map-tiles light-theme'
}).addTo(map);

/* === –û–¢–ö–õ–Æ–ß–ï–ù–ò–ï –î–í–û–ô–ù–û–ì–û –ö–õ–ò–ö–ê –ó–£–ú–ê === */
map.doubleClickZoom.disable();
map.on('dblclick', function(e) {
    e.originalEvent.preventDefault();
    e.originalEvent.stopPropagation();
});

let mode = null;
let firstClickLatLng = null;
let previewMarker = null;
let selectedIcon = 'icons/shahed.svg';
let selectedSpeed = 0;
let selectedTarget = null;
const targets = []; // markers
const deletedTargets = []; // —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Ü–µ–ª–µ–π

/* === –†–µ–∂–∏–º –ª–∏–Ω–µ–π–∫–∏ === */
let rulerActive = false;
let rulerPoints = [];
let rulerLine = null;
let rulerPopup = null;

/* === –†–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è === */
let drawMode = false;
let drawPoints = [];
let drawMarkers = [];
let drawLine = null;
let segmentLabels = [];
let totalDistanceLabel = null;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –≤ –∫–º - –ü–ï–†–ï–ú–ï–°–¢–ò–¢–ï –≠–¢–£ –§–£–ù–ö–¶–ò–Æ –í –ù–ê–ß–ê–õ–û
function calculateDistanceKm(a, b) {
  const R = 6371;
  const dLat = (b.lat - a.lat) * Math.PI / 180;
  const dLng = (b.lng - a.lng) * Math.PI / 180;
  const lat1 = a.lat * Math.PI / 180;
  const lat2 = b.lat * Math.PI / 180;
  const x = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
  const d = 2 * R * Math.atan2(Math.sqrt(x), Math.sqrt(1-x));
  return d;
}

/* === –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞ === */
let teleportMode = false;
let teleportTarget = null;

/* === –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏–π === */
let selectedTargetName = '';
let showAllLabels = true;

/* === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∫–æ–Ω–æ–∫ === */
let selectedIconColor = '#000000';
let selectedIconSize = 20;

/* === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≥—Ä–æ–∑—ã === */
let threatMode = false;
let movementMode = false;
let threatRadius = 10; // –≤ –∫–∏–ª–æ–º–µ—Ç—Ä–∞—Ö

/* === Trajectory storage and global settings === */
let showAllTrajectories = true;
let showSelectedTrajectory = true;

const trajSettings = {
  dash: false,
  color: '#00a0ff',
  weight: 2,
  opacity: 0.9
};

/* === –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–∫–æ–Ω–∫–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–æ–≤–æ—Ä–æ—Ç–æ–º === */
function createTargetIcon(iconPath, bearing, color = '#000000', size = 20) {
    // SVG –∏–∫–æ–Ω–∫–∏ —Å–º–æ—Ç—Ä—è—Ç –≤–ª–µ–≤–æ, –ø–æ—ç—Ç–æ–º—É –¥–æ–±–∞–≤–ª—è–µ–º 90 –≥—Ä–∞–¥—É—Å–æ–≤ —á—Ç–æ–±—ã –æ–Ω–∏ —Å–º–æ—Ç—Ä–µ–ª–∏ –≤–≤–µ—Ä—Ö
    const correctedBearing = bearing + 90;
    
    return L.divIcon({
        className: 'target-icon',
        html: `
            <div style="
                width: ${size}px; 
                height: ${size}px; 
                display: flex; 
                align-items: center; 
                justify-content: center;
                transform: rotate(${correctedBearing}deg);
                transform-origin: center center;
            ">
                <img src="${iconPath}" 
                     style="
                         width: ${size}px; 
                         height: ${size}px;
                         filter: ${getColorFilter(color)};
                     ">
            </div>
        `,
        iconSize: [size, size],
        iconAnchor: [size/2, size/2]
    });
}

/* === –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–æ–≤–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞ === */
function getColorFilter(color) {
    if (color === '#000000') return 'none';
    
    const colorMap = {
        '#ff0000': 'invert(16%) sepia(99%) saturate(7414%) hue-rotate(1deg) brightness(101%) contrast(118%)',
        '#00ff00': 'invert(55%) sepia(98%) saturate(3115%) hue-rotate(90deg) brightness(122%) contrast(124%)',
        '#0000ff': 'invert(15%) sepia(98%) saturate(7484%) hue-rotate(256deg) brightness(92%) contrast(119%)',
        '#ffff00': 'invert(84%) sepia(65%) saturate(1315%) hue-rotate(359deg) brightness(107%) contrast(104%)',
        '#ff00ff': 'invert(20%) sepia(98%) saturate(7484%) hue-rotate(295deg) brightness(99%) contrast(101%)',
        '#00ffff': 'invert(73%) sepia(63%) saturate(4333%) hue-rotate(161deg) brightness(102%) contrast(101%)',
        '#ffa500': 'invert(62%) sepia(98%) saturate(744%) hue-rotate(359deg) brightness(104%) contrast(101%)',
        '#800080': 'invert(13%) sepia(98%) saturate(7484%) hue-rotate(275deg) brightness(89%) contrast(101%)'
    };
    
    return colorMap[color] || `invert(${hexToHue(color)}%) sepia(100%) saturate(1000%) hue-rotate(${hexToHue(color)}deg)`;
}

/* === –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è HEX –≤ hue === */
function hexToHue(hex) {
    const r = parseInt(hex.slice(1, 3), 16) / 255;
    const g = parseInt(hex.slice(3, 5), 16) / 255;
    const b = parseInt(hex.slice(5, 7), 16) / 255;
    
    const max = Math.max(r, g, b);
    const min = Math.min(r, g, b);
    
    let hue = 0;
    if (max !== min) {
        const delta = max - min;
        switch (max) {
            case r: hue = ((g - b) / delta) % 6; break;
            case g: hue = (b - r) / delta + 2; break;
            case b: hue = (r - g) / delta + 4; break;
        }
        hue = Math.round(hue * 60);
        if (hue < 0) hue += 360;
    }
    
    return hue;
}

// === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –¢–ï–õ–ï–ü–û–†–¢–ê ===

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞
document.getElementById('closeTeleportModal').addEventListener('click', function() {
    closeTeleportModal();
});

document.getElementById('cancelTeleport').addEventListener('click', function() {
    closeTeleportModal();
});

document.getElementById('applyTeleport').addEventListener('click', function() {
    applyTeleport();
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–∂–∏–º–∞
document.getElementById('teleportMoveMode').addEventListener('click', function() {
    this.classList.add('active');
    document.getElementById('teleportStopMode').classList.remove('active');
});

document.getElementById('teleportStopMode').addEventListener('click', function() {
    this.classList.add('active');
    document.getElementById('teleportMoveMode').classList.remove('active');
});

// === –ö–û–ù–ï–¶ –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í –¢–ï–õ–ï–ü–û–†–¢–ê ===

/* === –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∫–æ–Ω–∫–∏ === */
function updateIconPreview() {
    const preview = document.getElementById('iconPreview');
    preview.innerHTML = `
        <img src="${selectedIcon}" 
             style="
                 width: ${selectedIconSize}px; 
                 height: ${selectedIconSize}px;
                 filter: ${getColorFilter(selectedIconColor)};
                 transform: rotate(90deg);
             "
             title="–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ (–ø–æ–≤–µ—Ä–Ω—É—Ç–æ –Ω–∞ 90¬∞ –¥–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è)">
    `;
}

/* === –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ —Ü–µ–ª–∏ === */
function updateTargetIcon(target, bearing = null) {
    const newBearing = bearing !== null ? bearing : target._course;
    const newIcon = createTargetIcon(
        target._iconPath, 
        newBearing, 
        target._iconColor, 
        target._iconSize
    );
    target.setIcon(newIcon);
}

/* === –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –í–°–ï–• –∏–∫–æ–Ω–æ–∫ –Ω–∞ –∫–∞—Ä—Ç–µ === */
function updateAllTargetsIcons() {
    targets.forEach(target => {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç –∏ —Ä–∞–∑–º–µ—Ä —É –≤—Å–µ—Ö —Ü–µ–ª–µ–π
        target._iconColor = selectedIconColor;
        target._iconSize = selectedIconSize;
        updateTargetIcon(target);
    });
    saveTargetsToStorage();
}

/* === –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫—Ä—É–≥–∞ —É–≥—Ä–æ–∑—ã === */
function createThreatCircle(target) {
    if (target._threatCircle) {
        map.removeLayer(target._threatCircle);
    }
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π —Ä–∞–¥–∏—É—Å —Ü–µ–ª–∏, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å, –∏–Ω–∞—á–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–π
    const radiusKm = target._threatRadius || threatRadius;
    const radiusMeters = radiusKm * 1000;
    
    target._threatCircle = L.circle(target.getLatLng(), {
        color: '#ff0000',
        fillColor: '#ff0000',
        fillOpacity: 0.2,
        opacity: 0.7,
        weight: 2,
        radius: radiusMeters
    }).addTo(map);
}

/* === –§—É–Ω–∫—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–¥–∏—É—Å–∞ —É–≥—Ä–æ–∑—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ü–µ–ª–∏ === */
function changeThreatRadius() {
    if (!selectedTarget) {
        showNotification('‚ùå –°–ø–æ—á–∞—Ç–∫—É –≤–∏–±–µ—Ä—ñ—Ç—å —Ü—ñ–ª—å');
        return;
    }
    
    const newRadius = prompt(`–í–≤–µ–¥—ñ—Ç—å —Ä–∞–¥—ñ—É—Å –∑–∞–≥—Ä–æ–∑–∏ –¥–ª—è "${selectedTarget._name}" (–∫–º):`, selectedTarget._threatRadius || threatRadius);
    
    if (newRadius !== null) {
        const radius = parseFloat(newRadius);
        if (!isNaN(radius) && radius > 0 && radius <= 1000) {
            selectedTarget._threatRadius = radius;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫—Ä—É–≥ –µ—Å–ª–∏ —Ü–µ–ª—å –≤ —Ä–µ–∂–∏–º–µ —É–≥—Ä–æ–∑—ã
            if (selectedTarget._isThreat) {
                createThreatCircle(selectedTarget);
            }
            
            saveTargetsToStorage();
            showNotification(`‚úÖ –†–∞–¥—ñ—É—Å –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: ${radius} –∫–º`);
        } else {
            showNotification('‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è —Ä–∞–¥—ñ—É—Å—É');
        }
    }
}

/* === –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫—Ä—É–≥–∞ —É–≥—Ä–æ–∑—ã === */
function removeThreatCircle(target) {
    if (target._threatCircle) {
        map.removeLayer(target._threatCircle);
        target._threatCircle = null;
    }
}

/* === –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–µ–∂–∏–º–∞ —É–≥—Ä–æ–∑—ã === */
function setThreatMode(target) {
    target._isThreat = true;
    target._originalSpeed = target._speedKmph; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å
    target._speedKmph = 0;
    target._moving = false;
    
    createThreatCircle(target);
    saveTargetsToStorage();
}

/* === –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–µ–∂–∏–º–∞ –¥–≤–∏–∂–µ–Ω–∏—è === */
function setMovementMode(target) {
    target._isThreat = false;
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
    if (target._originalSpeed !== undefined) {
        target._speedKmph = target._originalSpeed;
    } else {
        // –ò—â–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
        const iconItem = document.querySelector(`.icon-item[data-icon="${target._iconPath}"]`);
        if (iconItem) {
            target._speedKmph = parseInt(iconItem.dataset.speed) || 0;
        }
    }
    
    target._moving = target._speedKmph > 0;
    
    removeThreatCircle(target);
    saveTargetsToStorage();
}

/* === –§—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ–Ω—ã —É–¥–∞–ª–µ–Ω–∏—è === */
function undoDelete() {
    if (deletedTargets.length > 0) {
        const deletedTarget = deletedTargets.pop();
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä
        const marker = L.marker(deletedTarget.position, { 
            icon: createTargetIcon(deletedTarget.icon, deletedTarget.course, deletedTarget.color, deletedTarget.size)
        }).addTo(map);
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Å–≤–æ–π—Å—Ç–≤–∞
        Object.assign(marker, deletedTarget.properties);
        marker._currentPos = deletedTarget.position;
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ—Ç–∫—É
        const label = L.divIcon({
            className: 'target-label',
            html: `<div>${marker._name}</div>`,
            iconSize: [100, 20],
            iconAnchor: [50, 0]
        });
        
        const labelMarker = L.marker(deletedTarget.position, { 
            icon: label,
            interactive: false 
        }).addTo(map);
        
        marker._label = labelMarker;
        
        if (!showAllLabels) {
            labelMarker.getElement().style.display = 'none';
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é
        if (deletedTarget.trajectory && deletedTarget.trajectory.length > 0) {
            const polyline = L.polyline(deletedTarget.trajectory, getPolylineOptions());
            marker._polyline = polyline;
            if (showAllTrajectories && !showSelectedTrajectoryMode) polyline.addTo(map);
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—Ä—É–≥ —É–≥—Ä–æ–∑—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if (marker._isThreat) {
            createThreatCircle(marker);
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π
        marker.on('click', createTargetClickHandler(marker));
        
        targets.push(marker);
        saveTargetsToStorage();
        
        console.log(`–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ —Ü—ñ–ª—å: ${marker._name}`);
    } else {
        console.log('–ù–µ–º–∞—î –≤–∏–¥–∞–ª–µ–Ω–∏—Ö —Ü—ñ–ª–µ–π –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è');
    }
}

/* === –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–ª–∏–∫–∞ –¥–ª—è —Ü–µ–ª–∏ === */
function createTargetClickHandler(marker) {
    return function(e) {
        if (e) L.DomEvent.stopPropagation(e);

        // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —É –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ü–µ–ª–∏
        if (selectedTarget && selectedTarget !== marker && selectedTarget.getElement()) {
            selectedTarget.getElement().style.filter = '';
        }

        if (calculateDistanceMode) {
            selectedTarget = marker;
            if (marker.getElement()) marker.getElement().style.filter = 'drop-shadow(0 0 6px orange)';
            return;
        }

        if (quickTrajectoryMode) {
            if (selectedTarget && selectedTarget !== marker && previousTargetSpeed !== null) {
                selectedTarget._speedKmph = previousTargetSpeed;
                selectedTarget._moving = selectedTarget._speedKmph > 0;
            }
            selectedTarget = marker;
            if (marker.getElement()) marker.getElement().style.filter = 'drop-shadow(0 0 6px red)';
            previousTargetSpeed = selectedTarget._speedKmph;
            selectedTarget._speedKmph = 0;
            selectedTarget._moving = false;
            quickTrajectoryPoints = [selectedTarget.getLatLng()];
            if (quickTrajectoryPolyline) quickTrajectoryPolyline.setLatLngs(quickTrajectoryPoints);
            return;
        }

        if (showSelectedTrajectoryMode) {
            if (selectedTarget && selectedTarget !== marker && selectedTarget._polyline) {
                if (map.hasLayer(selectedTarget._polyline)) map.removeLayer(selectedTarget._polyline);
            }
            selectedTarget = marker;
            if (marker.getElement()) marker.getElement().style.filter = 'drop-shadow(0 0 6px green)';
            if (selectedTarget._polyline && !map.hasLayer(selectedTarget._polyline)) map.addLayer(selectedTarget._polyline);
            return;
        }

        if (threatMode) {
            setThreatMode(marker);
            threatMode = false;
            threatModeBtn.classList.remove('active');
            return;
        }

        if (movementMode) {
            setMovementMode(marker);
            movementMode = false;
            movementModeBtn.classList.remove('active');
            return;
        }

        // === —Ä–µ–∂–∏–º —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞ ===
        if (teleportMode) {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —É –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ü–µ–ª–∏
            if (teleportTarget && teleportTarget !== marker && teleportTarget.getElement()) {
                teleportTarget.getElement().style.filter = '';
            }
            
            teleportTarget = marker;
            
            // –í—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ü–µ–ª—å
            if (marker.getElement()) {
                marker.getElement().style.filter = 'drop-shadow(0 0 6px #ff00ff)';
            }
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞
            openTeleportModal(marker);
            
            return;
        }

        // === —Ä–µ–∂–∏–º —Å–º–µ–Ω—ã —Ç–∏–ø–∞ —Ü–µ–ª–∏ ===
        if (mode === 'changeType') {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —É –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ü–µ–ª–∏
            if (selectedTarget && selectedTarget !== marker && selectedTarget.getElement()) {
                selectedTarget.getElement().style.filter = '';
            }
            
            selectedTarget = marker;
            
            // –í—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ü–µ–ª—å
            if (marker.getElement()) {
                marker.getElement().style.filter = 'drop-shadow(0 0 6px purple)';
            }
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞
            openChangeTypeModal(marker);
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ü–µ–ª–∏
            mode = null;
            document.querySelectorAll('.leaflet-control-custom').forEach(ctrl => {
                ctrl.classList.remove('active');
            });
            return;
        }
        
        // === —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–µ–∂–∏–º—ã ===
        if (mode === 'delete') {
            deleteTarget(marker);
        } else if (mode === 'course') {
            selectedTarget = marker;
            if (marker.getElement()) marker.getElement().style.filter = 'drop-shadow(0 0 4px blue)';
        } else if (mode === 'speed') {
            selectedTarget = marker;
            if (marker.getElement()) marker.getElement().style.filter = 'drop-shadow(0 0 4px blue)';
            changeTargetSpeed(marker);
        }
    };
}

/* === –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –†–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –∏ –≤—Ä–µ–º–µ–Ω–∏ === */
let calculateDistanceMode = false;
let distanceMarker = null;

function startCalculateDistance() {
    if (calculateDistanceMode) {
        calculateDistanceMode = false;
        calculateDistanceBtn.classList.remove('active');
        
        if (selectedTarget && selectedTarget.getElement()) {
            selectedTarget.getElement().style.filter = '';
        }
        selectedTarget = null;
        
        if (distanceMarker) {
            map.removeLayer(distanceMarker);
            distanceMarker = null;
        }
        
    } else {
        calculateDistanceMode = true;
        calculateDistanceBtn.classList.add('active');
        
        mode = null;
        quickTrajectoryMode = false;
        quickTrajectoryBtn.classList.remove('active');
        showSelectedTrajectoryMode = false;
        trajSelEl.classList.remove('active');
        threatMode = false;
        threatModeBtn.classList.remove('active');
        movementMode = false;
        movementModeBtn.classList.remove('active');
        document.querySelectorAll('.leaflet-control-custom').forEach(el => {
            if(el !== calculateDistanceBtn) el.classList.remove('active');
        });
        
        clearPreview();
    }
}

function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371000;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function formatTime(seconds) {
    if (seconds < 60) {
        return `${Math.round(seconds)} —Å–µ–∫`;
    } else if (seconds < 3600) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.round(seconds % 60);
        return `${minutes} —Ö–≤ ${secs} —Å–µ–∫`;
    } else {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        return `${hours} –≥–æ–¥ ${minutes} —Ö–≤`;
    }
}

function createDistancePopup(targetPos, clickPos, target) {
    const distance = calculateDistance(
        targetPos.lat, targetPos.lng,
        clickPos.lat, clickPos.lng
    );
    
    const distanceKm = (distance / 1000).toFixed(2);
    const distanceMiles = (distance / 1609.34).toFixed(2);
    
    let timeSeconds = 0;
    if (target._speedKmph > 0) {
        timeSeconds = (distance / 1000) / (target._speedKmph / 3600);
    }
    
    const popupContent = `
        <div class="distance-popup">
            <h3>üìê –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫</h3>
            <p><strong>–í—ñ–¥—Å—Ç–∞–Ω—å:</strong> ${distanceKm} –∫–º (${distanceMiles} –º–∏–ª—å)</p>
            <p><strong>–ß–∞—Å –ø—ñ–¥–ª—å–æ—Ç—É:</strong> ${target._speedKmph > 0 ? formatTime(timeSeconds) : '–¶—ñ–ª—å –∑—É–ø–∏–Ω–µ–Ω–∞'}</p>
            <p><strong>–®–≤–∏–¥–∫—ñ—Å—Ç—å —Ü—ñ–ª—ñ:</strong> ${target._speedKmph} –∫–º/–≥–æ–¥</p>
            <button onclick="this.parentElement.parentElement.closePopup()">–ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
    `;
    
    return popupContent;
}

/* === –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ë—ã—Å—Ç—Ä–∞—è —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è === */
let quickTrajectoryMode = false;
let quickTrajectoryPoints = [];
let quickTrajectoryPolyline = null;
let previousTargetSpeed = null;

function startQuickTrajectory() {
    if (quickTrajectoryMode) {
        if (selectedTarget && quickTrajectoryPoints.length > 1) {
            applyQuickTrajectory();
        }
        
        quickTrajectoryMode = false;
        quickTrajectoryBtn.classList.remove('active');
        
        if (quickTrajectoryPolyline) {
            map.removeLayer(quickTrajectoryPolyline);
            quickTrajectoryPolyline = null;
        }
        quickTrajectoryPoints = [];
        
        if (selectedTarget && previousTargetSpeed !== null) {
            selectedTarget._speedKmph = previousTargetSpeed;
            selectedTarget._moving = selectedTarget._speedKmph > 0;
            previousTargetSpeed = null;
        }
        
        if (selectedTarget && selectedTarget.getElement()) {
            selectedTarget.getElement().style.filter = '';
        }
        selectedTarget = null;
        
    } else {
        quickTrajectoryMode = true;
        quickTrajectoryBtn.classList.add('active');
        
        mode = null;
        calculateDistanceMode = false;
        calculateDistanceBtn.classList.remove('active');
        showSelectedTrajectoryMode = false;
        trajSelEl.classList.remove('active');
        threatMode = false;
        threatModeBtn.classList.remove('active');
        movementMode = false;
        movementModeBtn.classList.remove('active');
        document.querySelectorAll('.leaflet-control-custom').forEach(el => {
            if(el !== quickTrajectoryBtn && el !== trajSelEl) el.classList.remove('active');
        });
        
        if (selectedTarget) {
            previousTargetSpeed = selectedTarget._speedKmph;
            selectedTarget._speedKmph = 0;
            selectedTarget._moving = false;
            selectedTarget.getElement().style.filter = 'drop-shadow(0 0 6px red)';
            
            quickTrajectoryPoints = [selectedTarget.getLatLng()];
        } else {
            quickTrajectoryPoints = [];
        }
        
        quickTrajectoryPolyline = L.polyline(quickTrajectoryPoints, {
            color: '#ff0000',
            weight: 3,
            opacity: 0.7,
            dashArray: '5,5'
        }).addTo(map);
    }
}

function applyQuickTrajectory() {
    if (!selectedTarget || quickTrajectoryPoints.length < 2) return;
    
    const lastPoint = quickTrajectoryPoints[quickTrajectoryPoints.length - 1];
    const secondLastPoint = quickTrajectoryPoints[quickTrajectoryPoints.length - 2];
    
    const bearing = bearingDegrees(secondLastPoint, lastPoint);
    
    selectedTarget.setLatLng(lastPoint);
    selectedTarget._currentPos = lastPoint;
    
    selectedTarget._course = bearing;
    updateTargetIcon(selectedTarget, bearing);
    
    selectedTarget._speedKmph = 0;
    selectedTarget._moving = false;
    
    if (selectedTarget._polyline) {
        const currentPoints = selectedTarget._polyline.getLatLngs();
        const newPoints = currentPoints.concat(quickTrajectoryPoints.slice(1));
        selectedTarget._polyline.setLatLngs(newPoints);
    } else {
        selectedTarget._polyline = L.polyline(quickTrajectoryPoints, getPolylineOptions());
        if (showAllTrajectories) selectedTarget._polyline.addTo(map);
    }
    
    previousTargetSpeed = null;
    saveTargetsToStorage();
}

/* === –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ü–µ–ª–∏ === */
let showSelectedTrajectoryMode = false;

function toggleSelectedTrajectory() {
    if (showSelectedTrajectoryMode) {
        showSelectedTrajectoryMode = false;
        trajSelEl.classList.remove('active');
        
        if (selectedTarget && selectedTarget.getElement()) {
            selectedTarget.getElement().style.filter = '';
        }
        selectedTarget = null;
        
        targets.forEach(t => {
            if (t._polyline && !map.hasLayer(t._polyline)) {
                map.addLayer(t._polyline);
            }
        });
        
    } else {
        showSelectedTrajectoryMode = true;
        trajSelEl.classList.add('active');
        
        mode = null;
        quickTrajectoryMode = false;
        quickTrajectoryBtn.classList.remove('active');
        calculateDistanceMode = false;
        calculateDistanceBtn.classList.remove('active');
        threatMode = false;
        threatModeBtn.classList.remove('active');
        movementMode = false;
        movementModeBtn.classList.remove('active');
        document.querySelectorAll('.leaflet-control-custom').forEach(el => {
            if(el !== trajSelEl) el.classList.remove('active');
        });
        
        targets.forEach(t => {
            if (t._polyline && map.hasLayer(t._polyline)) {
                map.removeLayer(t._polyline);
            }
        });
    }
}

/* === LOCAL STORAGE FUNCTIONS === */
function saveTargetsToStorage() {
    const data = targets.map(target => {
        return {
            lat: target._currentPos.lat,
            lng: target._currentPos.lng,
            course: target._course,
            speed: target._speedKmph,
            icon: target._iconPath,
            name: target._name,
            color: target._iconColor,
            size: target._iconSize,
            isThreat: target._isThreat || false,
            originalSpeed: target._originalSpeed,
            threatRadius: target._threatRadius,
            trajectory: target._polyline ? target._polyline.getLatLngs() : [],
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            lastUpdate: Date.now()
        };
    });
    localStorage.setItem('mapTargets', JSON.stringify(data));
    // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω–æ
    localStorage.setItem('lastSaveTime', Date.now().toString());
}

function restoreTarget(positionLatLng, bearingDeg, speed, iconPath, trajectory, name = '–¶—ñ–ª—å', color = '#000000', size = 20, isThreat = false, originalSpeed = null, threatRadius = null) {
    const marker = L.marker(positionLatLng, { 
        icon: createTargetIcon(iconPath, bearingDeg, color, size)
    }).addTo(map);
    
    marker._course = bearingDeg;
    marker._speedKmph = speed || 0;
    marker._moving = marker._speedKmph > 0;
    marker._currentPos = positionLatLng;
    marker._iconPath = iconPath;
    marker._name = name;
    marker._iconColor = color;
    marker._iconSize = size;
    marker._isThreat = isThreat;
    marker._originalSpeed = originalSpeed;
    marker._threatRadius = threatRadius;

    const label = L.divIcon({
        className: 'target-label',
        html: `<div>${marker._name}</div>`,
        iconSize: [25, 15],
        iconAnchor: [15, -15]
    });
    
    const labelMarker = L.marker(positionLatLng, { 
        icon: label,
        interactive: false 
    }).addTo(map);
    
    marker._label = labelMarker;

    const polyline = L.polyline(trajectory.length > 0 ? trajectory : [positionLatLng], getPolylineOptions());
    marker._polyline = polyline;
    
    if (showAllTrajectories && !showSelectedTrajectoryMode) polyline.addTo(map);

    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—Ä—É–≥ —É–≥—Ä–æ–∑—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if (marker._isThreat) {
        createThreatCircle(marker);
    }

    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–¥–∏–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤
    marker.on('click', createTargetClickHandler(marker));

    targets.push(marker);
}

function getPolylineOptions() {
    return {
        color: trajSettings.color,
        weight: trajSettings.weight,
        opacity: trajSettings.opacity,
        dashArray: trajSettings.dash ? '6,6' : null
    };
}

function bearingDegrees(fromLatLng,toLatLng){
    const toRad = d=>d*Math.PI/180;
    const toDeg = r=>r*180/Math.PI;
    const œÜ1=toRad(fromLatLng.lat);
    const œÜ2=toRad(toLatLng.lat);
    const ŒîŒª=toRad(toLatLng.lng - fromLatLng.lng);
    const y=Math.sin(ŒîŒª)*Math.cos(œÜ2);
    const x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);
    return (toDeg(Math.atan2(y,x))+360)%360;
}

function clearPreview() {
    firstClickLatLng = null;
    if (previewMarker) {
        map.removeLayer(previewMarker);
        previewMarker = null;
    }
}

/* === Controls === */
/* === –ö–Ω–æ–ø–∫–∞ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è/—Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö === */
const ToggleControlsButton = L.Control.extend({
  options: { position: 'topleft' },
  onAdd() {
    const el = L.DomUtil.create('div', 'leaflet-control leaflet-control-custom');
    el.innerHTML = 'üìö';
    el.title = '–ü–æ–∫–∞–∑–∞—Ç–∏/–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ —ñ–Ω—à—ñ –∫–Ω–æ–ø–∫–∏';
    L.DomEvent.on(el, 'click', ev => {
      L.DomEvent.stopPropagation(ev);
      L.DomEvent.preventDefault(ev);

      const isHidden = document.body.classList.toggle('controls-hidden');
      const allButtons = document.querySelectorAll('.leaflet-top.leaflet-left .leaflet-control-custom');
      allButtons.forEach(btn => {
        if (btn !== el) btn.style.display = isHidden ? 'none' : 'flex';
      });
    });
    return el;
  }
});

const AddControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd() { 
        const el = L.DomUtil.create('div', 'leaflet-control leaflet-control-custom'); 
        el.innerHTML = '‚ûï';
        el.title = '–î–æ–¥–∞—Ç–∏ —Ü—ñ–ª—å';
        L.DomEvent.on(el, 'click', ev => {
            L.DomEvent.stopPropagation(ev);
            L.DomEvent.preventDefault(ev);
            mode = (mode === 'add') ? null : 'add';
            el.classList.toggle('active');
            document.querySelectorAll('.leaflet-control-custom').forEach(ctrl => {
                if(ctrl !== el) ctrl.classList.remove('active');
            });
            
            // –û–ß–ò–°–¢–ö–ê –ü–†–ï–í–¨–Æ –ü–†–ò –ê–ö–¢–ò–í–ê–¶–ò–ò/–î–ï–ê–ö–¢–ò–í–ê–¶–ò–ò –†–ï–ñ–ò–ú–ê
            clearPreview();
            
            quickTrajectoryMode = false;
            quickTrajectoryBtn.classList.remove('active');
            calculateDistanceMode = false;
            calculateDistanceBtn.classList.remove('active');
            showSelectedTrajectoryMode = false;
            trajSelEl.classList.remove('active');
            threatMode = false;
            threatModeBtn.classList.remove('active');
            movementMode = false;
            movementModeBtn.classList.remove('active');
            if (selectedTarget && selectedTarget.getElement()) selectedTarget.getElement().style.filter = '';
            selectedTarget = null;
        });
        return el;
    }
});

const QuickTrajectoryControl=L.Control.extend({options:{position:'topleft'},onAdd(){ 
    const el=L.DomUtil.create('div','leaflet-control leaflet-control-custom'); 
    el.innerHTML='üéØ';el.title='–®–≤–∏–¥–∫–∞ —Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—è (–≤–∏–¥—ñ–ª—ñ—Ç—å —Ü—ñ–ª—å, –∫–ª–∞—Ü–∞–π—Ç–µ –ø–æ –∫–∞—Ä—Ç—ñ, –ø–æ—Ç—ñ–º –∑–Ω–æ–≤—É –∫–Ω–æ–ø–∫—É)';
    L.DomEvent.on(el,'click',function(ev) {
        L.DomEvent.stopPropagation(ev);L.DomEvent.preventDefault(ev);
        startQuickTrajectory();
    });
    return el;
}});

// –û–ß–ò–°–¢–ö–ê –ü–†–ï–í–¨–Æ
clearPreview();

const CalculateDistanceControl=L.Control.extend({options:{position:'topleft'},onAdd(){ 
    const el=L.DomUtil.create('div','leaflet-control leaflet-control-custom'); 
    el.innerHTML='üìè';el.title='–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –≤—ñ–¥—Å—Ç–∞–Ω—å —Ç–∞ —á–∞—Å –ø—ñ–¥–ª—å–æ—Ç—É (–≤–∏–¥—ñ–ª—ñ—Ç—å —Ü—ñ–ª—å, –∫–ª–∞—Ü–Ω—ñ—Ç—å –ø–æ –∫–∞—Ä—Ç—ñ)';
    L.DomEvent.on(el,'click',function(ev) {
        L.DomEvent.stopPropagation(ev);L.DomEvent.preventDefault(ev);
        startCalculateDistance();
    });
    return el;
}});

// –û–ß–ò–°–¢–ö–ê –ü–†–ï–í–¨–Æ
clearPreview();

const CourseControl=L.Control.extend({options:{position:'topleft'},onAdd(){
    const el=L.DomUtil.create('div','leaflet-control leaflet-control-custom');
    el.innerHTML='üß≠';el.title='–ó–º—ñ–Ω–∏—Ç–∏ –∫—É—Ä—Å';
    L.DomEvent.on(el,'click',ev=>{
        L.DomEvent.stopPropagation(ev);L.DomEvent.preventDefault(ev);
        const isActive = el.classList.toggle('active');
        mode = isActive ? 'course' : null;
        document.querySelectorAll('.leaflet-control-custom').forEach(ctrl => {
            if(ctrl !== el) ctrl.classList.remove('active');
        });
        
        // –û–ß–ò–°–¢–ö–ê –ü–†–ï–í–¨–Æ
            clearPreview()
        
        quickTrajectoryMode = false;
        quickTrajectoryBtn.classList.remove('active');
        calculateDistanceMode = false;
        calculateDistanceBtn.classList.remove('active');
        showSelectedTrajectoryMode = false;
        trajSelEl.classList.remove('active');
        threatMode = false;
        threatModeBtn.classList.remove('active');
        movementMode = false;
        movementModeBtn.classList.remove('active');
        if(!isActive && selectedTarget && selectedTarget.getElement()) {
            selectedTarget.getElement().style.filter='';
            selectedTarget=null;
        }
        clearPreview();
    });return el;
}});

const SpeedControl=L.Control.extend({options:{position:'topleft'},onAdd(){
    const el=L.DomUtil.create('div','leaflet-control leaflet-control-custom');
    el.innerHTML='‚ö°';el.title='–ó–º—ñ–Ω–∏—Ç–∏ —à–≤–∏–¥–∫—ñ—Å—Ç—å';
    L.DomEvent.on(el,'click',ev=>{
        L.DomEvent.stopPropagation(ev);L.DomEvent.preventDefault(ev);
        const isActive = el.classList.toggle('active');
        mode = isActive ? 'speed' : null;
        document.querySelectorAll('.leaflet-control-custom').forEach(ctrl => {
            if(ctrl !== el) ctrl.classList.remove('active');
        });
        
        // –û–ß–ò–°–¢–ö–ê –ü–†–ï–í–¨–Æ
clearPreview();
        
        quickTrajectoryMode = false;
        quickTrajectoryBtn.classList.remove('active');
        calculateDistanceMode = false;
        calculateDistanceBtn.classList.remove('active');
        showSelectedTrajectoryMode = false;
        trajSelEl.classList.remove('active');
        threatMode = false;
        threatModeBtn.classList.remove('active');
        movementMode = false;
        movementModeBtn.classList.remove('active');
        if(!isActive && selectedTarget && selectedTarget.getElement()){
            selectedTarget.getElement().style.filter='';
            selectedTarget=null;
        }
        clearPreview();
    });return el;
}});

const DeleteControl=L.Control.extend({options:{position:'topleft'},onAdd(){
    const el=L.DomUtil.create('div','leaflet-control leaflet-control-custom');
    el.innerHTML='üóëÔ∏è';el.title='–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—ñ–ª—å';
    L.DomEvent.on(el,'click',ev=>{
        L.DomEvent.stopPropagation(ev);L.DomEvent.preventDefault(ev);
        mode=(mode==='delete')?null:'delete';el.classList.toggle('active');
        document.querySelectorAll('.leaflet-control-custom').forEach(ctrl => {
            if(ctrl !== el) ctrl.classList.remove('active');
        });
        
        // –û–ß–ò–°–¢–ö–ê –ü–†–ï–í–¨–Æ
clearPreview();
        
        quickTrajectoryMode = false;
        quickTrajectoryBtn.classList.remove('active');
        calculateDistanceMode = false;
        calculateDistanceBtn.classList.remove('active');
        showSelectedTrajectoryMode = false;
        trajSelEl.classList.remove('active');
        threatMode = false;
        threatModeBtn.classList.remove('active');
        movementMode = false;
        movementModeBtn.classList.remove('active');
        clearPreview();
    });return el;
}});

const ChangeTypeControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd() {
        const el = L.DomUtil.create('div', 'leaflet-control leaflet-control-custom');
        el.innerHTML = '‚ôªÔ∏è';
        el.title = '–ó–º—ñ–Ω–∏—Ç–∏ —Ç–∏–ø —Ü—ñ–ª—ñ';
        L.DomEvent.on(el, 'click', ev => {
            L.DomEvent.stopPropagation(ev);
            L.DomEvent.preventDefault(ev);
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Ä–µ–∂–∏–º—ã
            resetAllModes();
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ–∂–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞
            mode = 'changeType';
            el.classList.add('active');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
            showNotification('üî¥ –í–∏–¥—ñ–ª—ñ—Ç—å —Ü—ñ–ª—å, —Ç–∏–ø —è–∫–æ—ó —Ö–æ—á–µ—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏');
        });
        return el;
    }
});

const UndoDeleteControl=L.Control.extend({options:{position:'topleft'},onAdd(){
    const el=L.DomUtil.create('div','leaflet-control leaflet-control-custom');
    el.innerHTML='‚Ü∂';el.title='–í—ñ–¥–º—ñ–Ω–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è';
    L.DomEvent.on(el,'click',function(ev) {
        L.DomEvent.stopPropagation(ev);L.DomEvent.preventDefault(ev);
        undoDelete();
    });
    return el;
}});

const TrajAllControl=L.Control.extend({options:{position:'topleft'},onAdd(){
    const el=L.DomUtil.create('div','leaflet-control leaflet-control-custom');
    el.innerHTML='üìà';el.title='–ü–æ–∫–∞–∑–∞—Ç–∏/–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤—Å—ñ —Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—ó';
    L.DomEvent.on(el,'click',ev=>{
        L.DomEvent.stopPropagation(ev);L.DomEvent.preventDefault(ev);
        const isActive = el.classList.toggle('active');
        showAllTrajectories = isActive;
        if (!showSelectedTrajectoryMode) {
            targets.forEach(t => {
                if(t._polyline){
                    if(showAllTrajectories) {
                        if(!map.hasLayer(t._polyline)) map.addLayer(t._polyline);
                    } else {
                        if(map.hasLayer(t._polyline)) map.removeLayer(t._polyline);
                    }
                }
            });
        }
    });return el;
}});

const TrajSelControl=L.Control.extend({options:{position:'topleft'},onAdd(){
    const el=L.DomUtil.create('div','leaflet-control leaflet-control-custom');
    el.innerHTML='üîç';el.title='–ü–æ–∫–∞–∑–∞—Ç–∏ —Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—é –≤–∏–±—Ä–∞–Ω–æ—ó —Ü—ñ–ª—ñ';
    L.DomEvent.on(el,'click',function(ev) {
        L.DomEvent.stopPropagation(ev);L.DomEvent.preventDefault(ev);
        toggleSelectedTrajectory();
    });
    return el;
}});

// –û–ß–ò–°–¢–ö–ê –ü–†–ï–í–¨–Æ
clearPreview();

/* === –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π === */
const LabelsControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function() {
        const el = L.DomUtil.create('div', 'leaflet-control leaflet-control-custom');
        el.innerHTML = 'üè∑Ô∏è';
        el.title = '–ü–æ–∫–∞–∑–∞—Ç–∏/–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –Ω–∞–∑–≤–∏ —Ü—ñ–ª–µ–π';
        L.DomEvent.on(el, 'click', function(ev) {
            L.DomEvent.stopPropagation(ev);
            L.DomEvent.preventDefault(ev);
            toggleLabelsVisibility();
        });
        return el;
    }
});

/* === –ö–æ–Ω—Ç—Ä–æ–ª —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞ === */
const TeleportControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd() {
        const el = L.DomUtil.create('div', 'leaflet-control leaflet-control-custom');
        el.innerHTML = 'üöÄ';
        el.title = '–¢–µ–ª–µ–ø–æ—Ä—Ç —Ü—ñ–ª—ñ';
        L.DomEvent.on(el, 'click', function(ev) {
            L.DomEvent.stopPropagation(ev);
            L.DomEvent.preventDefault(ev);
            startTeleportMode();
        });
        return el;
    }
});

// –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∫–æ–Ω—Ç—Ä–æ–ª—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
map.addControl(new ToggleControlsButton());    // üìö - –ø–µ—Ä–≤–∞—è
map.addControl(new AddControl());              // ‚ûï
map.addControl(new QuickTrajectoryControl());  // üéØ
map.addControl(new CalculateDistanceControl());// üìè
map.addControl(new CourseControl());           // üß≠
map.addControl(new SpeedControl());            // ‚ö°
map.addControl(new DeleteControl());           // üóëÔ∏è
map.addControl(new ChangeTypeControl());       // ‚ôªÔ∏è
map.addControl(new UndoDeleteControl());       // ‚Ü∂
map.addControl(new TrajAllControl());          // üìà
map.addControl(new TrajSelControl());          // üîç
map.addControl(new LabelsControl());           // üè∑Ô∏è
map.addControl(new TeleportControl());         // üöÄ - –¢–ï–ü–ï–†–¨ –í –°–ê–ú–û–ú –ö–û–ù–¶–ï

const toggleControlsBtn = document.querySelector('.leaflet-control-custom:nth-of-type(1)');
const addControlEl = document.querySelector('.leaflet-control-custom:nth-of-type(2)');
const quickTrajectoryBtn = document.querySelector('.leaflet-control-custom:nth-of-type(3)');
const calculateDistanceBtn = document.querySelector('.leaflet-control-custom:nth-of-type(4)');
const courseControlEl = document.querySelector('.leaflet-control-custom:nth-of-type(5)');
const speedControlEl = document.querySelector('.leaflet-control-custom:nth-of-type(6)');
const deleteControlEl = document.querySelector('.leaflet-control-custom:nth-of-type(7)');
const changeTypeBtn = document.querySelector('.leaflet-control-custom:nth-of-type(8)');
const undoDeleteBtn = document.querySelector('.leaflet-control-custom:nth-of-type(9)');
const trajAllEl = document.querySelector('.leaflet-control-custom:nth-of-type(10)');
const trajSelEl = document.querySelector('.leaflet-control-custom:nth-of-type(11)');
const labelsBtn = document.querySelector('.leaflet-control-custom:nth-of-type(12)');
const teleportBtn = document.querySelector('.leaflet-control-custom:nth-of-type(13)'); // –¢–ï–ü–ï–†–¨ –ü–û–°–õ–ï–î–ù–Ø–Ø

// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏–π
function toggleLabelsVisibility() {
    showAllLabels = !showAllLabels;
    const labelsBtn = document.querySelector('.leaflet-control-custom:nth-of-type(10)');
    
    if (showAllLabels) {
        labelsBtn.classList.remove('active');
        labelsBtn.style.background = 'white';
    } else {
        labelsBtn.classList.add('active');
        labelsBtn.style.background = '#cce5ff';
    }
    
    targets.forEach(target => {
        if (target._label) {
            if (showAllLabels) {
                target._label.getElement().style.display = 'block';
            } else {
                target._label.getElement().style.display = 'none';
            }
        }
    });
}

function createTarget(positionLatLng, bearingDeg) {
    const marker = L.marker(positionLatLng, { 
        icon: createTargetIcon(selectedIcon, bearingDeg, selectedIconColor, selectedIconSize)
    }).addTo(map);
    
    marker._course = bearingDeg;
    marker._speedKmph = selectedSpeed || 0;
    marker._moving = marker._speedKmph > 0;
    marker._currentPos = positionLatLng;
    marker._iconPath = selectedIcon;
    marker._name = selectedTargetName || '–¶—ñ–ª—å';
    marker._iconColor = selectedIconColor;
    marker._iconSize = selectedIconSize;
    marker._isThreat = false;

    const label = L.divIcon({
        className: 'target-label',
        html: `<div>${marker._name}</div>`,
        iconSize: [25, 15],
        iconAnchor: [15, -15]
    });
    
    const labelMarker = L.marker(positionLatLng, { 
        icon: label,
        interactive: false 
    }).addTo(map);
    
    marker._label = labelMarker;

    if (!showAllLabels) {
        labelMarker.getElement().style.display = 'none';
    }

    const polyline = L.polyline([positionLatLng], getPolylineOptions());
    marker._polyline = polyline;
    if (showAllTrajectories && !showSelectedTrajectoryMode) polyline.addTo(map);

    marker.on('click', createTargetClickHandler(marker));

    targets.push(marker);
    saveTargetsToStorage();
    
    // –í–ê–ñ–ù–û: –û—á–∏—â–∞–µ–º –ø—Ä–µ–≤—å—é –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ü–µ–ª–∏
    clearPreview();
}

/* === –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–∞—Ä—Ç–µ === */
map.on('click', function(e) {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ü–ï–†–í–´–ú–ò)
    if (rulerActive) {
        handleRulerClick(e);
        return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    }

    if (drawMode) {
        handleDrawingClick(e);
        return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    if (calculateDistanceMode && selectedTarget) {
        const popupContent = createDistancePopup(
            selectedTarget.getLatLng(),
            e.latlng,
            selectedTarget
        );
        
        if (distanceMarker) {
            map.removeLayer(distanceMarker);
        }
        
        distanceMarker = L.marker(e.latlng)
            .addTo(map)
            .bindPopup(popupContent)
            .openPopup();
        
        return;
    }
    
    if (quickTrajectoryMode && selectedTarget) {
        quickTrajectoryPoints.push(e.latlng);
        if (quickTrajectoryPolyline) {
            quickTrajectoryPolyline.setLatLngs(quickTrajectoryPoints);
        }
        return;
    }
    
    if(mode === 'add'){
        if(!firstClickLatLng){
            firstClickLatLng = e.latlng;
            // –£–±–µ–¥–∏–º—Å—è —á—Ç–æ —Å—Ç–∞—Ä–∞—è –º–µ—Ç–∫–∞ –ø—Ä–µ–≤—å—é —É–¥–∞–ª–µ–Ω–∞
            if (previewMarker) {
                map.removeLayer(previewMarker);
            }
            previewMarker = L.marker(firstClickLatLng, {
                icon: L.divIcon({
                    className: 'preview-icon',
                    html: 'üìç',
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                }),
                interactive: false
            }).addTo(map);
        } else {
            const bearing = bearingDegrees(firstClickLatLng, e.latlng);
            createTarget(firstClickLatLng, bearing);
            // clearPreview() —Ç–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ createTarget()
        }
    } else if(mode === 'course' && selectedTarget){
        const newBearing = bearingDegrees(selectedTarget.getLatLng(), e.latlng);
        selectedTarget._course = newBearing;
        updateTargetIcon(selectedTarget, newBearing);
        saveTargetsToStorage();
    }
});

/* === Menu bindings === */
document.querySelectorAll('.icon-item').forEach(item => {
    item.addEventListener('click', () => {
        selectedIcon = item.dataset.icon;
        
        // –í–°–ï–ì–î–ê —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Å–∫–æ—Ä–æ—Å—Ç—å –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞ —Ü–µ–ª–∏
        selectedTargetName = item.dataset.name || '–¶—ñ–ª—å';
        selectedSpeed = parseInt(item.dataset.speed) || 0;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
        document.getElementById('targetNameInput').value = selectedTargetName;
        document.getElementById('speedInput').value = selectedSpeed;
        
        document.querySelectorAll('.icon-item').forEach(i => i.style.background = '');
        item.style.background = '#e3f2fd';
        updateIconPreview();
    });
});

document.getElementById('speedInput').addEventListener('input',e=>{selectedSpeed=Math.min(parseFloat(e.target.value)||0,100000);});
document.getElementById('targetNameInput').addEventListener('input', function(e) {
    selectedTargetName = e.target.value.trim();
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∫–æ–Ω–æ–∫
document.getElementById('iconColorInput').addEventListener('input', function(e) {
    selectedIconColor = e.target.value;
    updateIconPreview();
    // –û–±–Ω–æ–≤–ª—è–µ–º –í–°–ï —Ü–µ–ª–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
    updateAllTargetsIcons();
});

document.getElementById('iconSizeInput').addEventListener('input', function(e) {
    selectedIconSize = Math.max(10, Math.min(50, parseInt(e.target.value) || 20));
    updateIconPreview();
    // –û–±–Ω–æ–≤–ª—è–µ–º –í–°–ï —Ü–µ–ª–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
    updateAllTargetsIcons();
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≥—Ä–æ–∑—ã
const threatModeBtn = document.getElementById('threatModeBtn');
const movementModeBtn = document.getElementById('movementModeBtn');
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–¥–∏—É—Å–∞
document.getElementById('changeThreatRadiusBtn').addEventListener('click', changeThreatRadius);
const threatRadiusInput = document.getElementById('threatRadiusInput');

threatModeBtn.addEventListener('click', function() {
    threatMode = !threatMode;
    if (threatMode) {
        threatModeBtn.classList.add('active');
        movementMode = false;
        movementModeBtn.classList.remove('active');
        mode = null;
        document.querySelectorAll('.leaflet-control-custom').forEach(el => {
            el.classList.remove('active');
        });
    } else {
        threatModeBtn.classList.remove('active');
    }
});

movementModeBtn.addEventListener('click', function() {
    movementMode = !movementMode;
    if (movementMode) {
        movementModeBtn.classList.add('active');
        threatMode = false;
        threatModeBtn.classList.remove('active');
        mode = null;
        document.querySelectorAll('.leaflet-control-custom').forEach(el => {
            el.classList.remove('active');
        });
    } else {
        movementModeBtn.classList.remove('active');
    }
});

threatRadiusInput.addEventListener('input', function(e) {
    threatRadius = Math.max(1, Math.min(1000, parseInt(e.target.value) || 10));
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫—Ä—É–≥–∏ —É –≤—Å–µ—Ö —Ü–µ–ª–µ–π –≤ —Ä–µ–∂–∏–º–µ —É–≥—Ä–æ–∑—ã
    targets.forEach(target => {
        if (target._isThreat && target._threatCircle) {
            createThreatCircle(target);
        }
    });
});

const toggleMenu=document.getElementById('toggleMenu');
const iconMenu=document.getElementById('iconMenu');
toggleMenu.onclick=()=>{iconMenu.style.display=(iconMenu.style.display==='none'?'flex':'none');};

const trajSolidBtn = document.getElementById('trajSolidBtn');
const trajDashBtn = document.getElementById('trajDashBtn');
const trajColor = document.getElementById('trajColor');
const trajWidth = document.getElementById('trajWidth');
const trajOpacity = document.getElementById('trajOpacity');

trajSolidBtn.addEventListener('click', ()=>{
    trajSettings.dash = false;
    trajSolidBtn.classList.add('active');
    trajDashBtn.classList.remove('active');
    updateAllPolylinesStyle();
});
trajDashBtn.addEventListener('click', ()=>{
    trajSettings.dash = true;
    trajDashBtn.classList.add('active');
    trajSolidBtn.classList.remove('active');
    updateAllPolylinesStyle();
});
trajColor.addEventListener('input', ()=>{ trajSettings.color = trajColor.value; updateAllPolylinesStyle(); });
trajWidth.addEventListener('input', ()=>{ trajSettings.weight = Math.max(1, Math.min(10, parseInt(trajWidth.value)||2)); updateAllPolylinesStyle(); });
trajOpacity.addEventListener('input', ()=>{ trajSettings.opacity = Math.max(0, Math.min(1, parseFloat(trajOpacity.value)||0.9)); updateAllPolylinesStyle(); });

function updateAllPolylinesStyle(){
    targets.forEach(t=>{
        if(t._polyline){
            const opts = getPolylineOptions();
            t._polyline.setStyle(opts);
        }
    });
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Ä–∞–¥–∏—É—Å–∞
document.getElementById('threatRadiusInput').addEventListener('input', function(e) {
    threatRadius = Math.max(1, Math.min(1000, parseInt(e.target.value) || 10));
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫—Ä—É–≥–∏ —Ç–æ–ª—å–∫–æ —É —Ü–µ–ª–µ–π –±–µ–∑ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–¥–∏—É—Å–∞
    targets.forEach(target => {
        if (target._isThreat && target._threatCircle && !target._threatRadius) {
            createThreatCircle(target);
        }
    });
});

/* === Movement loop === */
const MOVE_TICK_MS = 100;
function metersToLat(m){return m/111320;}
function metersToLng(m,lat){return m/(111320*Math.cos(lat*Math.PI/180));}

setInterval(() => {
    if (!targets || targets.length === 0) return;
    
    const currentTime = Date.now();
    const dt = (currentTime - lastUpdateTime) / 1000; // –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    lastUpdateTime = currentTime;
    
    // –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞, –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    if (!isPageVisible) {
        calculateOfflineMovement(dt);
        return;
    }
    
    targets.forEach(m => {
        if (!m._moving || m._speedKmph <= 0 || m._isThreat) return;
        
        const speedMs = (m._speedKmph * 1000) / 3600;
        const dist = speedMs * dt;
        const theta = m._course * Math.PI / 180;
        const dy = Math.cos(theta) * dist;
        const dx = Math.sin(theta) * dist;
        const pos = m.getLatLng(); // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –º–∞—Ä–∫–µ—Ä–∞
        
        const newLat = pos.lat + metersToLat(dy);
        const newLng = pos.lng + metersToLng(dx, pos.lat);
        
        const newPos = L.latLng(newLat, newLng);
        
        // –û–ë–ù–û–í–õ–Ø–ï–ú –û–ë–ï –ü–û–ó–ò–¶–ò–ò –°–ò–ù–•–†–û–ù–ù–û
        m._currentPos = newPos;
        m.setLatLng(newPos); // –í–∞–∂–Ω–æ: –æ–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –º–∞—Ä–∫–µ—Ä–∞

        if (m._polyline) {
            m._polyline.addLatLng(newPos);
            if (!showAllTrajectories && map.hasLayer(m._polyline) && !showSelectedTrajectoryMode) {
                map.removeLayer(m._polyline);
            }
        }
        
        if (m._label) {
            m._label.setLatLng(newPos);
        }
        
        if (m._isThreat && m._threatCircle) {
            m._threatCircle.setLatLng(newPos);
        }
    });
}, MOVE_TICK_MS);

/* === AUTOSAVE === */
setInterval(() => {
    if (targets.length > 0) {
        saveTargetsToStorage();
    }
}, 1000);

/* === LOAD TARGETS ON PAGE LOAD === */
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(loadTargetsFromStorage, 100);
    updateIconPreview();
    initGoogleSearch();
    initChangeTypeModal();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞
    const teleportModal = document.getElementById('teleportModal');
    if (!teleportModal) {
        console.error('Teleport modal not found!');
    } else {
        console.log('Teleport modal initialized successfully');
    }
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–π –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
    setTimeout(() => {
        targets.forEach(m => {
            if (m._currentPos && m.getLatLng()) {
                // –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è - –∏—Å–ø—Ä–∞–≤–ª—è–µ–º
                const currentLatLng = m.getLatLng();
                const storedLatLng = m._currentPos;
                
                if (currentLatLng.lat !== storedLatLng.lat || currentLatLng.lng !== storedLatLng.lng) {
                    console.log(`–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –ø–æ–∑–∏—Ü—ñ—ó –¥–ª—è ${m._name}`);
                    m.setLatLng(storedLatLng);
                    if (m._label) m._label.setLatLng(storedLatLng);
                }
            }
        });
    }, 100);
});

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ —á–µ—Ä–µ–∑ Nominatim (OpenStreetMap)
function searchPlaces(query) {
    const searchResults = document.getElementById('searchResults');
    
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    searchResults.innerHTML = '';
    searchResults.style.display = 'block';
    searchResults.innerHTML = '<div class="search-result-item">–ü–æ—à—É–∫...</div>';
    
    // Nominatim API - –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π, –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ', –£–∫—Ä–∞—ó–Ω–∞')}&limit=10&accept-language=uk`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            searchResults.innerHTML = '';
            
            if (data && data.length > 0) {
                displaySearchResults(data);
            } else {
                searchResults.innerHTML = '<div class="search-result-item">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            searchResults.innerHTML = '<div class="search-result-item">–ü–æ–º–∏–ª–∫–∞ –∑ º—î–¥–Ω–∞–Ω–Ω—è</div>';
        });
}

// –û–±–Ω–æ–≤–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
function displaySearchResults(places) {
    const searchResults = document.getElementById('searchResults');
    searchResults.innerHTML = '';
    
    places.forEach(place => {
        const item = document.createElement('div');
        item.className = 'search-result-item';
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –º–µ—Å—Ç–∞ –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        let type = '';
        if (place.type === 'city' || place.type === 'town') {
            type = '–ú—ñ—Å—Ç–æ';
        } else if (place.type === 'village') {
            type = '–°–µ–ª–æ';
        } else if (place.type === 'hamlet') {
            type = '–•—É—Ç—ñ—Ä';
        } else {
            type = place.type || '–ù–∞—Å–µ–ª–µ–Ω–∏–π –ø—É–Ω–∫—Ç';
        }
        
        item.innerHTML = `
            <div style="font-weight: bold;">${place.display_name.split(',')[0]}</div>
            <div style="font-size: 12px; color: #666;">${type} ‚Ä¢ ${place.display_name.split(',').slice(1, 3).join(',')}</div>
        `;
        
        item.addEventListener('click', () => {
            selectPlace(place);
        });
        
        searchResults.appendChild(item);
    });
}

// –û–±–Ω–æ–≤–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –≤—ã–±–æ—Ä–∞ –º–µ—Å—Ç–∞
function selectPlace(place) {
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    
    searchResults.style.display = 'none';
    searchInput.value = place.display_name.split(',')[0];
    
    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –º–µ—Å—Ç–µ
    const latLng = L.latLng(parseFloat(place.lat), parseFloat(place.lon));
    map.setView(latLng, 12);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä
    const marker = L.marker(latLng)
        .addTo(map)
        .bindPopup(`
            <div style="text-align: center;">
                <strong>${place.display_name.split(',')[0]}</strong><br>
                <small>${place.display_name.split(',').slice(1, 3).join(',')}</small>
            </div>
        `)
        .openPopup();
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–±–∏—Ä–∞–µ–º –º–∞—Ä–∫–µ—Ä —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        if (map.hasLayer(marker)) {
            map.removeLayer(marker);
        }
    }, 3000);
}

function deleteTarget(marker) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
    const targetData = {
        position: marker.getLatLng(),
        icon: marker._iconPath,
        course: marker._course,
        color: marker._iconColor,
        size: marker._iconSize,
        trajectory: marker._polyline ? marker._polyline.getLatLngs() : [],
        properties: {
            _course: marker._course,
            _speedKmph: marker._speedKmph,
            _moving: marker._moving,
            _currentPos: marker._currentPos,
            _iconPath: marker._iconPath,
            _name: marker._name,
            _iconColor: marker._iconColor,
            _iconSize: marker._iconSize,
            _isThreat: marker._isThreat,
            _originalSpeed: marker._originalSpeed,
            _threatRadius: marker._threatRadius
        }
    };
    
    deletedTargets.push(targetData);
    
    // –£–¥–∞–ª—è–µ–º —Å –∫–∞—Ä—Ç—ã
    if (marker._polyline && map.hasLayer(marker._polyline)) {
        map.removeLayer(marker._polyline);
    }
    if (marker._label && map.hasLayer(marker._label)) {
        map.removeLayer(marker._label);
    }
    if (marker._threatCircle && map.hasLayer(marker._threatCircle)) {
        map.removeLayer(marker._threatCircle);
    }
    
    // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞
    const idx = targets.indexOf(marker);
    if (idx !== -1) {
        targets.splice(idx, 1);
    }
    
    // –£–¥–∞–ª—è–µ–º –º–∞—Ä–∫–µ—Ä
    if (map.hasLayer(marker)) {
        map.removeLayer(marker);
    }
    
    saveTargetsToStorage();
}

function changeTargetSpeed(marker) {
    const newSpeed = prompt("–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤—É —à–≤–∏–¥–∫—ñ—Å—Ç—å (–∫–º/–≥–æ–¥):", marker._speedKmph);
    if (newSpeed !== null) {
        const sp = parseFloat(newSpeed);
        if (!isNaN(sp)) {
            marker._speedKmph = Math.max(0, Math.min(sp, 100000));
            marker._moving = marker._speedKmph > 0;
            saveTargetsToStorage();
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            if (marker.getElement()) {
                marker.getElement().style.filter = '';
            }
            selectedTarget = null;
        }
    } else {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –æ—Ç–º–µ–Ω–∏–ª–∏ –≤–≤–æ–¥
        if (marker.getElement()) {
            marker.getElement().style.filter = '';
        }
        selectedTarget = null;
    }
}

function resetAllModes() {
    mode = null;
    calculateDistanceMode = false;
    quickTrajectoryMode = false;
    showSelectedTrajectoryMode = false;
    threatMode = false;
    movementMode = false;
    rulerActive = false;
    drawMode = false;
    teleportMode = false;
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –í–°–ï–• –∫–Ω–æ–ø–æ–∫
    document.querySelectorAll('.leaflet-control-custom').forEach(ctrl => {
        ctrl.classList.remove('active');
    });
    document.getElementById('rulerBtn').classList.remove('active');
    document.getElementById('drawBtn').classList.remove('active');
    document.getElementById('editToolsBtn').classList.remove('active');
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –∫–Ω–æ–ø–∫–∏ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞
    if (teleportBtn) teleportBtn.classList.remove('active');
    
    // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥–º–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    editSubmenu.style.display = 'none';
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ü–µ–ª–∏
    if (selectedTarget && selectedTarget.getElement()) {
        selectedTarget.getElement().style.filter = '';
    }
    selectedTarget = null;
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞
    if (teleportTarget && teleportTarget.getElement()) {
        teleportTarget.getElement().style.filter = '';
    }
    teleportTarget = null;
    
    // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    clearPreview();
    quickTrajectoryPoints = [];
    if (quickTrajectoryPolyline) {
        map.removeLayer(quickTrajectoryPolyline);
        quickTrajectoryPolyline = null;
    }
    if (distanceMarker) {
        map.removeLayer(distanceMarker);
        distanceMarker = null;
    }
    
    // –û—á–∏—â–∞–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    clearDrawTools();
    rulerPoints = [];
    if (rulerLine) {
        map.removeLayer(rulerLine);
        rulerLine = null;
    }
    if (rulerPopup) {
        map.closePopup(rulerPopup);
        rulerPopup = null;
    }
    
    map.getContainer().style.cursor = '';
}

function resetCreationMode() {
    if (mode === 'add') {
        clearPreview();
    }
}

// –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let lastUpdateTime = Date.now();
let isPageVisible = true;

function loadTargetsFromStorage() {
    const saved = localStorage.getItem('mapTargets');
    const lastSaveTime = localStorage.getItem('lastSaveTime');
    
    if (saved) {
        try {
            const data = JSON.parse(saved);
            const currentTime = Date.now();
            const savedTime = lastSaveTime ? parseInt(lastSaveTime) : currentTime;
            const timeDiff = (currentTime - savedTime) / 1000; // —Ä–∞–∑–Ω–∏—Ü–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
            
            data.forEach(targetData => {
                let position = L.latLng(targetData.lat, targetData.lng);
                
                // –ï—Å–ª–∏ —Ü–µ–ª—å –¥–≤–∏–≥–∞–ª–∞—Å—å –∏ –ø—Ä–æ—à–ª–æ –≤—Ä–µ–º—è, —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é
                if (!targetData.isThreat && targetData.speed > 0 && timeDiff > 0) {
                    position = calculateNewPosition(
                        position, 
                        targetData.course, 
                        targetData.speed, 
                        timeDiff
                    );
                }
                
                restoreTarget(
                    position, 
                    targetData.course, 
                    targetData.speed, 
                    targetData.icon, 
                    targetData.trajectory, 
                    targetData.name || '–¶—ñ–ª—å',
                    targetData.color || '#000000',
                    targetData.size || 20,
                    targetData.isThreat || false,
                    targetData.originalSpeed || null,
                    targetData.threatRadius || null
                );
            });
            
            console.log(`–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ${data.length} —Ü—ñ–ª–µ–π, –æ–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–∑–∏—Ü—ñ—ó –∑–∞ ${timeDiff.toFixed(1)} —Å–µ–∫`);
            
            // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ü–û–°–õ–ï –ó–ê–ì–†–£–ó–ö–ò
            setTimeout(() => {
                targets.forEach(m => {
                    if (m._currentPos && m.getLatLng()) {
                        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è - –∏—Å–ø—Ä–∞–≤–ª—è–µ–º
                        const currentLatLng = m.getLatLng();
                        const storedLatLng = m._currentPos;
                        
                        if (currentLatLng.lat !== storedLatLng.lat || currentLatLng.lng !== storedLatLng.lng) {
                            console.log(`–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –ø–æ–∑–∏—Ü—ñ—ó –¥–ª—è ${m._name}`);
                            m.setLatLng(storedLatLng);
                            if (m._label) m._label.setLatLng(storedLatLng);
                        }
                    }
                });
            }, 100);
            
        } catch (e) {
            console.error('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è —Ü—ñ–ª–µ–π:', e);
        }
    }
}

function calculateNewPosition(startPos, bearing, speedKmph, timeSeconds) {
    if (speedKmph <= 0) return startPos;
    
    const speedMs = (speedKmph * 1000) / 3600;
    const distance = speedMs * timeSeconds;
    const theta = bearing * Math.PI / 180;
    
    const dy = Math.cos(theta) * distance;
    const dx = Math.sin(theta) * distance;
    
    const newLat = startPos.lat + metersToLat(dy);
    const newLng = startPos.lng + metersToLng(dx, startPos.lat);
    
    return L.latLng(newLat, newLng);
}

function metersToLat(m) {
    return m / 111320;
}

function metersToLng(m, lat) {
    return m / (111320 * Math.cos(lat * Math.PI / 180));
}

function calculateOfflineMovement(dt) {
    let hasChanges = false;
    
    targets.forEach(m => {
        if (!m._moving || m._speedKmph <= 0 || m._isThreat) return;
        
        const speedMs = (m._speedKmph * 1000) / 3600;
        const dist = speedMs * dt;
        const theta = m._course * Math.PI / 180;
        const dy = Math.cos(theta) * dist;
        const dx = Math.sin(theta) * dist;
        const pos = m._currentPos;
        const newLat = pos.lat + metersToLat(dy);
        const newLng = pos.lng + metersToLng(dx, pos.lat);
        
        const newPos = L.latLng(newLat, newLng);
        m._currentPos = newPos;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é
        if (m._polyline) {
            const currentPoints = m._polyline.getLatLngs();
            currentPoints.push(newPos);
            m._polyline.setLatLngs(currentPoints);
        }
        
        hasChanges = true;
    });
    
    if (hasChanges) {
        saveTargetsToStorage();
    }
}

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∫–æ–≥–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–µ–≤–∏–¥–∏–º–æ–π/–≤–∏–¥–∏–º–æ–π
document.addEventListener('visibilitychange', function() {
    isPageVisible = !document.hidden;
    lastUpdateTime = Date.now();
    
    if (isPageVisible) {
        // –ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –º–∞—Ä–∫–µ—Ä–æ–≤
        targets.forEach(m => {
            m.setLatLng(m._currentPos);
            if (m._label) m._label.setLatLng(m._currentPos);
            if (m._threatCircle) m._threatCircle.setLatLng(m._currentPos);
            if (m._polyline) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∏–ª–∏–Ω–∏—é –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                const currentPoints = m._polyline.getLatLngs();
                if (currentPoints.length > 0) {
                    currentPoints[currentPoints.length - 1] = m._currentPos;
                    m._polyline.setLatLngs(currentPoints);
                }
            }
        });
    }
});

// –¢–∞–∫–∂–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∫–æ–≥–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
window.addEventListener('blur', function() {
    isPageVisible = false;
});

window.addEventListener('focus', function() {
    isPageVisible = true;
    lastUpdateTime = Date.now();
});

// –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—É—é 1 —Å–µ–∫—É–Ω–¥—É
setInterval(() => {
    if (targets.length > 0) {
        saveTargetsToStorage();
    }
}, 1000);

// –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', function() {
    saveTargetsToStorage();
});

function syncAllTargetsPositions() {
    targets.forEach(m => {
        if (m._currentPos) {
            const currentMarkerPos = m.getLatLng();
            if (currentMarkerPos.lat !== m._currentPos.lat || currentMarkerPos.lng !== m._currentPos.lng) {
                console.log(`–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è: ${m._name}`);
                m.setLatLng(m._currentPos);
                if (m._label) m._label.setLatLng(m._currentPos);
                if (m._threatCircle) m._threatCircle.setLatLng(m._currentPos);
            }
        }
    });
}

// –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
setInterval(syncAllTargetsPositions, 3000);

/* === –ü–æ–¥–º–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è === */
const editBtn = document.getElementById('editToolsBtn');
const editSubmenu = document.getElementById('editSubmenu');
const rulerBtn = document.getElementById('rulerBtn');
const drawBtn = document.getElementById('drawBtn');

editBtn.addEventListener('click', () => {
    const isVisible = editSubmenu.style.display === 'flex';
    
    if (isVisible) {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –∏ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Å–µ —Ä–µ–∂–∏–º—ã
        editSubmenu.style.display = 'none';
        editBtn.classList.remove('active');
        deactivateEditModes();
    } else {
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é
        editSubmenu.style.display = 'flex';
        editBtn.classList.add('active');
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –∫–Ω–æ–ø–æ–∫ –≤ –ø–æ–¥–º–µ–Ω—é
        rulerBtn.classList.remove('active');
        drawBtn.classList.remove('active');
    }
});

// –§—É–Ω–∫—Ü–∏—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function deactivateEditModes() {
    // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ª–∏–Ω–µ–π–∫—É
    rulerActive = false;
    rulerBtn.classList.remove('active');
    rulerPoints = [];
    if (rulerLine) { 
        map.removeLayer(rulerLine); 
        rulerLine = null; 
    }
    if (rulerPopup) { 
        map.closePopup(rulerPopup); 
        rulerPopup = null; 
    }
    
    // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–∏—Å–æ–≤–∞–Ω–∏–µ
    drawMode = false;
    drawBtn.classList.remove('active');
    clearDrawTools();
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä
    map.getContainer().style.cursor = '';
}

// –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
function clearDrawTools() {
    drawPoints = [];
    drawMarkers.forEach(m => map.removeLayer(m));
    drawMarkers = [];
    if (drawLine) { 
        map.removeLayer(drawLine); 
        drawLine = null; 
    }
    segmentLabels.forEach(l => map.removeLayer(l));
    segmentLabels = [];
    if (totalDistanceLabel) { 
        map.closePopup(totalDistanceLabel); 
        totalDistanceLabel = null; 
    }
}

/* === –†–µ–∂–∏–º –ª–∏–Ω–µ–π–∫–∏ === */
function activateRuler() {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ —Ä–µ–∂–∏–º—ã
    resetAllModes();
    deactivateEditModes();
    
    rulerActive = !rulerActive;
    rulerBtn.classList.toggle('active', rulerActive);

    // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
    rulerPoints = [];
    if (rulerLine) { 
        map.removeLayer(rulerLine); 
        rulerLine = null; 
    }
    if (rulerPopup) { 
        map.closePopup(rulerPopup); 
        rulerPopup = null; 
    }

    map.getContainer().style.cursor = rulerActive ? 'crosshair' : '';
    
    // –ï—Å–ª–∏ –≤—ã–∫–ª—é—á–∞–µ–º –ª–∏–Ω–µ–π–∫—É, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–æ—á–∫–∏
    if (!rulerActive) {
        rulerPoints = [];
    }
}

/* === –†–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è === */
function activateDrawing() {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ —Ä–µ–∂–∏–º—ã
    resetAllModes();
    deactivateEditModes();
    
    drawMode = !drawMode;
    drawBtn.classList.toggle('active', drawMode);

    if (!drawMode) {
        clearDrawTools();
        map.getContainer().style.cursor = '';
    } else {
        map.getContainer().style.cursor = 'crosshair';
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
rulerBtn.addEventListener('click', activateRuler);
drawBtn.addEventListener('click', activateDrawing);

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –¥–ª—è –ª–∏–Ω–µ–π–∫–∏
function handleRulerClick(e) {
    if (!rulerActive) return;

    rulerPoints.push(e.latlng);
    
    // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
    if (rulerPoints.length >= 2) {
        if (rulerLine) {
            map.removeLayer(rulerLine);
        }
        rulerLine = L.polyline(rulerPoints, {color: 'red', weight: 3}).addTo(map);
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∫–æ–≥–¥–∞ –µ—Å—Ç—å 2 —Ç–æ—á–∫–∏
    if (rulerPoints.length === 2) {
        const d = calculateDistanceKm(rulerPoints[0], rulerPoints[1]);
        if (rulerPopup) {
            map.closePopup(rulerPopup);
        }
        rulerPopup = L.popup()
            .setLatLng(rulerPoints[1])
            .setContent(`üìè –í—ñ–¥—Å—Ç–∞–Ω—å: ${d.toFixed(2)} –∫–º`)
            .openOn(map);
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
function handleDrawingClick(e) {
    if (!drawMode) return;

    const point = e.latlng;
    drawPoints.push(point);

    const marker = L.marker(point, { draggable: true }).addTo(map);
    drawMarkers.push(marker);

    marker.on('drag', updateDrawLine);

    updateDrawLine();
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–∏–Ω–∏–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
function updateDrawLine() {
    // —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ª–∏–Ω–∏–∏ –∏ –ø–æ–¥–ø–∏—Å–∏
    if (drawLine) map.removeLayer(drawLine);
    segmentLabels.forEach(l => map.removeLayer(l));
    segmentLabels = [];

    drawPoints = drawMarkers.map(m => m.getLatLng());
    if (drawPoints.length > 1) {
        drawLine = L.polyline(drawPoints, { color: 'blue', weight: 2 }).addTo(map);
    }

    // –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
    drawPoints.forEach((pt, i) => {
        if (i === 0) return;
        const d = calculateDistanceKm(drawPoints[i-1], drawPoints[i]);
        const mid = L.latLng(
            (drawPoints[i-1].lat + drawPoints[i].lat) / 2,
            (drawPoints[i-1].lng + drawPoints[i].lng) / 2
        );
        const label = L.marker(mid, {
            icon: L.divIcon({
                className: 'distance-label',
                html: `<div style="background:white;padding:2px 4px;border-radius:4px;border:1px solid #aaa;font-size:10px;">${d.toFixed(2)} –∫–º</div>`,
            }),
            interactive: false
        }).addTo(map);
        segmentLabels.push(label);
    });

    // –æ–±—â–µ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
    const total = drawPoints.reduce((acc, pt, i) => {
        if (i === 0) return 0;
        return acc + calculateDistanceKm(drawPoints[i-1], pt);
    }, 0);

    if (totalDistanceLabel) map.closePopup(totalDistanceLabel);
    if (drawPoints.length > 0) {
        totalDistanceLabel = L.popup()
            .setLatLng(drawPoints[drawPoints.length - 1])
            .setContent(`üß∂ –í—Å—å–æ–≥–æ: ${total.toFixed(2)} –∫–º`)
            .openOn(map);
    }
}

function showNotification(message) {
    // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const notification = L.popup()
        .setLatLng(map.getCenter())
        .setContent(`<div style="text-align:center;">${message}</div>`)
        .openOn(map);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        map.closePopup(notification);
    }, 2000);
}

/* === –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ —Ü–µ–ª–∏ === */
let changeTypeModal = document.getElementById('changeTypeModal');
let modalOverlay = document.getElementById('modalOverlay');
let selectedTargetForChange = null;
let selectedNewIcon = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function initChangeTypeModal() {
    const iconGrid = changeTypeModal.querySelector('.icon-grid');
    
    // –ö–æ–ø–∏—Ä—É–µ–º –∏–∫–æ–Ω–∫–∏ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é
    const originalIcons = document.querySelectorAll('.icon-item');
    iconGrid.innerHTML = '';
    
    originalIcons.forEach(icon => {
        const iconClone = icon.cloneNode(true);
        iconClone.addEventListener('click', function() {
            // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∏–∫–æ–Ω–æ–∫
            iconGrid.querySelectorAll('.icon-item').forEach(i => {
                i.style.background = '';
            });
            // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∏–∫–æ–Ω–∫—É
            this.style.background = '#e3f2fd';
            selectedNewIcon = {
                icon: this.dataset.icon,
                name: this.dataset.name,
                speed: parseInt(this.dataset.speed) || 0
            };
        });
        iconGrid.appendChild(iconClone);
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.getElementById('closeChangeTypeModal').addEventListener('click', closeChangeTypeModal);
    document.getElementById('cancelChangeType').addEventListener('click', closeChangeTypeModal);
    document.getElementById('confirmChangeType').addEventListener('click', confirmChangeType);
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ overlay
    modalOverlay.addEventListener('click', closeChangeTypeModal);
}

function openChangeTypeModal(target) {
    selectedTargetForChange = target;
    selectedNewIcon = null;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ü–µ–ª–∏
    document.getElementById('selectedTargetName').textContent = target._name;
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–æ–∫
    changeTypeModal.querySelectorAll('.icon-item').forEach(i => {
        i.style.background = '';
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º block –≤–º–µ—Å—Ç–æ flex
    changeTypeModal.style.display = 'block';
    modalOverlay.style.display = 'block';
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è —á—Ç–æ–±—ã –Ω–µ –∫–ª–∏–∫–∞–ª–æ—Å—å –ø–æ–¥ –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º
    map.getContainer().style.pointerEvents = 'none';
}

function closeChangeTypeModal() {
    changeTypeModal.style.display = 'none';
    modalOverlay.style.display = 'none';
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ
    map.getContainer().style.pointerEvents = 'auto';
    
    // –£–ë–ò–†–ê–ï–ú –í–´–î–ï–õ–ï–ù–ò–ï –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ
    if (selectedTargetForChange && selectedTargetForChange.getElement()) {
        selectedTargetForChange.getElement().style.filter = '';
    }
    
    selectedTargetForChange = null;
    selectedNewIcon = null;
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    mode = null;
    selectedTarget = null;
}

function confirmChangeType() {
    if (!selectedTargetForChange || !selectedNewIcon) {
        showNotification('‚ùå –í–∏–±–µ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π —Ç–∏–ø —Ü—ñ–ª—ñ');
        return;
    }
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
    selectedTargetForChange._iconPath = selectedNewIcon.icon;
    selectedTargetForChange._name = selectedNewIcon.name;
    selectedTargetForChange._speedKmph = selectedNewIcon.speed;
    selectedTargetForChange._moving = selectedNewIcon.speed > 0;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É
    updateTargetIcon(selectedTargetForChange);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫—É
    if (selectedTargetForChange._label && selectedTargetForChange._label.getElement()) {
        selectedTargetForChange._label.getElement().innerHTML = `<div>${selectedTargetForChange._name}</div>`;
    }
    
    // –£–ë–ò–†–ê–ï–ú –í–´–î–ï–õ–ï–ù–ò–ï —Å —Ü–µ–ª–∏
    if (selectedTargetForChange.getElement()) {
        selectedTargetForChange.getElement().style.filter = '';
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
    saveTargetsToStorage();
    
    showNotification(`‚úÖ –¢–∏–ø —Ü—ñ–ª—ñ –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞: ${selectedNewIcon.name}`);
    closeChangeTypeModal();
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º
    mode = null;
    selectedTarget = null;
    document.querySelectorAll('.leaflet-control-custom').forEach(ctrl => {
        ctrl.classList.remove('active');
    });
}

/* === –§—É–Ω–∫—Ü–∏–∏ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞ === */
function startTeleportMode() {
    resetAllModes();
    
    teleportMode = !teleportMode;
    teleportBtn.classList.toggle('active', teleportMode);
    
    if (teleportMode) {
        showNotification('üî¥ –í–∏–¥—ñ–ª—ñ—Ç—å —Ü—ñ–ª—å –¥–ª—è —Ç–µ–ª–µ–ø–æ—Ä—Ç—É');
    } else {
        if (teleportTarget && teleportTarget.getElement()) {
            teleportTarget.getElement().style.filter = '';
        }
        teleportTarget = null;
    }
}

function openTeleportModal(target) {
    teleportTarget = target;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ü–µ–ª–∏
    document.getElementById('teleportTargetName').textContent = target._name;
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è
    document.getElementById('teleportMinutes').value = 0;
    document.getElementById('teleportSeconds').value = 0;
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∂–∏–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    document.getElementById('teleportMoveMode').classList.add('active');
    document.getElementById('teleportStopMode').classList.remove('active');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    teleportModal.style.display = 'block';
    modalOverlay.style.display = 'block';
    
    map.getContainer().style.pointerEvents = 'none';
}

function closeTeleportModal() {
    teleportModal.style.display = 'none';
    modalOverlay.style.display = 'none';
    
    map.getContainer().style.pointerEvents = 'auto';
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
    if (teleportTarget && teleportTarget.getElement()) {
        teleportTarget.getElement().style.filter = '';
    }
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º
    teleportMode = false;
    teleportBtn.classList.remove('active');
    teleportTarget = null;
}

function applyTeleport() {
    if (!teleportTarget) {
        showNotification('‚ùå –¶—ñ–ª—å –Ω–µ –≤–∏–±—Ä–∞–Ω–∞');
        return;
    }
    
    const minutes = parseInt(document.getElementById('teleportMinutes').value) || 0;
    const seconds = parseInt(document.getElementById('teleportSeconds').value) || 0;
    const totalSeconds = minutes * 60 + seconds;
    
    if (totalSeconds <= 0) {
        showNotification('‚ùå –í–≤–µ–¥—ñ—Ç—å —á–∞—Å —Ç–µ–ª–µ–ø–æ—Ä—Ç—É');
        return;
    }
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º –ø–æ—Å–ª–µ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞
    const moveAfterTeleport = document.getElementById('teleportMoveMode').classList.contains('active');
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é
    const newPosition = calculateFuturePosition(teleportTarget, totalSeconds);
    
    // –¢–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ü–µ–ª—å
    teleportTargetTo(teleportTarget, newPosition, moveAfterTeleport);
    
    showNotification(`‚úÖ –¶—ñ–ª—å —Ç–µ–ª–µ–ø–æ—Ä—Ç–æ–≤–∞–Ω–∞ –Ω–∞ ${minutes} —Ö–≤ ${seconds} —Å–µ–∫ –≤–ø–µ—Ä–µ–¥`);
    closeTeleportModal();
}

function calculateFuturePosition(target, timeSeconds) {
    if (target._speedKmph <= 0 || timeSeconds <= 0) {
        return target.getLatLng();
    }
    
    const speedMs = (target._speedKmph * 1000) / 3600;
    const distance = speedMs * timeSeconds;
    const theta = target._course * Math.PI / 180;
    
    const dy = Math.cos(theta) * distance;
    const dx = Math.sin(theta) * distance;
    const currentPos = target.getLatLng();
    
    const newLat = currentPos.lat + metersToLat(dy);
    const newLng = currentPos.lng + metersToLng(dx, currentPos.lat);
    
    return L.latLng(newLat, newLng);
}

function teleportTargetTo(target, newPosition, moveAfterTeleport = true) {
    const oldPosition = target.getLatLng();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –º–∞—Ä–∫–µ—Ä–∞
    target.setLatLng(newPosition);
    target._currentPos = newPosition;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫—É
    if (target._label) {
        target._label.setLatLng(newPosition);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫—Ä—É–≥ —É–≥—Ä–æ–∑—ã
    if (target._isThreat && target._threatCircle) {
        target._threatCircle.setLatLng(newPosition);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é - –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫—É —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞
    if (target._polyline) {
        const currentPoints = target._polyline.getLatLngs();
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑—Ä—ã–≤ –≤ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞
        if (currentPoints.length > 0) {
            const lastPoint = currentPoints[currentPoints.length - 1];
            currentPoints.push(lastPoint); // –î—É–±–ª–∏—Ä—É–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç–æ—á–∫—É –¥–ª—è —Ä–∞–∑—Ä—ã–≤–∞
        }
        
        currentPoints.push(newPosition);
        target._polyline.setLatLngs(currentPoints);
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∂–∏–º –¥–≤–∏–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞
    if (!moveAfterTeleport) {
        const originalSpeed = target._speedKmph;
        target._speedKmph = 0;
        target._moving = false;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
        setTimeout(() => {
            showNotification(`üõë –¶—ñ–ª—å "${target._name}" –∑—É–ø–∏–Ω–µ–Ω–∞ –ø—ñ—Å–ª—è —Ç–µ–ª–µ–ø–æ—Ä—Ç—É`);
        }, 1000);
    }
    
    saveTargetsToStorage();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–∏–Ω–∏—é —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ
    const teleportLine = L.polyline([oldPosition, newPosition], {
        color: '#ff00ff',
        weight: 3,
        opacity: 0.7,
        dashArray: '10,5'
    }).addTo(map);
    
    // –£–±–∏—Ä–∞–µ–º –ª–∏–Ω–∏—é —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        if (map.hasLayer(teleportLine)) {
            map.removeLayer(teleportLine);
        }
    }, 3000);
}

// === –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å—Ç–∏–ª—è –∫–∞—Ä—Ç—ã ===
function switchMapStyle(style) {
  if (!map) return;

  // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Å–ª–æ–π
  if (map.hasLayer(defaultTileLayer)) map.removeLayer(defaultTileLayer);
  if (map.hasLayer(jawgTileLayer)) map.removeLayer(jawgTileLayer);

  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
  if (style === 'jawg') {
    jawgTileLayer.addTo(map);
    currentMapStyle = 'jawg';
  } else {
    defaultTileLayer.addTo(map);
    currentMapStyle = 'default';
  }

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä
  localStorage.setItem('mapStyle', currentMapStyle);

  console.log(`‚úÖ –ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∏–ª—å –∫–∞—Ä—Ç–∏: ${currentMapStyle}`);
}

// === –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º radio-–∫–Ω–æ–ø–∫–∏ ===
window.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('input[name="mapStyle"]').forEach(radio => {
    radio.addEventListener('change', e => {
      switchMapStyle(e.target.value);
    });
  });

  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å—Ç–∏–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  const savedStyle = localStorage.getItem('mapStyle') || 'default';
  switchMapStyle(savedStyle);
  const savedRadio = document.querySelector(`input[name="mapStyle"][value="${savedStyle}"]`);
  if (savedRadio) savedRadio.checked = true;
});
</script>
</body>
</html>