<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ú–∞–ø–∞ ‚Äî —Ü—ñ–ª—ñ</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{height:100%;margin:0}
#map{width:100%;height:100vh}

/* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –≤–≤–µ—Ä—Ö—É */
.leaflet-top.leaflet-left {
  display: flex;
  flex-direction: row;
  gap: 5px;
  margin: 10px;
}

.leaflet-control-custom{
  background:white;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,0.3);
  width:32px;height:32px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:18px;transition:0.15s
}
.leaflet-control-custom:hover{background:#f0f0f0}
.leaflet-control-custom.active{background:#cce5ff}
.preview-icon{font-size:18px;opacity:0.8;transform-origin:center}
#iconMenu{
  position:absolute;top:10px;right:10px;z-index:1000;
  background:white;padding:10px;border-radius:8px;
  box-shadow:0 1px 5px rgba(0,0,0,0.3);
  display:none;flex-direction:column;gap:8px;
  font-family:sans-serif;font-size:14px;
}
#iconMenu img{width:28px;height:28px;cursor:pointer;transition:0.15s}
#iconMenu img:hover{transform:scale(1.1)}
#speedInput{
  width:100%;padding:4px;margin-top:6px;
  border:1px solid #ccc;border-radius:6px;font-size:14px
}
#toggleMenu{
  position:absolute;top:10px;right:10px;z-index:1001;
  background:white;color:black;border:1px solid #ccc;border-radius:6px;
  width:36px;height:36px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;
}

/* Trajectory controls in menu */
.traj-section { border-top:1px solid #eee; padding-top:6px; margin-top:4px; }
.traj-controls { display:flex; gap:6px; margin-top:6px; }
.traj-controls button { padding:6px 8px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer; }
.traj-controls button.active { background:#00c6ff; color:#fff; border-color:#00a0d6; }
.traj-row { display:flex; gap:6px; align-items:center; }
.traj-row input[type="number"]{ width:60px; padding:4px; border-radius:4px; border:1px solid #ccc; }
.traj-row label{ font-size:13px; }
</style>
</head>
<body>
<div id="map"></div>

<button id="toggleMenu">‚öô</button>

<div id="iconMenu">
  <b>–Ü–∫–æ–Ω–∫–∞</b>
  <div>
    <img src="icons/shahed.png" data-icon="icons/shahed.png" title="–®–∞—Ö–µ–¥">
    <img src="icons/rocket.png" data-icon="icons/rocket.png" title="–†–∞–∫–µ—Ç–∞">
    <img src="icons/plane.png" data-icon="icons/plane.png" title="–õ—ñ—Ç–∞–∫">
    <img src="icons/kab.png" data-icon="icons/kab.png" title="–ö–ê–ë">
    <img src="icons/recon.png" data-icon="icons/recon.png" title="–†–æ–∑–≤—ñ–¥–Ω–∏–∫">
    <img src="icons/ballistic.png" data-icon="icons/ballistic.png" title="–ë–∞–ª—ñ—Å—Ç–∏—á–Ω–∞">
  </div>

  <b>–®–≤–∏–¥–∫—ñ—Å—Ç—å (–∫–º/–≥–æ–¥)</b>
  <input type="number" id="speedInput" min="0" max="100000" placeholder="–í–≤–µ–¥–∏ –≤—Ä—É—á–Ω—É">

  <div class="traj-section">
    <b>–¢—Ä–∞—î–∫—Ç–æ—Ä—ñ—è</b>
    <div class="traj-controls">
      <button id="trajSolidBtn" class="active">–°—É—Ü—ñ–ª—å–Ω–∞</button>
      <button id="trajDashBtn">–ü—É–Ω–∫—Ç–∏—Ä–Ω–∞</button>
    </div>
    <div class="traj-row">
      <label>–ö–æ–ª—ñ—Ä</label>
      <input id="trajColor" type="color" value="#00a0ff">
    </div>
    <div class="traj-row">
      <label>–®–∏—Ä–∏–Ω–∞</label>
      <input id="trajWidth" type="number" min="1" max="10" value="2">
      <label>–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å</label>
      <input id="trajOpacity" type="number" min="0" max="1" step="0.1" value="0.9" style="width:60px">
    </div>
  </div>
</div>

<script>
/* === –ù–∞—á–∞–ª–æ —Ç–≤–æ–µ–≥–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ (–Ω–µ –º–µ–Ω—è–ª –ª–æ–≥–∏–∫—É) === */
const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([49.0, 31.0], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '',
  detectRetina: true,
  updateWhenIdle: false,
  keepBuffer: 2,
  className: 'ukraine-map-tiles light-theme'
}).addTo(map);

/* === –û–¢–ö–õ–Æ–ß–ï–ù–ò–ï –î–í–û–ô–ù–û–ì–û –ö–õ–ò–ö–ê –ó–£–ú–ê === */
map.doubleClickZoom.disable();
map.on('dblclick', function(e) {
    e.originalEvent.preventDefault();
    e.originalEvent.stopPropagation();
});

let mode = null;
let firstClickLatLng = null;
let previewMarker = null;
let selectedIcon = 'icons/shahed.png';
let selectedSpeed = 0;
let selectedTarget = null;
const targets = []; // markers
/* === –ö–æ–Ω–µ—Ü –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ === */

/* === –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ë—ã—Å—Ç—Ä–∞—è —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è === */
let quickTrajectoryMode = false;
let quickTrajectoryPoints = [];
let quickTrajectoryPolyline = null;
let previousTargetSpeed = null; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å —Ü–µ–ª–∏ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ —Ä–∏—Å–æ–≤–∞–Ω–∏—è

function startQuickTrajectory() {
    if (quickTrajectoryMode) {
        // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–µ–∂–∏–º –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é
        if (selectedTarget && quickTrajectoryPoints.length > 1) {
            applyQuickTrajectory();
        }
        
        // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–µ–∂–∏–º
        quickTrajectoryMode = false;
        quickTrajectoryBtn.classList.remove('active');
        
        // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        if (quickTrajectoryPolyline) {
            map.removeLayer(quickTrajectoryPolyline);
            quickTrajectoryPolyline = null;
        }
        quickTrajectoryPoints = [];
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å —Ü–µ–ª–∏ (–µ—Å–ª–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∏ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é)
        if (selectedTarget && previousTargetSpeed !== null) {
            selectedTarget._speedKmph = previousTargetSpeed;
            selectedTarget._moving = selectedTarget._speedKmph > 0;
            previousTargetSpeed = null;
        }
        
        // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å —Ü–µ–ª–∏
        if (selectedTarget && selectedTarget.getElement()) {
            selectedTarget.getElement().style.filter = '';
        }
        selectedTarget = null;
        
    } else {
        // –ù–∞—á–∏–Ω–∞–µ–º —Ä–µ–∂–∏–º –±—ã—Å—Ç—Ä–æ–π —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏
        quickTrajectoryMode = true;
        quickTrajectoryBtn.classList.add('active');
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ —Ä–µ–∂–∏–º—ã
        mode = null;
        clearPreview();
        document.querySelectorAll('.leaflet-control-custom').forEach(el => {
            if(el !== quickTrajectoryBtn && el !== trajSelEl) el.classList.remove('active');
        });
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Ü–µ–ª—å (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å
        if (selectedTarget) {
            previousTargetSpeed = selectedTarget._speedKmph; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å
            selectedTarget._speedKmph = 0;
            selectedTarget._moving = false;
            selectedTarget.getElement().style.filter = 'drop-shadow(0 0 6px red)';
            
            // –ù–∞—á–∏–Ω–∞–µ–º —Å —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏ —Ü–µ–ª–∏
            quickTrajectoryPoints = [selectedTarget.getLatLng()];
        } else {
            quickTrajectoryPoints = [];
        }
        
        // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–æ–ª–∏–ª–∏–Ω–∏—é
        quickTrajectoryPolyline = L.polyline(quickTrajectoryPoints, {
            color: '#ff0000',
            weight: 3,
            opacity: 0.7,
            dashArray: '5,5'
        }).addTo(map);
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ü–µ–ª–∏
function applyQuickTrajectory() {
    if (!selectedTarget || quickTrajectoryPoints.length < 2) return;
    
    const lastPoint = quickTrajectoryPoints[quickTrajectoryPoints.length - 1];
    const secondLastPoint = quickTrajectoryPoints[quickTrajectoryPoints.length - 2];
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫—É—Ä—Å –æ—Ç –ø—Ä–µ–¥–ø–æ—Å–ª–µ–¥–Ω–µ–π –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç–æ—á–∫–µ
    const bearing = bearingDegrees(secondLastPoint, lastPoint);
    
    // –¢–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ü–µ–ª—å –≤ –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç–æ—á–∫—É
    selectedTarget.setLatLng(lastPoint);
    selectedTarget._currentPos = lastPoint;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫—É—Ä—Å (—Ü–µ–ª—å —Å–º–æ—Ç—Ä–∏—Ç –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–ª–∏–∫–∞)
    selectedTarget._course = bearing;
    selectedTarget.setIcon(L.divIcon({
        className: 'target-icon',
        html: `<img src="${selectedTarget._iconPath}" style="width:28px;height:28px;transform:rotate(${bearing}deg);transform-origin:center center;">`,
        iconSize: [28, 28],
        iconAnchor: [14, 14]
    }));
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–µ–ª—å (–Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å)
    selectedTarget._speedKmph = 0;
    selectedTarget._moving = false;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π (–Ω–µ –∑–∞–º–µ–Ω—è–µ–º!)
    if (selectedTarget._polyline) {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Ç–æ—á–∫–∏ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏
        const currentPoints = selectedTarget._polyline.getLatLngs();
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ç–æ—á–∫–∏ (–∏—Å–∫–ª—é—á–∞—è –ø–µ—Ä–≤—É—é, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å)
        const newPoints = currentPoints.concat(quickTrajectoryPoints.slice(1));
        selectedTarget._polyline.setLatLngs(newPoints);
    } else {
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –µ—ë –Ω–µ –±—ã–ª–æ
        selectedTarget._polyline = L.polyline(quickTrajectoryPoints, getPolylineOptions());
        if (showAllTrajectories) selectedTarget._polyline.addTo(map);
    }
    
    previousTargetSpeed = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å
    saveTargetsToStorage();
}

/* === –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ü–µ–ª–∏ === */
let showSelectedTrajectoryMode = false;

function toggleSelectedTrajectory() {
    if (showSelectedTrajectoryMode) {
        // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ä–µ–∂–∏–º–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏
        showSelectedTrajectoryMode = false;
        trajSelEl.classList.remove('active');
        
        // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å —Ü–µ–ª–∏
        if (selectedTarget && selectedTarget.getElement()) {
            selectedTarget.getElement().style.filter = '';
        }
        selectedTarget = null;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏
        targets.forEach(t => {
            if (t._polyline && !map.hasLayer(t._polyline)) {
                map.addLayer(t._polyline);
            }
        });
        
    } else {
        // –í—Ö–æ–¥–∏–º –≤ —Ä–µ–∂–∏–º –ø–æ–∫–∞–∑–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏
        showSelectedTrajectoryMode = true;
        trajSelEl.classList.add('active');
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ —Ä–µ–∂–∏–º—ã
        mode = null;
        quickTrajectoryMode = false;
        quickTrajectoryBtn.classList.remove('active');
        document.querySelectorAll('.leaflet-control-custom').forEach(el => {
            if(el !== trajSelEl) el.classList.remove('active');
        });
        
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏
        targets.forEach(t => {
            if (t._polyline && map.hasLayer(t._polyline)) {
                map.removeLayer(t._polyline);
            }
        });
    }
}

/* === Trajectory storage and global settings === */
let showAllTrajectories = true;

const trajSettings = {
  dash: false,
  color: '#00a0ff',
  weight: 2,
  opacity: 0.9
};

/* === LOCAL STORAGE FUNCTIONS === */
function saveTargetsToStorage() {
  const data = targets.map(target => {
    return {
      lat: target._currentPos.lat,
      lng: target._currentPos.lng,
      course: target._course,
      speed: target._speedKmph,
      icon: target._iconPath,
      trajectory: target._polyline ? target._polyline.getLatLngs() : []
    };
  });
  localStorage.setItem('mapTargets', JSON.stringify(data));
}

function loadTargetsFromStorage() {
  const saved = localStorage.getItem('mapTargets');
  if (saved) {
    try {
      const data = JSON.parse(saved);
      data.forEach(targetData => {
        const latLng = L.latLng(targetData.lat, targetData.lng);
        restoreTarget(latLng, targetData.course, targetData.speed, targetData.icon, targetData.trajectory);
      });
    } catch (e) {
      console.error('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è —Ü—ñ–ª–µ–π:', e);
    }
  }
}

function restoreTarget(positionLatLng, bearingDeg, speed, iconPath, trajectory) {
  const icon = L.divIcon({
    className: 'target-icon',
    html: `<img src="${iconPath}" style="width:28px;height:28px;transform:rotate(${bearingDeg}deg);transform-origin:center center;">`,
    iconSize: [28, 28],
    iconAnchor: [14, 14]
  });
  
  const marker = L.marker(positionLatLng, { icon }).addTo(map);
  marker._course = bearingDeg;
  marker._speedKmph = speed || 0;
  marker._moving = marker._speedKmph > 0;
  marker._currentPos = positionLatLng;
  marker._iconPath = iconPath;

  const polyline = L.polyline(trajectory.length > 0 ? trajectory : [positionLatLng], getPolylineOptions());
  marker._polyline = polyline;
  
  if (showAllTrajectories && !showSelectedTrajectoryMode) polyline.addTo(map);

  marker.on('click', () => {
    if (quickTrajectoryMode) {
        // –ï—Å–ª–∏ –≤ —Ä–µ–∂–∏–º–µ –±—ã—Å—Ç—Ä–æ–π —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ - –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ü–µ–ª—å
        if (selectedTarget && selectedTarget.getElement()) {
            selectedTarget.getElement().style.filter = '';
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ü–µ–ª–∏
            if (previousTargetSpeed !== null) {
                selectedTarget._speedKmph = previousTargetSpeed;
                selectedTarget._moving = selectedTarget._speedKmph > 0;
            }
        }
        selectedTarget = marker;
        marker.getElement().style.filter = 'drop-shadow(0 0 6px red)';
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—É—é –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ü–µ–ª—å
        previousTargetSpeed = selectedTarget._speedKmph;
        selectedTarget._speedKmph = 0;
        selectedTarget._moving = false;
        
        // –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —ç—Ç–æ–π —Ü–µ–ª–∏
        quickTrajectoryPoints = [selectedTarget.getLatLng()];
        if (quickTrajectoryPolyline) {
            quickTrajectoryPolyline.setLatLngs(quickTrajectoryPoints);
        }
        return;
    }
    
    if (showSelectedTrajectoryMode) {
        // –ï—Å–ª–∏ –≤ —Ä–µ–∂–∏–º–µ –ø–æ–∫–∞–∑–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏
        if (selectedTarget && selectedTarget.getElement()) {
            selectedTarget.getElement().style.filter = '';
            // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é
            if (selectedTarget._polyline && map.hasLayer(selectedTarget._polyline)) {
                map.removeLayer(selectedTarget._polyline);
            }
        }
        selectedTarget = marker;
        marker.getElement().style.filter = 'drop-shadow(0 0 6px green)';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ü–µ–ª–∏
        if (selectedTarget._polyline && !map.hasLayer(selectedTarget._polyline)) {
            map.addLayer(selectedTarget._polyline);
        }
        return;
    }
    
    if (mode === 'delete') {
      if (marker._polyline) {
        if (map.hasLayer(marker._polyline)) map.removeLayer(marker._polyline);
        marker._polyline = null;
      }
      const idx = targets.indexOf(marker);
      if (idx !== -1) targets.splice(idx, 1);
      map.removeLayer(marker);
      saveTargetsToStorage();
    } else if (mode === 'course') {
      if (selectedTarget && selectedTarget.getElement()) selectedTarget.getElement().style.filter = '';
      selectedTarget = marker;
      marker.getElement().style.filter = 'drop-shadow(0 0 4px blue)';
    } else if (mode === 'speed') {
      if (selectedTarget && selectedTarget.getElement()) selectedTarget.getElement().style.filter = '';
      selectedTarget = marker;
      marker.getElement().style.filter = 'drop-shadow(0 0 4px blue)';
      const newSpeed = prompt("–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤—É —à–≤–∏–¥–∫—ñ—Å—Ç—å (–∫–º/–≥–æ–¥):", marker._speedKmph);
      if (newSpeed !== null) {
        const sp = parseFloat(newSpeed);
        if (!isNaN(sp)) {
          marker._speedKmph = Math.max(0, Math.min(sp, 100000));
          marker._moving = marker._speedKmph > 0;
          saveTargetsToStorage();
        }
      }
    }
  });

  targets.push(marker);
}

function getPolylineOptions() {
  return {
    color: trajSettings.color,
    weight: trajSettings.weight,
    opacity: trajSettings.opacity,
    dashArray: trajSettings.dash ? '6,6' : null
  };
}

function bearingDegrees(fromLatLng,toLatLng){
  const toRad = d=>d*Math.PI/180;
  const toDeg = r=>r*180/Math.PI;
  const œÜ1=toRad(fromLatLng.lat);
  const œÜ2=toRad(toLatLng.lat);
  const ŒîŒª=toRad(toLatLng.lng - fromLatLng.lng);
  const y=Math.sin(ŒîŒª)*Math.cos(œÜ2);
  const x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);
  return (toDeg(Math.atan2(y,x))+360)%360;
}

function clearPreview(){firstClickLatLng=null;if(previewMarker){map.removeLayer(previewMarker);previewMarker=null;}}

/* === Controls –≤ –Ω–æ–≤–æ–º –ø–æ—Ä—è–¥–∫–µ === */
const AddControl=L.Control.extend({options:{position:'topleft'},onAdd(){ 
  const el=L.DomUtil.create('div','leaflet-control leaflet-control-custom'); 
  el.innerHTML='‚ûï';el.title='–î–æ–¥–∞—Ç–∏ —Ü—ñ–ª—å';
  L.DomEvent.on(el,'click',ev=>{
    L.DomEvent.stopPropagation(ev);L.DomEvent.preventDefault(ev);
    mode=(mode==='add')?null:'add';el.classList.toggle('active');
    document.querySelectorAll('.leaflet-control-custom').forEach(ctrl => {
      if(ctrl !== el) ctrl.classList.remove('active');
    });
    quickTrajectoryMode = false;
    quickTrajectoryBtn.classList.remove('active');
    showSelectedTrajectoryMode = false;
    trajSelEl.classList.remove('active');
    if (selectedTarget && selectedTarget.getElement()) selectedTarget.getElement().style.filter = '';
    selectedTarget = null;
    clearPreview();
  });return el;
}});

const QuickTrajectoryControl=L.Control.extend({options:{position:'topleft'},onAdd(){ 
  const el=L.DomUtil.create('div','leaflet-control leaflet-control-custom'); 
  el.innerHTML='üéØ';el.title='–®–≤–∏–¥–∫–∞ —Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—è (–≤–∏–¥—ñ–ª—ñ—Ç—å —Ü—ñ–ª—å, –∫–ª–∞—Ü–∞–π—Ç–µ –ø–æ –∫–∞—Ä—Ç—ñ, –ø–æ—Ç—ñ–º –∑–Ω–æ–≤—É –∫–Ω–æ–ø–∫—É)';
  L.DomEvent.on(el,'click',function(ev) {
    L.DomEvent.stopPropagation(ev);L.DomEvent.preventDefault(ev);
    startQuickTrajectory();
  });
  return el;
}});

const CourseControl=L.Control.extend({options:{position:'topleft'},onAdd(){
  const el=L.DomUtil.create('div','leaflet-control leaflet-control-custom');
  el.innerHTML='üß≠';el.title='–ó–º—ñ–Ω–∏—Ç–∏ –∫—É—Ä—Å';
  L.DomEvent.on(el,'click',ev=>{
    L.DomEvent.stopPropagation(ev);L.DomEvent.preventDefault(ev);
    const isActive = el.classList.toggle('active');
    mode = isActive ? 'course' : null;
    document.querySelectorAll('.leaflet-control-custom').forEach(ctrl => {
      if(ctrl !== el) ctrl.classList.remove('active');
    });
    quickTrajectoryMode = false;
    quickTrajectoryBtn.classList.remove('active');
    showSelectedTrajectoryMode = false;
    trajSelEl.classList.remove('active');
    if(!isActive && selectedTarget && selectedTarget.getElement()) {
      selectedTarget.getElement().style.filter='';
      selectedTarget=null;
    }
    clearPreview();
  });return el;
}});

const SpeedControl=L.Control.extend({options:{position:'topleft'},onAdd(){
  const el=L.DomUtil.create('div','leaflet-control leaflet-control-custom');
  el.innerHTML='‚ö°';el.title='–ó–º—ñ–Ω–∏—Ç–∏ —à–≤–∏–¥–∫—ñ—Å—Ç—å';
  L.DomEvent.on(el,'click',ev=>{
    L.DomEvent.stopPropagation(ev);L.DomEvent.preventDefault(ev);
    const isActive = el.classList.toggle('active');
    mode = isActive ? 'speed' : null;
    document.querySelectorAll('.leaflet-control-custom').forEach(ctrl => {
      if(ctrl !== el) ctrl.classList.remove('active');
    });
    quickTrajectoryMode = false;
    quickTrajectoryBtn.classList.remove('active');
    showSelectedTrajectoryMode = false;
    trajSelEl.classList.remove('active');
    if(!isActive && selectedTarget && selectedTarget.getElement()){
      selectedTarget.getElement().style.filter='';
      selectedTarget=null;
    }
    clearPreview();
  });return el;
}});

const DeleteControl=L.Control.extend({options:{position:'topleft'},onAdd(){
  const el=L.DomUtil.create('div','leaflet-control leaflet-control-custom');
  el.innerHTML='üóëÔ∏è';el.title='–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—ñ–ª—å';
  L.DomEvent.on(el,'click',ev=>{
    L.DomEvent.stopPropagation(ev);L.DomEvent.preventDefault(ev);
    mode=(mode==='delete')?null:'delete';el.classList.toggle('active');
    document.querySelectorAll('.leaflet-control-custom').forEach(ctrl => {
      if(ctrl !== el) ctrl.classList.remove('active');
    });
    quickTrajectoryMode = false;
    quickTrajectoryBtn.classList.remove('active');
    showSelectedTrajectoryMode = false;
    trajSelEl.classList.remove('active');
    clearPreview();
  });return el;
}});

const TrajAllControl=L.Control.extend({options:{position:'topleft'},onAdd(){
  const el=L.DomUtil.create('div','leaflet-control leaflet-control-custom');
  el.innerHTML='üìà';el.title='–ü–æ–∫–∞–∑–∞—Ç–∏/–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤—Å—ñ —Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—ó';
  L.DomEvent.on(el,'click',ev=>{
    L.DomEvent.stopPropagation(ev);L.DomEvent.preventDefault(ev);
    const isActive = el.classList.toggle('active');
    showAllTrajectories = isActive;
    if (!showSelectedTrajectoryMode) {
        targets.forEach(t => {
            if(t._polyline){
                if(showAllTrajectories) {
                    if(!map.hasLayer(t._polyline)) map.addLayer(t._polyline);
                } else {
                    if(map.hasLayer(t._polyline)) map.removeLayer(t._polyline);
                }
            }
        });
    }
  });return el;
}});

const TrajSelControl=L.Control.extend({options:{position:'topleft'},onAdd(){
  const el=L.DomUtil.create('div','leaflet-control leaflet-control-custom');
  el.innerHTML='üîç';el.title='–ü–æ–∫–∞–∑–∞—Ç–∏ —Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—é –≤–∏–±—Ä–∞–Ω–æ—ó —Ü—ñ–ª—ñ';
  L.DomEvent.on(el,'click',function(ev) {
    L.DomEvent.stopPropagation(ev);L.DomEvent.preventDefault(ev);
    toggleSelectedTrajectory();
  });
  return el;
}});

// –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—ã –≤ –Ω–æ–≤–æ–º –ø–æ—Ä—è–¥–∫–µ
map.addControl(new AddControl());
map.addControl(new QuickTrajectoryControl());
map.addControl(new CourseControl());
map.addControl(new SpeedControl());
map.addControl(new DeleteControl());
map.addControl(new TrajAllControl());
map.addControl(new TrajSelControl());

const addControlEl=document.querySelector('.leaflet-control-custom:nth-of-type(1)');
const quickTrajectoryBtn=document.querySelector('.leaflet-control-custom:nth-of-type(2)');
const courseControlEl=document.querySelector('.leaflet-control-custom:nth-of-type(3)');
const speedControlEl=document.querySelector('.leaflet-control-custom:nth-of-type(4)');
const deleteControlEl=document.querySelector('.leaflet-control-custom:nth-of-type(5)');
const trajAllEl=document.querySelector('.leaflet-control-custom:nth-of-type(6)');
const trajSelEl=document.querySelector('.leaflet-control-custom:nth-of-type(7)');

function createTarget(positionLatLng,bearingDeg){
  const icon=L.divIcon({
    className:'target-icon',
    html:`<img src="${selectedIcon}" style="width:28px;height:28px;transform:rotate(${bearingDeg}deg);transform-origin:center center;">`,
    iconSize:[28,28],
    iconAnchor:[14,14]
  });
  const marker=L.marker(positionLatLng,{icon}).addTo(map);
  marker._course=bearingDeg;
  marker._speedKmph=selectedSpeed||0;
  marker._moving=marker._speedKmph>0;
  marker._currentPos=positionLatLng;
  marker._iconPath=selectedIcon;

  const polyline = L.polyline([positionLatLng], getPolylineOptions());
  marker._polyline = polyline;
  if(showAllTrajectories && !showSelectedTrajectoryMode) polyline.addTo(map);

  marker.on('click',()=>{
    if (quickTrajectoryMode) {
        // –ï—Å–ª–∏ –≤ —Ä–µ–∂–∏–º–µ –±—ã—Å—Ç—Ä–æ–π —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ - –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ü–µ–ª—å
        if (selectedTarget && selectedTarget.getElement()) {
            selectedTarget.getElement().style.filter = '';
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ü–µ–ª–∏
            if (previousTargetSpeed !== null) {
                selectedTarget._speedKmph = previousTargetSpeed;
                selectedTarget._moving = selectedTarget._speedKmph > 0;
            }
        }
        selectedTarget = marker;
        marker.getElement().style.filter = 'drop-shadow(0 0 6px red)';
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—É—é –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ü–µ–ª—å
        previousTargetSpeed = selectedTarget._speedKmph;
        selectedTarget._speedKmph = 0;
        selectedTarget._moving = false;
        
        // –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —ç—Ç–æ–π —Ü–µ–ª–∏
        quickTrajectoryPoints = [selectedTarget.getLatLng()];
        if (quickTrajectoryPolyline) {
            quickTrajectoryPolyline.setLatLngs(quickTrajectoryPoints);
        }
        return;
    }
    
    if (showSelectedTrajectoryMode) {
        // –ï—Å–ª–∏ –≤ —Ä–µ–∂–∏–º–µ –ø–æ–∫–∞–∑–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏
        if (selectedTarget && selectedTarget.getElement()) {
            selectedTarget.getElement().style.filter = '';
            // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é
            if (selectedTarget._polyline && map.hasLayer(selectedTarget._polyline)) {
                map.removeLayer(selectedTarget._polyline);
            }
        }
        selectedTarget = marker;
        marker.getElement().style.filter = 'drop-shadow(0 0 6px green)';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ü–µ–ª–∏
        if (selectedTarget._polyline && !map.hasLayer(selectedTarget._polyline)) {
            map.addLayer(selectedTarget._polyline);
        }
        return;
    }
    
    if(mode==='delete'){
      if(marker._polyline){
        if(map.hasLayer(marker._polyline)) map.removeLayer(marker._polyline);
        marker._polyline = null;
      }
      const idx=targets.indexOf(marker);
      if(idx!==-1) targets.splice(idx,1);
      map.removeLayer(marker);
      saveTargetsToStorage();
    } else if(mode==='course'){
      if(selectedTarget && selectedTarget.getElement()) selectedTarget.getElement().style.filter='';
      selectedTarget=marker;
      marker.getElement().style.filter='drop-shadow(0 0 4px blue)';
    } else if(mode==='speed'){
      if(selectedTarget && selectedTarget.getElement()) selectedTarget.getElement().style.filter='';
      selectedTarget=marker;
      marker.getElement().style.filter='drop-shadow(0 0 4px blue)';
      const newSpeed = prompt("–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤—É —à–≤–∏–¥–∫—ñ—Å—Ç—å (–∫–º/–≥–æ–¥):", marker._speedKmph);
      if(newSpeed !== null){
        const sp = parseFloat(newSpeed);
        if(!isNaN(sp)){
          marker._speedKmph = Math.max(0, Math.min(sp, 100000));
          marker._moving = marker._speedKmph > 0;
          saveTargetsToStorage();
        }
      }
    }
  });

  targets.push(marker);
  saveTargetsToStorage();
}

/* === –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–∞—Ä—Ç–µ === */
map.on('click', function(e) {
    if (quickTrajectoryMode && selectedTarget) {
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫—É —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏
        quickTrajectoryPoints.push(e.latlng);
        if (quickTrajectoryPolyline) {
            quickTrajectoryPolyline.setLatLngs(quickTrajectoryPoints);
        }
        return;
    }
    
    // –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ü–µ–ª–µ–π –¥–≤—É–º—è –∫–ª–∏–∫–∞–º–∏
    if(mode==='add'){
        if(!firstClickLatLng){
            firstClickLatLng=e.latlng;
            previewMarker=L.marker(firstClickLatLng,{icon:L.divIcon({className:'preview-icon',html:'üìç',iconSize:[18,18],iconAnchor:[9,9]}),interactive:false}).addTo(map);
        } else{
            const bearing=bearingDegrees(firstClickLatLng,e.latlng);
            createTarget(firstClickLatLng,bearing);
            clearPreview();
        }
    } else if(mode==='course' && selectedTarget){
        const newBearing=bearingDegrees(selectedTarget.getLatLng(),e.latlng);
        selectedTarget._course=newBearing;
        selectedTarget.setIcon(L.divIcon({
            className:'target-icon',
            html:`<img src="${selectedTarget._iconPath}" style="width:28px;height:28px;transform:rotate(${newBearing}deg);transform-origin:center center;">`,
            iconSize:[28,28],
            iconAnchor:[14,14]
        }));
        saveTargetsToStorage();
    }
});

/* === Menu bindings === */
document.querySelectorAll('#iconMenu img').forEach(img=>{img.addEventListener('click',()=>{selectedIcon=img.dataset.icon;});});
document.getElementById('speedInput').addEventListener('input',e=>{selectedSpeed=Math.min(parseFloat(e.target.value)||0,100000);});
const toggleMenu=document.getElementById('toggleMenu');
const iconMenu=document.getElementById('iconMenu');
toggleMenu.onclick=()=>{iconMenu.style.display=(iconMenu.style.display==='none'?'flex':'none');};

const trajSolidBtn = document.getElementById('trajSolidBtn');
const trajDashBtn = document.getElementById('trajDashBtn');
const trajColor = document.getElementById('trajColor');
const trajWidth = document.getElementById('trajWidth');
const trajOpacity = document.getElementById('trajOpacity');

trajSolidBtn.addEventListener('click', ()=>{
  trajSettings.dash = false;
  trajSolidBtn.classList.add('active');
  trajDashBtn.classList.remove('active');
  updateAllPolylinesStyle();
});
trajDashBtn.addEventListener('click', ()=>{
  trajSettings.dash = true;
  trajDashBtn.classList.add('active');
  trajSolidBtn.classList.remove('active');
  updateAllPolylinesStyle();
});
trajColor.addEventListener('input', ()=>{ trajSettings.color = trajColor.value; updateAllPolylinesStyle(); });
trajWidth.addEventListener('input', ()=>{ trajSettings.weight = Math.max(1, Math.min(10, parseInt(trajWidth.value)||2)); updateAllPolylinesStyle(); });
trajOpacity.addEventListener('input', ()=>{ trajSettings.opacity = Math.max(0, Math.min(1, parseFloat(trajOpacity.value)||0.9)); updateAllPolylinesStyle(); });

function updateAllPolylinesStyle(){
  targets.forEach(t=>{
    if(t._polyline){
      const opts = getPolylineOptions();
      t._polyline.setStyle(opts);
    }
  });
}

/* === Movement loop === */
const MOVE_TICK_MS = 100;
function metersToLat(m){return m/111320;}
function metersToLng(m,lat){return m/(111320*Math.cos(lat*Math.PI/180));}

setInterval(()=>{
  if(!targets||targets.length===0) return;
  const dt = MOVE_TICK_MS/1000;
  targets.forEach(m=>{
    if(!m._moving||m._speedKmph<=0) return;
    const speedMs=(m._speedKmph*1000)/3600;
    const dist=speedMs*dt;
    const theta=m._course*Math.PI/180;
    const dy=Math.cos(theta)*dist;
    const dx=Math.sin(theta)*dist;
    const pos=m.getLatLng();
    const newLat=pos.lat+metersToLat(dy);
    const newLng=pos.lng+metersToLng(dx,pos.lat);
    m._currentPos=L.latLng(newLat,newLng);
    m.setLatLng(m._currentPos);

    if(m._polyline){
      m._polyline.addLatLng(m._currentPos);
      if(!showAllTrajectories && map.hasLayer(m._polyline) && !showSelectedTrajectoryMode) {
          map.removeLayer(m._polyline);
      }
    }
  });
}, MOVE_TICK_MS);

/* === AUTOSAVE === */
setInterval(() => {
  if (targets.length > 0) {
    saveTargetsToStorage();
  }
}, 1000);

/* === LOAD TARGETS ON PAGE LOAD === */
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(loadTargetsFromStorage, 100);
});

</script>
</body>
</html>
