<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ú–∞–ø–∞ ‚Äî —Ü—ñ–ª—ñ</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html,body{height:100%;margin:0}
    #map{width:100%;height:100vh}
    .leaflet-left .leaflet-control{margin-left:10px;margin-top:10px}
    .leaflet-control-custom{
      background:white;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,0.3);
      width:32px;height:32px;display:flex;align-items:center;justify-content:center;
      cursor:pointer;font-size:18px;transition:0.15s
    }
    .leaflet-control-custom:hover{background:#f0f0f0}
    .leaflet-control-custom.active{background:#cce5ff}

    /* –ü–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ –∏–∫–æ–Ω–æ–∫ */
    #iconPanel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.95);
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      padding: 10px;
      z-index: 9999;
      transition: 0.3s;
    }
    #iconPanel.hidden {transform: translateX(120%); opacity: 0;}
    #iconPanel h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      text-align: center;
    }
    .icon-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }
    .icon-option {
      width: 40px; height: 40px;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
      transition: 0.2s;
    }
    .icon-option img {
      width: 100%; height: 100%; object-fit: contain;
    }
    .icon-option:hover {transform: scale(1.05);}
    .icon-option.selected {border-color: #007bff;}

    #toggleMenu {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      width: 32px; height: 32px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; z-index: 10000;
      font-size: 18px;
      transition: 0.2s;
    }
    #toggleMenu:hover {background: #f0f0f0;}
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="toggleMenu">‚öôÔ∏è</div>

  <div id="iconPanel" class="hidden">
    <h4>–í–∏–±–µ—Ä–∏ —ñ–∫–æ–Ω–∫—É</h4>
    <div class="icon-grid" id="iconGrid"></div>
  </div>

  <script>
    // === –ö–∞—Ä—Ç–∞ ===
    const map = L.map('map').setView([49.0, 31.0], 6);

    window.lightLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      crossorigin: true,
      detectRetina: true,
      updateWhenIdle: false,
      keepBuffer: 2,
    }).addTo(map);

    // === –°—Ç–µ–π—Ç ===
    let mode = null;
    let firstClickLatLng = null;
    let previewMarker = null;
    const targets = [];

    const icons = [
      {id: 'shahed', name: '–®–∞—Ö–µ–¥', file: 'icons/shahed.png'},
      {id: 'rocket', name: '–†–∞–∫–µ—Ç–∞', file: 'icons/rocket.png'},
      {id: 'plane', name: '–õ—ñ—Ç–∞–∫', file: 'icons/plane.png'},
      {id: 'kab', name: '–ö–ê–ë', file: 'icons/kab.png'},
      {id: 'recon', name: '–†–æ–∑–≤—ñ–¥–Ω–∏–∫', file: 'icons/recon.png'},
      {id: 'ballistic', name: '–ë–∞–ª—ñ—Å—Ç–∏—á–Ω–∞', file: 'icons/ballistic.png'},
    ];

    let selectedIcon = localStorage.getItem('selectedIcon') || 'shahed';

    // === –£—Ç–∏–ª–∏—Ç–∞ ===
    function bearingDegrees(fromLatLng, toLatLng) {
      const toRad = deg => deg * Math.PI / 180;
      const toDeg = rad => rad * 180 / Math.PI;

      const œÜ1 = toRad(fromLatLng.lat);
      const œÜ2 = toRad(toLatLng.lat);
      const ŒîŒª = toRad(toLatLng.lng - fromLatLng.lng);

      const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
      const x = Math.cos(œÜ1)*Math.sin(œÜ2) - Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);
      return (toDeg(Math.atan2(y, x)) + 360) % 360;
    }

    function clearPreview() {
      firstClickLatLng = null;
      if (previewMarker) {
        map.removeLayer(previewMarker);
        previewMarker = null;
      }
    }

    function createTarget(positionLatLng, bearingDeg) {
      const iconData = icons.find(i => i.id === selectedIcon);
      const html = `
        <div style="transform: rotate(${bearingDeg}deg); transform-origin:center;">
          <img src="${iconData.file}" style="width:24px; height:24px; object-fit:contain;">
        </div>`;
      const icon = L.divIcon({
        className: 'target-icon',
        html,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });

      const marker = L.marker(positionLatLng, { icon, interactive: true }).addTo(map);

      marker.on('click', () => {
        if (mode === 'delete') {
          map.removeLayer(marker);
          const idx = targets.indexOf(marker);
          if (idx !== -1) targets.splice(idx, 1);
        }
      });

      targets.push(marker);
    }

    // === –ö–æ–Ω—Ç—Ä–æ–ª—ã ===
    const AddControl = L.Control.extend({
      options: { position: 'topleft' },
      onAdd() {
        const el = L.DomUtil.create('div', 'leaflet-control leaflet-control-custom');
        el.innerHTML = '‚ûï';
        el.title = '–î–æ–¥–∞—Ç–∏ —Ü—ñ–ª—å';
        L.DomEvent.on(el, 'click', (ev) => {
          L.DomEvent.stopPropagation(ev);
          L.DomEvent.preventDefault(ev);
          mode = (mode === 'add') ? null : 'add';
          el.classList.toggle('active');
          if (deleteControlEl) deleteControlEl.classList.remove('active');
          clearPreview();
        });
        return el;
      }
    });

    const DeleteControl = L.Control.extend({
      options: { position: 'topleft' },
      onAdd() {
        const el = L.DomUtil.create('div', 'leaflet-control leaflet-control-custom');
        el.innerHTML = 'üóëÔ∏è';
        el.title = '–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—ñ–ª—å';
        L.DomEvent.on(el, 'click', (ev) => {
          L.DomEvent.stopPropagation(ev);
          L.DomEvent.preventDefault(ev);
          mode = (mode === 'delete') ? null : 'delete';
          el.classList.toggle('active');
          if (addControlEl) addControlEl.classList.remove('active');
          clearPreview();
        });
        return el;
      }
    });

    map.addControl(new AddControl());
    map.addControl(new DeleteControl());

    const addControlEl = document.querySelector('.leaflet-control-custom:nth-of-type(1)');
    const deleteControlEl = document.querySelector('.leaflet-control-custom:nth-of-type(2)');

    // === –ö–ª–∏–∫–∏ –ø–æ –∫–∞—Ä—Ç–µ ===
    map.on('click', (e) => {
      if (mode === 'add') {
        if (!firstClickLatLng) {
          firstClickLatLng = e.latlng;
          previewMarker = L.marker(firstClickLatLng, {
            icon: L.divIcon({
              className: 'preview-icon',
              html: `<div style="font-size:18px;">üìç</div>`,
              iconSize: [18,18], iconAnchor: [9,9]
            }),
            interactive: false
          }).addTo(map);
        } else {
          const bearing = bearingDegrees(firstClickLatLng, e.latlng);
          createTarget(firstClickLatLng, bearing);
          clearPreview();
        }
      }
    });

    document.addEventListener('keydown', (ev) => {
      if (ev.key === 'Escape') {
        mode = null;
        addControlEl.classList.remove('active');
        deleteControlEl.classList.remove('active');
        clearPreview();
      }
    });

    // === –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –∏–∫–æ–Ω–∫–∏ ===
    const grid = document.getElementById('iconGrid');
    icons.forEach(ic => {
      const div = document.createElement('div');
      div.className = 'icon-option';
      div.innerHTML = `<img src="${ic.file}" title="${ic.name}">`;
      if (ic.id === selectedIcon) div.classList.add('selected');
      div.addEventListener('click', () => {
        selectedIcon = ic.id;
        localStorage.setItem('selectedIcon', ic.id);
        document.querySelectorAll('.icon-option').forEach(d => d.classList.remove('selected'));
        div.classList.add('selected');
      });
      grid.appendChild(div);
    });

    // === –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –º–µ–Ω—é ===
    const toggleMenu = document.getElementById('toggleMenu');
    const panel = document.getElementById('iconPanel');
    let menuVisible = false;
    toggleMenu.addEventListener('click', () => {
      menuVisible = !menuVisible;
      panel.classList.toggle('hidden', !menuVisible);
    });
  </script>
</body>
</html>