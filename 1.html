<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ú–∞–ø–∞ ‚Äî —Ü—ñ–ª—ñ</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html,body{height:100%;margin:0}
    #map{width:100%;height:100vh}

    .leaflet-left .leaflet-control{margin-left:10px;margin-top:10px}
    .leaflet-control-custom{
      background:white;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,0.3);
      width:32px;height:32px;display:flex;align-items:center;justify-content:center;
      cursor:pointer;font-size:18px;transition:0.15s
    }
    .leaflet-control-custom:hover{background:#f0f0f0}
    .leaflet-control-custom.active{background:#cce5ff}

    /* –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –∏–∫–æ–Ω–æ–∫ */
    #icon-menu {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      padding: 10px;
      display: none;
      z-index: 1000;
    }
    #icon-menu.active { display: block; }
    #icon-menu img {
      width: 40px; height: 40px;
      margin: 5px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.15s;
    }
    #icon-menu img:hover { transform: scale(1.1); }
    #icon-menu img.selected { box-shadow: 0 0 0 3px #007bff; }

    .menu-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      border-radius: 8px;
      width: 36px; height: 36px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      cursor: pointer; font-size: 20px;
      z-index: 1100;
    }
    .menu-toggle:hover { background: #f0f0f0; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é -->
  <div class="menu-toggle">‚öôÔ∏è</div>

  <!-- –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –∏–∫–æ–Ω–∫–∏ -->
  <div id="icon-menu">
    <img src="icons/shahed.png" title="–®–∞—Ö–µ–¥" data-type="shahed">
    <img src="icons/rocket.png" title="–†–∞–∫–µ—Ç–∞" data-type="rocket">
    <img src="icons/plane.png" title="–°–∞–º–æ–ª—ñ—Ç" data-type="plane">
    <img src="icons/kab.png" title="–ö–ê–ë" data-type="kab">
    <img src="icons/recon.png" title="–†–æ–∑–≤—ñ–¥–Ω–∏–∫" data-type="recon">
    <img src="icons/ballistic.png" title="–ë–∞–ª—ñ—Å—Ç–∏—á–Ω–∞ —Ä–∞–∫–µ—Ç–∞" data-type="ballistic">
  </div>

  <script>
    // === –ö–∞—Ä—Ç–∞ ===
    const map = L.map('map').setView([49.0, 31.0], 6);
    window.lightLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '¬© OpenStreetMap',
      crossorigin: true,
      detectRetina: true,
      updateWhenIdle: false,
      keepBuffer: 2
    }).addTo(map);

    // === –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ===
    let mode = null;
    let firstClickLatLng = null;
    let previewMarker = null;
    const targets = [];
    let currentIconPath = 'icons/shahed.png'; // —Å—Ç–∞–Ω–¥–∞—Ä—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

    // === –§—É–Ω–∫—Ü–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è ===
    function bearingDegrees(fromLatLng, toLatLng) {
      const toRad = deg => deg * Math.PI / 180;
      const toDeg = rad => rad * 180 / Math.PI;
      const œÜ1 = toRad(fromLatLng.lat);
      const œÜ2 = toRad(toLatLng.lat);
      const ŒîŒª = toRad(toLatLng.lng - fromLatLng.lng);
      const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
      const x = Math.cos(œÜ1)*Math.sin(œÜ2) - Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);
      return (toDeg(Math.atan2(y, x)) + 360) % 360;
    }

    // === –ö–æ–Ω—Ç—Ä–æ–ª—ã ===
    const AddControl = L.Control.extend({
      options: { position: 'topleft' },
      onAdd() {
        const el = L.DomUtil.create('div', 'leaflet-control leaflet-control-custom');
        el.innerHTML = '‚ûï';
        el.title = '–î–æ–¥–∞—Ç–∏ —Ü—ñ–ª—å';
        L.DomEvent.on(el, 'click', (ev) => {
          L.DomEvent.stopPropagation(ev);
          L.DomEvent.preventDefault(ev);
          mode = (mode === 'add') ? null : 'add';
          el.classList.toggle('active');
          if (deleteControlEl) deleteControlEl.classList.remove('active');
          clearPreview();
        });
        return el;
      }
    });
    const DeleteControl = L.Control.extend({
      options: { position: 'topleft' },
      onAdd() {
        const el = L.DomUtil.create('div', 'leaflet-control leaflet-control-custom');
        el.innerHTML = 'üóëÔ∏è';
        el.title = '–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—ñ–ª—å';
        L.DomEvent.on(el, 'click', (ev) => {
          L.DomEvent.stopPropagation(ev);
          L.DomEvent.preventDefault(ev);
          mode = (mode === 'delete') ? null : 'delete';
          el.classList.toggle('active');
          if (addControlEl) addControlEl.classList.remove('active');
          clearPreview();
        });
        return el;
      }
    });
    map.addControl(new AddControl());
    map.addControl(new DeleteControl());

    const addControlEl = document.querySelector('.leaflet-control-custom:nth-of-type(1)');
    const deleteControlEl = document.querySelector('.leaflet-control-custom:nth-of-type(2)');

    function clearPreview() {
      firstClickLatLng = null;
      if (previewMarker) {
        map.removeLayer(previewMarker);
        previewMarker = null;
      }
    }

    // === –°–æ–∑–¥–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ü–µ–ª—å (–º–∞—Ä–∫–µ—Ä) ===
function createTarget(positionLatLng, bearingDeg) {
  // —Ç–≤–æ–∏ –∏–∫–æ–Ω–∫–∏ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø–æ–≤–µ—Ä–Ω—É—Ç—ã –Ω–∞ 270¬∞ (–≤–ª–µ–≤–æ)
  // –ø–æ—ç—Ç–æ–º—É –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —É–≥–æ–ª –ø–æ–≤–æ—Ä–æ—Ç–∞
  const adjustedBearing = bearingDeg - 90; // —Ñ–∏–∫—Å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è

  // –ø–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∏–ø –∏–∫–æ–Ω–∫–∏ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
  const iconType = localStorage.getItem('selectedIcon') || 'shahed';
  const iconUrl = `icons/${iconType}.png`;

  const icon = L.divIcon({
    className: 'target-icon',
    html: `<img src="${iconUrl}" style="width:24px;height:24px;transform: rotate(${adjustedBearing}deg);transform-origin:center;">`,
    iconSize: [24, 24],
    iconAnchor: [12, 12]
  });

  const marker = L.marker(positionLatLng, { icon, interactive: true }).addTo(map);

  // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (–µ—Å–ª–∏ —Ä–µ–∂–∏–º delete)
  marker.on('click', (e) => {
    if (mode === 'delete') {
      map.removeLayer(marker);
      const idx = targets.indexOf(marker);
      if (idx !== -1) targets.splice(idx, 1);
    }
  });

  targets.push(marker);
}

    // === –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–ª–µ–π ===
    map.on('click', (e) => {
      if (mode === 'add') {
        if (!firstClickLatLng) {
          firstClickLatLng = e.latlng;
          previewMarker = L.marker(firstClickLatLng, {
            icon: L.divIcon({
              html: `<div style="font-size:18px;">üìç</div>`,
              iconSize: [18,18], iconAnchor: [9,9]
            }),
            interactive: false
          }).addTo(map);
        } else {
          const second = e.latlng;
          const bearing = bearingDegrees(firstClickLatLng, second);
          createTarget(firstClickLatLng, bearing);
          clearPreview();
        }
      }
    });

    // === Esc ‚Äî —Å–±—Ä–æ—Å ===
    document.addEventListener('keydown', (ev) => {
      if (ev.key === 'Escape') {
        mode = null;
        if (addControlEl) addControlEl.classList.remove('active');
        if (deleteControlEl) deleteControlEl.classList.remove('active');
        clearPreview();
      }
    });

    // === –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –∏–∫–æ–Ω–∫–∏ ===
    const menuToggle = document.querySelector('.menu-toggle');
    const iconMenu = document.getElementById('icon-menu');
    const iconImgs = iconMenu.querySelectorAll('img');

    menuToggle.addEventListener('click', () => {
      iconMenu.classList.toggle('active');
    });

    iconImgs.forEach(img => {
      img.addEventListener('click', () => {
        iconImgs.forEach(i => i.classList.remove('selected'));
        img.classList.add('selected');
        currentIconPath = img.getAttribute('src');
        iconMenu.classList.remove('active'); // —Å–∫—Ä—ã—Ç—å –º–µ–Ω—é –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞
      });
    });

    // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é –∏–∫–æ–Ω–∫—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    iconImgs[0].classList.add('selected');
  </script>
</body>
</html>